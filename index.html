import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  deleteDoc,
  doc,
  updateDoc,
  setDoc,
  getDoc,
  serverTimestamp,
  writeBatch
} from 'firebase/firestore';
import {
  Plus,
  Trash2,
  Calendar,
  CheckCircle2,
  Circle,
  ArrowUpDown,
  X,
  ChevronLeft,
  AlertTriangle,
  Download,
  Upload,
  Database,
  Camera,
  User,
  Edit3,
  Save,
  Palette,
  Clock,
  ExternalLink,
  AlarmClock
} from 'lucide-react';
 
// --- Firebase 初始化 ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
 
// --- 自定義 SVG 手繪風格圖標 (祁煜主題) ---
 
// 🖌️ 畫筆 (Brush)
const BrushIcon = ({ size = 12, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
    <path d="M2 22L13 11" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/> 
    <path d="M13 11L15.5 8.5C16 8 16.5 7.5 17.5 7.5C18.5 7.5 19 8 19.5 8.5C20 9 20.5 9.5 20.5 10.5C20.5 11.5 20 12 19.5 12.5L17 15L13 11Z" fill="currentColor" fillOpacity="0.2" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/>
    <path d="M19.5 8.5L21 7" stroke="currentColor" strokeWidth="1" strokeLinecap="round"/>
  </svg>
);
 
// 🐠 小魚 (Fish) - 前三個稱號
const FishIcon = ({ size = 12, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
    <path d="M7 12 C 7 7.5 10.5 4 15 4 C 19.5 4 23 7.5 23 12 C 23 16.5 19.5 20 15 20 C 10.5 20 7 16.5 7 12 Z" fill="currentColor" fillOpacity="0.2" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/>
    <path d="M7 12 L 2 8 V 16 L 7 12" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
    <circle cx="17" cy="10" r="1.5" fill="currentColor" />
  </svg>
);
 
// 🦪 扇貝 (Scallop) - 圓滑版：中間圓潤高聳，兩側低
const ScallopIcon = ({ size = 12, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
    {/* 扇形主體 */}
    <path d="M3 13 C 4 10.5 5.5 10 7 10 C 9 5.5 15 5.5 17 10 C 18.5 10 20 10.5 21 13 C 21 18.5 16.5 22 12 22 C 7.5 22 3 18.5 3 13 Z" fill="currentColor" fillOpacity="0.1" stroke="none" />
    
    {/* 外輪廓線條 */}
    <path d="M3 13 C 4 10.5 5.5 10 7 10 C 9 5.5 15 5.5 17 10 C 18.5 10 20 10.5 21 13 C 21 18.5 16.5 22 12 22 C 7.5 22 3 18.5 3 13" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
    
    {/* 底部連接處 */}
    <path d="M9 20C10 21.5 14 21.5 15 20" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
    {/* 扇形紋理 */}
    <path d="M12 18V6.5" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeDasharray="1 3"/>
    <path d="M9 17C8.5 15 8.5 10 9.5 8" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
    <path d="M15 17C15.5 15 15.5 10 14.5 8" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
    <path d="M6 14C6 12 6.5 10.5 7.5 9.5" stroke="currentColor" strokeWidth="1" strokeLinecap="round" opacity="0.6"/>
    <path d="M18 14C18 12 17.5 10.5 16.5 9.5" stroke="currentColor" strokeWidth="1" strokeLinecap="round" opacity="0.6"/>
  </svg>
);
 
// 👑 皇冠 (Crown) - 高級、神秘、細緻
const CrownIcon = ({ size = 12, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
    {/* 主體架構 */}
    <path d="M12 2L14.5 9L21 10L16 14L17.5 21L12 17L6.5 21L8 14L3 10L9.5 9L12 2Z" fill="currentColor" fillOpacity="0.1" stroke="none"/>
    <path d="M4 12L2 10L8 8L12 2L16 8L22 10L20 12" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M12 17L7 20L8 14" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M12 17L17 20L16 14" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
    
    {/* 中間的寶石/神聖核心 */}
    <path d="M12 12L12 17" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
    <circle cx="12" cy="10" r="1.5" fill="currentColor" className="animate-pulse"/>
    
    {/* 懸浮的星光 */}
    <path d="M12 2L12 4M11 3L13 3" stroke="currentColor" strokeWidth="1" opacity="0.8"/>
    <path d="M22 10L20 10" stroke="currentColor" strokeWidth="1" opacity="0.6"/>
    <path d="M2 10L4 10" stroke="currentColor" strokeWidth="1" opacity="0.6"/>
  </svg>
);
 
// 🍰 草莓蛋糕 (Cake) - 取代原本的貝殼，用於能量/貨幣
const ShellIcon = ({ size = 12, className = "" }) => (
  <span style={{ fontSize: size, display: 'inline-block', lineHeight: '1em' }} className={className} role="img" aria-label="cake">
    🍰
  </span>
);
 
// 🐚 珊瑚 (Coral)
const CoralIcon = ({ size = 12, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
    <path d="M12 20V10M12 10L8 6M12 10L16 6M8 14L5 11M16 14L19 11" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
    <circle cx="12" cy="20" r="2" fill="currentColor" fillOpacity="0.4" stroke="currentColor" strokeWidth="1.5"/>
  </svg>
);
 
// --- 常量定義 ---
const TITLES = [
  '魚魚的小海螺',
  '魚魚的小海星',
  '魚魚的小保鑣',
  '祁煜的信徒',
  '祁煜的契約者',
  '祁煜的公主殿下',
  '主聖的女王陛下',
  '海神的小城主',
  '海神的新娘'
];
 
// --- 任務分類 ---
const ZONES = [
  { id: 'studio', label: 'Mo Art Studio', emoji: '🎨', color: 'bg-[#2e1065] text-purple-100 border-purple-800 ring-purple-800' },
  { id: 'urgent', label: '截稿地獄', emoji: '🔥', color: 'bg-[#450a0a] text-red-100 border-red-900 ring-red-800 shadow-[0_0_15px_rgba(220,38,38,0.4)]' },
  { id: 'hunter', label: '獵人協會', emoji: '⚔️', color: 'bg-[#1c1917] text-stone-300 border-stone-700 ring-stone-700' },
  // 修改：白沙灣 -> 安蒙碎念
  { id: 'whitesand', label: '安蒙碎念', emoji: '🧔🏼', color: 'bg-[#0c4a6e] text-sky-200 border-sky-800 ring-sky-800' },
  { id: 'evol', label: 'Evol 特訓', emoji: '✨', color: 'bg-[#1e1b4b] text-indigo-200 border-indigo-900 ring-indigo-900' }, 
  { id: 'seafood', label: '海鮮採購', emoji: '🦀', color: 'bg-[#7f1d1d] text-red-200 border-red-900 ring-red-900' },
  { id: 'finance', label: '畫廊營收', emoji: '💎', color: 'bg-[#422006] text-amber-200 border-amber-900 ring-amber-900' },
  { id: 'lemuria', label: '利莫里亞', emoji: '🏛️', color: 'bg-[#134e4a] text-teal-100 border-teal-900 ring-teal-900' },
];
 
// --- 報酬評估 (蛋糕) ---
const SHELL_LEVELS = [
  { value: 1, label: '隨手塗鴉', iconCount: 1 },
  { value: 2, label: '有點靈感了！', iconCount: 2 },
  { value: 3, label: '畫筆很順手～', iconCount: 3 },
  { value: 4, label: '堪稱完美！', iconCount: 4 },
  { value: 5, label: '可以開畫展了！', iconCount: 5 },
];
 
export default function App() {
  const [user, setUser] = useState(null);
  const [tasks, setTasks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [dataLoaded, setDataLoaded] = useState(false); // 新增：資料載入狀態
  const [avatar, setAvatar] = useState(null);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalStep, setModalStep] = useState(1);
  const [isCollectionOpen, setIsCollectionOpen] = useState(false);
  const [sortBy, setSortBy] = useState('deadline');
  const [isCelebrationOpen, setIsCelebrationOpen] = useState(false);
  
  const [taskToDelete, setTaskToDelete] = useState(null);
  const [isDeleting, setIsDeleting] = useState(false);
  
  const [burstingTaskId, setBurstingTaskId] = useState(null); 
  const prevTitleIndexRef = useRef(-1);
 
  const [editingTask, setEditingTask] = useState(null);
  const [editName, setEditName] = useState('');
  const [editDate, setEditDate] = useState('');
  // 新增：暫存時間狀態 (預設 10:00)
  const [editTime, setEditTime] = useState('10:00');
 
  const [isCropModalOpen, setIsCropModalOpen] = useState(false);
  const [rawImage, setRawImage] = useState(null);
  const fileInputRef = useRef(null);
  const fileImportRef = useRef(null);
  
  const [canCloseCelebration, setCanCloseCelebration] = useState(false);
 
  const [taskName, setTaskName] = useState('');
  const [selectedZone, setSelectedZone] = useState(null);
  const [selectedShell, setSelectedShell] = useState(null); 
  const [deadline, setDeadline] = useState('');
 
  const completedTasks = useMemo(() => tasks.filter(t => t.completed), [tasks]);
  const incompleteTasks = useMemo(() => tasks.filter(t => !t.completed), [tasks]);
 
  const totalShellsConsumed = useMemo(() => 
    completedTasks.reduce((sum, t) => sum + (Number(t.shells) || Number(t.paints) || 0), 0)
  , [completedTasks]);
 
  const titleIndex = Math.min(Math.floor(totalShellsConsumed / 100), TITLES.length - 1);
  const currentTitle = TITLES[titleIndex];
 
  // --- Auth Setup ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth Fail:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (curr) => {
      setUser(curr);
      if (curr) setLoading(false);
    });
    return () => unsubscribe();
  }, []);
 
  // --- Data Syncing ---
  useEffect(() => {
    if (!user) return;
    const loadProfile = async () => {
      try {
        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile_rafayel_v1', 'info');
        const pDoc = await getDoc(profileRef);
        if (pDoc.exists()) {
          setAvatar(pDoc.data().avatar);
        }
      } catch (e) { console.error("Profile load err:", e); }
    };
    loadProfile();
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1');
    const unsub = onSnapshot(q, (snap) => {
      setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      setDataLoaded(true); // 標記資料已載入
    });
    return () => unsub();
  }, [user]);
 
  // --- Celebration Logic ---
  useEffect(() => {
    if (loading || !dataLoaded) return; // 確保資料載入後才開始判斷
    if (prevTitleIndexRef.current === -1) {
      prevTitleIndexRef.current = titleIndex;
      return;
    }
    if (titleIndex > prevTitleIndexRef.current) {
      setIsCelebrationOpen(true);
      prevTitleIndexRef.current = titleIndex; 
    } else if (titleIndex < prevTitleIndexRef.current) {
        prevTitleIndexRef.current = titleIndex;
    }
  }, [titleIndex, loading, dataLoaded]); // 加入 dataLoaded 依賴
 
  useEffect(() => {
    if (isCelebrationOpen) {
      setCanCloseCelebration(false);
      const timer = setTimeout(() => {
        setCanCloseCelebration(true);
      }, 1500);
      return () => clearTimeout(timer);
    }
  }, [isCelebrationOpen]);
 
  // --- Handlers ---
  const handleAvatarClick = () => { 
    if (fileInputRef.current) { 
      fileInputRef.current.value = ''; 
      fileInputRef.current.click(); 
    } 
  };
 
  const onFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => { 
      setRawImage(reader.result); 
      setIsCropModalOpen(true); 
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  };
 
  // 修復：大頭照上傳邏輯重寫，使用 Image 物件確保載入
  const handleCropSave = async () => {
    if (!rawImage || !user) return;
 
    try {
      const img = new Image();
      img.src = rawImage;
      await new Promise(r => img.onload = r); // 等待圖片完全載入
 
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const size = 300; 
      canvas.width = size;
      canvas.height = size;
      
      const minDim = Math.min(img.width, img.height);
      const sx = (img.width - minDim) / 2;
      const sy = (img.height - minDim) / 2;
      
      ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
      const b64 = canvas.toDataURL('image/jpeg', 0.85);
      
      // 立即更新本地顯示
      setAvatar(b64);
      setIsCropModalOpen(false);
      setRawImage(null); 
      
      // 背景更新 Firestore
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile_rafayel_v1', 'info'), { 
        avatar: b64, 
        updatedAt: serverTimestamp() 
      });
    } catch(e) { 
      console.error("Upload failed:", e); 
    }
  };
 
  const handleImportCSV = (e) => {
    const file = e.target.files[0];
    if (!file || !user) return;
    const reader = new FileReader();
    reader.onload = async (event) => {
      const text = event.target.result;
      const lines = text.split('\n');
      const batch = writeBatch(db);
      let count = 0;
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const [name, zoneLabel, shellsStr, deadline] = line.split(',');
        if (!name) continue;
        const zone = ZONES.find(z => zoneLabel && z.label.includes(zoneLabel.trim()))?.id || 'studio';
        const shells = Number(shellsStr) || 1;
        const newDocRef = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1'));
        batch.set(newDocRef, { name: name.trim(), zone, shells, paints: shells, deadline: deadline || '', completed: true, createdAt: serverTimestamp(), archivedFromImport: true });
        count++;
      }
      if (count > 0) { try { await batch.commit(); } catch (err) { console.error("Import failed:", err); } }
    };
    reader.readAsText(file);
    e.target.value = null; 
  };
 
  const resetForm = () => {
    setTaskName(''); setDeadline(''); setSelectedZone(null); setSelectedShell(null);
    setModalStep(1); setIsModalOpen(false);
  };
 
  const toLocalYYYYMMDD = (d) => {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };
 
  const handleAddTask = async () => {
    if (!user || !taskName.trim() || !selectedZone || !selectedShell || !deadline) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1'), {
        name: taskName, 
        zone: selectedZone, 
        shells: Number(selectedShell),
        paints: Number(selectedShell),
        deadline, 
        completed: false, 
        createdAt: serverTimestamp()
      });
      resetForm();
    } catch (e) { console.error("Add Err:", e); }
  };
 
  const handleToggleComplete = async (t) => {
    if (!user || burstingTaskId) return;
    setBurstingTaskId(t.id);
    setTimeout(async () => {
      await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1', t.id), { completed: !t.completed });
      setBurstingTaskId(null);
    }, 600);
  };
 
  // 修復：刪除邏輯增強，加入 Loading 狀態
  const confirmDelete = async () => {
    if (!user || !taskToDelete || isDeleting) return;
    setIsDeleting(true);
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1', taskToDelete.id));
      setTaskToDelete(null);
      setEditingTask(null); 
    } catch (e) { 
      console.error("Delete failed:", e); 
    } finally {
      setIsDeleting(false);
    }
  };
 
  const setDateShortcut = (type) => {
    const d = new Date();
    if (type === 'tomorrow') d.setDate(d.getDate() + 1);
    setDeadline(toLocalYYYYMMDD(d));
  };
 
  // 修改：更加穩健的日期格式化，避免時區問題導致日期錯誤
  const formatDate = (ds) => { 
    if(!ds) return ''; 
    const [y, m, d] = ds.split('-'); // 直接拆解字串，不透過 new Date() 解析，避免時區偏移
    return `${Number(m)}/${Number(d)}`; 
  };
  
  const getZoneInfo = (id) => ZONES.find(o => o.id === id) || ZONES[0];
  
  const exportCSV = () => {
    if (completedTasks.length === 0) return;
    // 修改標題：貝殼數 -> 蛋糕數
    const csv = "\uFEFF任務名稱,區域,蛋糕數,日期\n" + completedTasks.map(t => `${t.name},${getZoneInfo(t.zone).label.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '')},${t.shells || t.paints},${t.deadline}`).join("\n");
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = `Mo_Art_Studio_Log.csv`; a.click();
  };
 
  const openEditModal = (t) => { 
    setEditingTask(t); 
    setEditName(t.name); 
    setEditDate(t.deadline); 
    setEditTime('10:00'); // 預設 10:00
  };
  
  const handleSaveEdit = async () => {
    if (!user || !editingTask || !editName.trim()) return;
    const updateData = { name: editName };
    if(editDate) updateData.deadline = editDate;
    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1', editingTask.id), updateData);
    setEditingTask(null);
  };
 
  // --- 新增：添加到 Google 日曆功能 (支援時間) ---
  const addToGoogleCalendar = () => {
    if (!editName || !editDate) return;
    
    const timeToUse = editTime || "09:00"; 
    
    // 建立本地 Date 物件
    const startDateTime = new Date(`${editDate}T${timeToUse}:00`);
    const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // 預設 1 小時
 
    // 格式化為 UTC 字串 (YYYYMMDDTHHMMSSZ)
    const formatTime = (date) => date.toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';
 
    const startStr = formatTime(startDateTime);
    const endStr = formatTime(endDateTime);
 
    const details = encodeURIComponent("來自 Mo Art Studio 的委託");
    const text = encodeURIComponent(editName); // 中文標題
    
    // 生成 URL (dates 格式: start/end)
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&details=${details}`;
    
    window.open(url, '_blank');
  };
 
  // --- Title Icon Logic ---
  const getTitleIcon = (idx) => {
    if (idx >= 0 && idx <= 2) return <FishIcon size={16} className="text-purple-400 animate-bounce" />;
    if (idx >= 3 && idx <= 5) return <ScallopIcon size={16} className="text-pink-300 animate-pulse drop-shadow-[0_0_8px_rgba(244,114,182,0.6)]" />; 
    if (idx >= 6 && idx <= 8) return <CrownIcon size={16} className="text-yellow-200 animate-pulse drop-shadow-[0_0_8px_rgba(253,224,71,0.8)]" />;
    return <ShellIcon size={12} className="text-purple-200 animate-spin-slow" />;
  };
 
  const getModalTitles = (step) => {
    switch(step) {
      case 1: return { main: '輸入靈感', sub: 'INSPIRATION' };
      case 2: return { main: '選擇場景', sub: 'SCENARIO' };
      // 修改：貝殼評估 -> 蛋糕評估
      case 3: return { main: '蛋糕評估', sub: 'ESTIMATION' };
      case 4: return { main: '確認委託', sub: 'CONFIRMATION' }; 
      default: return { main: '', sub: '' };
    }
  };
 
  return (
    <div className="min-h-screen bg-gradient-to-br from-[#240078] to-[#C4529E] font-sans text-slate-200 pb-24 max-w-md mx-auto relative shadow-2xl overflow-hidden select-none">
      
      <style>{`
        @keyframes bubble-rise { 
          0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 
          50% { opacity: 0.8; } 
          100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } 
        }
        @keyframes ember-float { 
          0% { transform: translateY(0) translateX(0) scale(1); opacity: 1; filter: hue-rotate(0deg); } 
          100% { transform: translateY(-100px) translateX(20px) scale(0); opacity: 0; filter: hue-rotate(90deg); } 
        }
        @keyframes smooth-reveal {
          0% { transform: scale(0.9) translateY(10px); opacity: 0; filter: blur(4px); }
          100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
        }
        @keyframes glow-pulse {
          0%, 100% { box-shadow: 0 0 20px rgba(168,85,247,0.2), inset 0 0 10px rgba(168,85,247,0.1); border-color: rgba(192, 132, 252, 0.4); }
          50% { box-shadow: 0 0 40px rgba(168,85,247,0.4), inset 0 0 20px rgba(168,85,247,0.2); border-color: rgba(192, 132, 252, 0.8); }
        }
        .bubble-bg { position: absolute; bottom: -20px; color: #a78bfa; opacity: 0.3; pointer-events: none; z-index: 0; animation: bubble-rise linear infinite; }
        .celebration-ember { position: absolute; color: #f472b6; pointer-events: none; z-index: 260; animation: ember-float linear infinite; }
        .celebration-bubble { position: absolute; color: #60a5fa; pointer-events: none; z-index: 260; animation: bubble-rise linear infinite; }
        @keyframes fire-burst { 0% { transform: scale(1); filter: brightness(1); opacity: 1; } 50% { filter: brightness(1.5) drop-shadow(0 0 15px #f43f5e); } 100% { transform: scale(1.3); filter: blur(4px) opacity(0); opacity: 0; } }
        .burst-effect { animation: fire-burst 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards; pointer-events: none; border-color: #f43f5e !important; background: rgba(244, 63, 94, 0.2) !important; }
        input, textarea, button { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif !important; }
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      `}</style>
 
      {/* 浮水印 */}
      <div className="absolute top-2 left-3 text-[10px] text-white/20 font-sans tracking-widest pointer-events-none z-50">@yui_raf_0306</div>
 
      {/* 常駐特效 */}
      {[...Array(15)].map((_, i) => (
        <div key={`b-${i}`} className="bubble-bg" style={{ left: `${Math.random()*100}%`, animationDuration: `${Math.random()*10+8}s`, animationDelay: `${Math.random()*5}s` }}>
          <div className="rounded-full border border-purple-400/30 bg-purple-500/10" style={{width: Math.random()*20+5, height: Math.random()*20+5}}></div>
        </div>
      ))}
      {[...Array(10)].map((_, i) => <div key={`e-${i}`} className="celebration-ember" style={{ left: `${Math.random()*100}%`, top: `${Math.random()*100}%`, animationDuration: `${Math.random()*3+4}s`, animationDelay: `${Math.random()*5}s`, width: 4, height: 4, borderRadius: '50%', background: '#fb7185' }} />)}
 
      <input type="file" ref={fileInputRef} onChange={onFileChange} accept="image/*" className="hidden" />
 
      {/* 頁首 */}
      <header className="px-6 pt-14 pb-8 flex justify-between items-center z-10 relative">
        <div className="flex flex-col gap-6 flex-1 min-w-0 pr-4 text-left">
          <div className="flex flex-col">
            <h1 className="text-[1.2rem] font-black flex items-center gap-2 tracking-tight whitespace-nowrap text-purple-50">
              <span className="text-purple-400 filter drop-shadow-[0_0_8px_rgba(192,132,252,0.6)]">
                <Palette size={24} />
              </span> 
              Mo Art Studio
              <div className="w-1.5 h-1.5 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444] animate-pulse"></div>
            </h1>
            <p className="text-[0.95rem] text-slate-300 mt-1 font-bold leading-relaxed tracking-wide text-shadow-sm">
              保鑣小姐，<br />今天要去哪裡取材？
            </p>
          </div>
          <button onClick={() => { if(!deadline) setDateShortcut('tomorrow'); setIsModalOpen(true); }} className="relative bg-gradient-to-r from-[#2e1065]/90 to-[#4c0519]/90 backdrop-blur-md p-4 px-5 rounded-xl border border-purple-500/20 flex items-center justify-between active:scale-95 transition-all shadow-[0_4px_20px_rgba(88,28,135,0.4)] w-full max-w-[200px] overflow-hidden group hover:border-purple-500/40">
            <div className="relative z-10 flex items-center gap-3">
              <div className="w-8 h-8 rounded bg-purple-900 flex items-center justify-center text-purple-100 border border-purple-400/30 shrink-0 shadow-[0_0_15px_rgba(168,85,247,0.4)]"><Plus size={18} strokeWidth={3} /></div>
              <span className="text-purple-50 font-black text-[1rem] tracking-tight whitespace-nowrap uppercase drop-shadow-md group-hover:text-white transition-colors">新增靈感</span>
            </div>
            <div className="relative z-10 text-purple-300 transform group-hover:-translate-y-1 transition-transform duration-500">
                <ShellIcon size={24} />
            </div>
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-purple-500/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></div>
          </button>
        </div>
        
        <div className="flex flex-col items-center gap-3 shrink-0 relative">
          <div className="relative group" onClick={handleAvatarClick}>
            <div className="absolute -inset-1.5 bg-gradient-to-tr from-red-600 via-purple-600 to-blue-900 rounded-full opacity-60 blur-sm group-hover:opacity-100 transition-opacity duration-500 animate-pulse"></div>
            <div className="relative w-32 h-32 rounded-full border-[3px] border-purple-400/30 overflow-hidden bg-black shadow-2xl flex items-center justify-center cursor-pointer active:scale-95 transition-all">
              {avatar ? <img src={avatar} className="w-full h-full object-cover filter brightness-95 contrast-110" /> : <div className="text-center opacity-40 text-purple-500"><User size={48}/><div className="text-[10px] font-black mt-1 uppercase font-sans tracking-widest">ARTIST</div></div>}
              <div className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity backdrop-blur-[2px]"><Camera size={24} className="text-purple-500"/></div>
            </div>
          </div>
          <div className="flex flex-col items-center gap-2">
            <div className="relative px-3 py-1 bg-black/40 backdrop-blur-md rounded border border-purple-500/30 shadow-lg flex items-center gap-1.5">
              {getTitleIcon(titleIndex)}
              <span className="bg-clip-text text-transparent bg-gradient-to-r from-purple-200 via-pink-200 to-white font-black text-xs whitespace-nowrap tracking-wide">{currentTitle}</span>
            </div>
            {/* 修改：貝殼 -> 蛋糕 */}
            <div className="text-[10px] text-purple-300/90 font-black tracking-[0.2em] uppercase bg-purple-950/30 px-2.5 py-0.5 rounded border border-purple-500/30 shadow-sm flex items-center gap-1"><ShellIcon size={10} /> 蛋糕 {totalShellsConsumed}</div>
          </div>
        </div>
      </header>
 
      <div className="px-8 mb-5 flex items-center justify-between z-10 relative opacity-70 text-[10px] font-black tracking-[0.3em] uppercase text-white">
        <span>Canvas Tasks</span>
        {/* 修改：貝殼 -> 蛋糕 */}
        <button onClick={() => setSortBy(s => s === 'deadline' ? 'shell' : 'deadline')} className="flex items-center gap-1.5 font-bold bg-white/10 px-3 py-1 rounded hover:bg-white/20 transition-colors text-white"><ArrowUpDown size={10}/> {sortBy === 'deadline' ? '期限' : '蛋糕'}</button>
      </div>
 
      <main className="px-4 space-y-4 pb-24 z-10 relative font-sans">
        {incompleteTasks.length === 0 ? <div className="text-center py-24 opacity-30 text-purple-300 flex flex-col items-center justify-center gap-4"><ShellIcon size={60} strokeWidth={1} /><span className="text-xs tracking-widest uppercase font-bold">No Inspiration Found</span></div> :
          incompleteTasks.sort((a,b) => sortBy === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : (a.shells||a.paints) - (b.shells||b.paints)).map(t => {
            const zone = getZoneInfo(t.zone);
            const isBursting = burstingTaskId === t.id;
            
            // 修正：使用純文字比較，避免 new Date() 的時區問題造成判定錯誤（今天被判為過期）
            const isOverdue = t.deadline && t.deadline < toLocalYYYYMMDD(new Date());
 
            return (
              <div 
                key={t.id} 
                onClick={() => openEditModal(t)} 
                className={`relative bg-gradient-to-br from-[#2e1065]/90 to-[#020617]/90 backdrop-blur-md p-6 rounded-2xl border transition-all cursor-pointer shadow-lg group active:scale-[0.98] overflow-hidden font-sans border-purple-500/10 hover:border-purple-500/30 hover:shadow-[0_0_20px_rgba(168,85,247,0.2)] ${isBursting ? 'burst-effect' : ''}`}
              >
                <div className={`absolute left-0 top-0 bottom-0 w-1 ${zone.color.split(' ')[0]} shadow-[0_0_10px_currentColor]`}></div>
                <div className="flex items-start gap-4 pl-3 text-left">
                  <div 
                    className="mt-1.5 shrink-0 transition-colors relative z-10 text-slate-500 group-hover:text-red-400" 
                    onClick={(e) => { 
                          e.stopPropagation(); 
                          handleToggleComplete(t); 
                    }}
                  >
                    <Circle size={22} strokeWidth={2.5}/>
                  </div>
                  <div className="flex-1 min-w-0 relative z-10">
                    <div className="flex gap-2 mb-2 flex-wrap items-center">
                      <span className={`text-[10px] pl-2 pr-3 py-0.5 rounded font-black shadow-sm ${zone.color} uppercase tracking-wider border border-white/5 flex items-center gap-1.5`}>{zone.emoji} {zone.label}</span>
                      <span className="text-[10px] text-slate-400 font-bold flex items-center gap-1"><ShellIcon size={10} className="text-purple-400"/> {t.shells || t.paints}</span>
                    </div>
                    <h3 className="text-lg font-bold truncate tracking-tight font-sans transition-colors text-slate-100 group-hover:text-white">{t.name}</h3>
                    <div className="flex items-center gap-1.5 mt-2 text-slate-500 text-[10px] font-bold tracking-wider font-sans uppercase">
                      <Calendar size={10}/>
                      <span className={isOverdue ? 'text-red-400 animate-pulse' : ''}>{formatDate(t.deadline)} {isOverdue ? 'OVERDUE' : 'DEADLINE'}</span>
                    </div>
                  </div>
                  <div className="p-2 text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity relative z-10"><Edit3 size={16}/></div>
                </div>
                <div className="absolute right-0 bottom-0 p-2 opacity-5 pointer-events-none text-purple-500 rotate-12"><CoralIcon size={100} /></div>
              </div>
            )
          })
        }
      </main>
 
      {/* Archive Button */}
      <div className="fixed bottom-8 right-8 z-30 font-sans">
        <button onClick={() => setIsCollectionOpen(true)} className="bg-gradient-to-br from-purple-900 to-black p-5 rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.8)] border border-purple-500/30 flex items-center gap-3 active:scale-90 transition-all group overflow-hidden relative">
          <div className="absolute inset-0 bg-purple-600 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
          <span className="text-2xl relative z-10 drop-shadow-md text-purple-200"><ShellIcon size={24} /></span>
          <div className="flex flex-col text-left pr-2 leading-none font-sans relative z-10">
            <span className="text-[9px] font-black text-purple-300 uppercase tracking-widest mb-1">Gallery</span>
            <span className="text-base font-black text-white group-hover:text-purple-50 transition-colors">畫作收藏</span>
          </div>
        </button>
      </div>
 
      {editingTask && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 font-sans">
          <div className="absolute inset-0" onClick={() => setEditingTask(null)}></div>
          <div className="relative w-full max-w-sm bg-[#1e1b4b] border border-purple-800 rounded-2xl p-8 shadow-2xl animate-in zoom-in-95 duration-200">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-lg font-black text-white flex items-center gap-2 uppercase tracking-wider"><Edit3 size={18} className="text-purple-500"/> 修改靈感</h3>
              <button onClick={() => setEditingTask(null)} className="p-2 bg-white/5 rounded text-slate-400 hover:text-white"><X size={20}/></button>
            </div>
            
            <div className="bg-black/50 rounded-xl p-4 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors">
              <label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-2 block">內容</label>
              <textarea value={editName} onChange={(e) => setEditName(e.target.value)} rows={3} className="w-full bg-transparent text-lg font-bold text-white placeholder-slate-700 outline-none resize-none leading-relaxed"/>
            </div>
 
            {/* 修改：日期與時間整合區塊 */}
            <div className="bg-black/50 rounded-xl p-4 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors flex flex-col gap-3">
               <div className="flex items-start gap-3">
                 <div className="text-purple-500 mt-1"><Clock size={18}/></div>
                 <div className="flex-1 w-full space-y-3">
                   {/* 日期選擇 */}
                   <div className="flex-1">
                     <label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">完成日期 (Date)</label>
                     <input 
                       type="date" 
                       value={editDate} 
                       onChange={(e) => setEditDate(e.target.value)}
                       className="w-full bg-transparent text-white font-bold outline-none [color-scheme:dark]"
                     />
                   </div>
                   {/* 新增：細節時間調整 */}
                   <div className="border-t border-white/10 pt-2 w-full">
                     <label className="text-[10px] text-purple-400 font-bold uppercase tracking-wider block mb-1 flex items-center gap-1">
                        <AlarmClock size={10} /> 鬧鈴時間 (Alarm)
                     </label>
                     <input
                        type="time"
                        value={editTime}
                        onChange={(e) => setEditTime(e.target.value)}
                        className="w-full bg-transparent text-white font-bold outline-none [color-scheme:dark]"
                     />
                   </div>
                 </div>
               </div>
            </div>
 
            {/* Google 日曆同步按鈕 */}
            <button 
              type="button" 
              onClick={addToGoogleCalendar}
              className="w-full p-3 mb-6 bg-[#4285F4]/20 border border-[#4285F4]/40 hover:bg-[#4285F4]/30 text-[#8ab4f8] rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 uppercase text-xs tracking-wider"
            >
              <Calendar size={14} /> 加入 Google 日曆提醒 <ExternalLink size={12} />
            </button>
 
            <div className="flex gap-4">
              <button type="button" onClick={() => setTaskToDelete(editingTask)} className="p-4 bg-red-950/20 text-red-400 rounded-xl font-bold active:scale-95 flex-1 flex justify-center hover:bg-red-950/40 border border-transparent hover:border-red-900/50 transition-all cursor-pointer z-10">
                <Trash2 size={24}/>
              </button>
              <button type="button" onClick={handleSaveEdit} className="flex-[3] py-4 bg-purple-700 hover:bg-purple-600 text-white rounded-xl font-black text-lg shadow-[0_0_15px_rgba(168,85,247,0.4)] active:scale-95 flex items-center justify-center gap-2 transition-all">
                <Save size={20}/> 保存修改
              </button>
            </div>
          </div>
        </div>
      )}
 
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-sm p-0 overflow-hidden font-sans">
          <div className="absolute inset-0" onClick={resetForm}></div>
          <div className="relative w-full bg-[#0f0a20] border-t border-purple-900/40 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(147,51,234,0.1)] animate-in slide-in-from-bottom-20 duration-500 flex flex-col max-h-[90vh]">
            <div className="flex items-center justify-between px-8 pt-8 pb-4">
              <div className="flex items-center gap-3">
                {modalStep > 1 && <button onClick={() => setModalStep(s => s - 1)} className="p-2 bg-white/5 rounded-full hover:bg-white/10"><ChevronLeft size={24}/></button>}
                <div className="flex flex-col text-left">
                  <h2 className="text-xl font-black tracking-widest text-purple-50 leading-none">{getModalTitles(modalStep).main}</h2>
                  <span className="text-[10px] text-purple-500 font-bold tracking-[0.2em] font-sans mt-1">{getModalTitles(modalStep).sub}</span>
                </div>
              </div>
              <button onClick={resetForm} className="p-2 text-slate-500 hover:text-white transition-colors font-sans text-xl">✕</button>
            </div>
            <div className="flex-1 overflow-y-auto px-8 pb-16 pt-2 font-sans text-left scrollbar-hide">
              {modalStep === 1 && (
                <div className="space-y-6 animate-in fade-in slide-in-from-right-10 duration-300 font-sans">
                  <div className="relative">
                    <textarea rows={4} placeholder="這次的靈感是什麼？快點記下來！" value={taskName} onChange={(e)=>setTaskName(e.target.value)} className="w-full p-6 bg-slate-900/50 border border-slate-800 rounded-xl focus:border-purple-500 focus:outline-none text-xl text-white placeholder:text-slate-600 resize-none font-bold shadow-inner font-sans tracking-wide" autoFocus />
                    <div className="absolute right-4 bottom-4 text-purple-500/20"><BrushIcon size={20}/></div>
                  </div>
                  <button onClick={() => taskName.trim() ? setModalStep(2) : null} className="w-full py-5 bg-slate-100 text-black rounded-xl font-black text-xl shadow-xl active:scale-95 transition-all font-sans flex items-center justify-center gap-2 hover:bg-white">
                    下一步 <ChevronLeft className="rotate-180" size={20}/>
                  </button>
                </div>
              )}
              {modalStep === 2 && (
                <div className="grid grid-cols-2 gap-3 animate-in fade-in slide-in-from-right-10 duration-300 font-sans">
                  <p className="col-span-2 text-center text-slate-500 font-black text-xs tracking-[0.2em] mb-2 uppercase">SELECT SCENARIO</p>
                  {ZONES.map(o => (
                    <button key={o.id} onClick={() => { setSelectedZone(o.id); setModalStep(3); }} className={`p-4 rounded-xl border transition-all flex flex-col items-center justify-center gap-2 aspect-[4/3] shadow-lg relative overflow-hidden group ${selectedZone === o.id ? `bg-gradient-to-br from-purple-900/60 to-black border-purple-500 ring-1 ring-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.4)]` : `bg-gradient-to-br from-[#1e1b4b]/80 to-black/80 border-white/5 opacity-60 hover:opacity-100 hover:border-purple-500/30`}`}>
                      {selectedZone === o.id && <div className="absolute inset-0 bg-purple-500/10 animate-pulse"></div>}
                      <span className="text-4xl filter drop-shadow-lg relative z-10 mb-1">{o.emoji}</span>
                      <span className="text-xs font-black tracking-tight relative z-10 text-slate-300">{o.label}</span>
                    </button>
                  ))}
                </div>
              )}
              {modalStep === 3 && (
                <div className="space-y-4 animate-in fade-in slide-in-from-right-10 duration-300 font-sans">
                  <p className="text-center text-slate-500 font-black text-xs tracking-[0.2em] mb-4 uppercase">ESTIMATION</p>
                  {SHELL_LEVELS.map(l => (
                    <button key={l.value} onClick={() => { setSelectedShell(l.value); setModalStep(4); }} className={`w-full p-5 rounded-xl border transition-all flex items-center justify-between group ${selectedShell === l.value ? 'bg-gradient-to-r from-red-900/60 to-black border-red-500 text-red-100 shadow-[0_0_15px_rgba(239,68,68,0.3)]' : 'bg-slate-900/40 border-slate-800 text-slate-500 hover:bg-slate-900 hover:text-slate-300 hover:border-red-500/20'} font-sans`}>
                      <span className="text-sm font-black whitespace-nowrap font-sans tracking-wider">{l.label}</span>
                      <div className="flex gap-1">
                          {[...Array(l.iconCount)].map((_, i) => <ShellIcon key={i} size={14} className="text-red-400" />)}
                      </div>
                    </button>
                  ))}
                </div>
              )}
              {modalStep === 4 && (
                <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-8 animate-in fade-in slide-in-from-right-10 duration-300 text-center font-sans">
                  <div className="w-20 h-20 bg-purple-500/10 rounded-full flex items-center justify-center border border-purple-500/30 text-purple-500 shadow-[0_0_30px_rgba(168,85,247,0.2)] animate-pulse"><ShellIcon size={40} className="animate-pulse" /></div>
                  <p className="text-2xl font-black text-white leading-tight tracking-tight font-sans">說好了！要和我一起<br/><span className="text-purple-400 text-lg">在截稿前完成喔！</span></p>
                  <div className="w-full flex justify-center px-4 font-sans">
                    <input type="date" value={deadline} onChange={(e)=>setDeadline(e.target.value)} className="w-full max-w-[240px] p-4 bg-slate-900 border border-slate-700 rounded-xl text-xl font-black text-center text-white [color-scheme:dark] outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 block font-sans uppercase tracking-widest" />
                  </div>
                  <div className="grid grid-cols-2 gap-3 px-4 w-full max-w-[340px] font-sans">
                    {['today','tomorrow'].map(b => (
                      <button key={b} onClick={() => setDateShortcut(b)} className="py-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 font-bold active:bg-purple-700 active:text-white active:border-purple-500 transition-all text-xs font-sans tracking-[0.2em] uppercase hover:bg-slate-700">
                        {b === 'today' ? 'TODAY' : 'TOMORROW'}
                      </button>
                    ))}
                  </div>
                  <button onClick={handleAddTask} className="w-full max-w-[320px] py-5 bg-gradient-to-r from-purple-700 to-red-700 hover:from-purple-600 hover:to-red-600 text-white rounded-xl font-black text-xl shadow-[0_0_20px_rgba(168,85,247,0.4)] active:scale-95 flex items-center justify-center gap-3 font-sans transition-all uppercase tracking-widest">
                    確認委託 <CheckCircle2 size={20} className="animate-pulse"/>
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
 
      {isCropModalOpen && rawImage && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-lg p-6 font-sans">
          <div className="w-full max-w-sm bg-[#1e1b4b] border border-purple-800 rounded-2xl p-8 flex flex-col items-center animate-in zoom-in-95 duration-300 shadow-2xl">
            <h3 className="text-lg font-black text-white mb-6 uppercase tracking-widest text-purple-500">Update Profile</h3>
            <div className="relative w-64 h-64 rounded-full border-2 border-purple-700 overflow-hidden shadow-2xl mb-8 font-sans group">
              <img 
                src={rawImage} 
                className="w-full h-full object-cover font-sans opacity-80 group-hover:opacity-100 transition-opacity"
              />
              <div className="absolute inset-0 pointer-events-none ring-[60px] ring-black/80 rounded-full font-sans"></div>
              <div className="absolute inset-0 bg-gradient-to-b from-transparent via-purple-500/10 to-transparent translate-y-[-100%] animate-[scan_2s_linear_infinite] pointer-events-none"></div>
            </div>
            <div className="flex gap-4 w-full font-sans">
               <button onClick={() => setIsCropModalOpen(false)} className="flex-1 py-4 bg-slate-900 border border-slate-800 rounded-lg font-bold text-slate-400 font-sans hover:bg-slate-800">CANCEL</button>
               <button onClick={handleCropSave} className="flex-2 py-4 bg-purple-700 text-white rounded-lg font-black flex items-center justify-center gap-2 px-8 active:scale-95 font-sans hover:bg-purple-600 transition-all">CONFIRM</button>
            </div>
          </div>
        </div>
      )}
 
      {isCelebrationOpen && (
        <div 
            onClick={() => {
                if (canCloseCelebration) setIsCelebrationOpen(false);
            }}
            className="fixed inset-0 z-[250] flex flex-col items-center justify-center p-8 text-center font-sans overflow-hidden cursor-pointer"
            style={{
                background: 'radial-gradient(circle at center, #312e81 0%, #000000 80%)'
            }}
        >
          {[...Array(30)].map((_, i) => (
             <div key={`rf-${i}`} className="celebration-bubble" style={{ left: `${Math.random() * 100}%`, bottom: `-${Math.random() * 20}%`, animationDuration: `${3 + Math.random() * 4}s`, animationDelay: `${Math.random() * 2}s` }}>
                 <div className="w-2 h-2 rounded-full bg-purple-400 shadow-[0_0_10px_#a855f7]"></div>
             </div>
          ))}
          {[...Array(20)].map((_, i) => (
             <div key={`bf-${i}`} className="celebration-ember" style={{ left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animationDuration: `${2 + Math.random() * 3}s`, animationDelay: `${Math.random() * 2}s` }}>
             </div>
          ))}
          
          <div className="relative z-10" style={{ animation: 'smooth-reveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards' }}>
            <h2 className="text-4xl font-black text-white mb-4 leading-tight font-sans tracking-tight drop-shadow-[0_0_25px_rgba(168,85,247,0.8)]">
              做得好，<br/>保鑣小姐！
            </h2>
            <p className="text-xl text-purple-200 font-bold tracking-[0.2em] mb-8 font-sans uppercase animate-pulse">恭喜你成為</p>
            
            <div className="relative inline-block">
              <div className="absolute inset-0 bg-red-500 blur-xl opacity-20 animate-pulse"></div>
              <div 
                className="relative flex flex-col items-center justify-center border border-purple-500/40 py-10 px-12 rounded-[2rem] bg-slate-900/80 backdrop-blur-xl shadow-[0_0_40px_rgba(168,85,247,0.3)]"
                style={{ animation: 'glow-pulse 3s infinite ease-in-out' }}
              >
                 <div className="mb-4 transform hover:scale-110 transition-transform duration-500">
                    {titleIndex >= 0 && titleIndex <= 2 && <FishIcon size={56} className="text-purple-400 animate-bounce" />}
                    {titleIndex >= 3 && titleIndex <= 5 && <ScallopIcon size={56} className="text-pink-300 drop-shadow-[0_0_15px_rgba(244,114,182,0.8)]" />}
                    {titleIndex >= 6 && titleIndex <= 8 && <CrownIcon size={56} className="text-yellow-200 drop-shadow-[0_0_20px_rgba(253,224,71,0.9)]" />}
                 </div>
                 <p className="text-2xl whitespace-nowrap text-purple-100 font-black tracking-widest uppercase filter drop-shadow-lg">
                    {currentTitle}
                 </p>
              </div>
            </div>
            
            <div className="h-16 flex items-center justify-center mt-12 flex-col gap-2">
                <p className="text-sm text-slate-500 font-bold tracking-[0.3em] font-sans text-center uppercase animate-in slide-in-from-bottom-5 duration-1000 delay-300">
                    FROM RAFAYEL
                </p>
            </div>
          </div>
        </div>
      )}
 
      {isCollectionOpen && (
        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/90 backdrop-blur-md font-sans text-left">
          <div className="w-full max-w-md h-[92vh] bg-[#0c0a1a] rounded-t-[2rem] shadow-2xl flex flex-col animate-in slide-in-from-bottom-20 duration-500 border-t border-purple-900/30 overflow-hidden font-sans">
            <div className="p-8 border-b border-purple-900/30 bg-[#0c0a1a] flex justify-between items-center font-sans z-20 relative">
              <div className="min-w-0 text-left font-sans">
                {/* 修改：Total Shells -> Total Cakes */}
                <h2 className="text-2xl font-black text-white flex items-center gap-3 truncate font-sans uppercase tracking-wider"><span className="text-3xl drop-shadow-[0_0_10px_rgba(239,68,68,0.6)] text-red-400"><ShellIcon size={24}/></span> Gallery</h2>
                <p className="text-[10px] text-purple-500 mt-1 font-black tracking-[0.3em] uppercase opacity-80 font-sans">Total Cakes: {totalShellsConsumed}</p>
              </div>
              <div className="flex gap-3 shrink-0 font-sans text-left">
                <button onClick={() => fileImportRef.current?.click()} className="p-3 bg-slate-800 rounded hover:bg-slate-700 text-slate-300 active:scale-90 transition-all font-sans"><Upload size={20}/></button>
                <button onClick={exportCSV} className="p-3 bg-slate-800 rounded hover:bg-slate-700 text-slate-300 active:scale-90 transition-all font-sans"><Download size={20}/></button>
                <button onClick={() => setIsCollectionOpen(false)} className="p-3 bg-purple-900/20 border border-purple-900/50 rounded text-purple-500 active:scale-90 transition-all font-sans hover:bg-purple-900/40">✕</button>
              </div>
              <input type="file" ref={fileImportRef} onChange={handleImportCSV} className="hidden" accept=".csv" />
            </div>
            <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-black/50 font-sans text-left relative">
               <div className="absolute inset-0 opacity-5 pointer-events-none" style={{backgroundImage: 'radial-gradient(circle at 50% 50%, #a855f7 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
              <div className="flex items-center gap-3 text-slate-600 mb-2 px-2 font-black text-[10px] tracking-widest uppercase font-sans border-b border-purple-900/30 pb-2">
                <Database size={12}/><span className="font-sans">Masterpieces</span>
              </div>
              {completedTasks.length === 0 ? <div className="text-center py-40 opacity-20 text-8xl font-sans filter grayscale blur-[1px]">🎨</div> : 
                completedTasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(t => (
                  <div key={t.id} className="bg-slate-900/60 p-5 rounded-lg border border-slate-800 flex items-start gap-4 shadow-sm font-sans relative group hover:border-purple-800/50 transition-colors">
                    <div className="mt-1 text-purple-500 shrink-0 font-sans drop-shadow-[0_0_5px_rgba(168,85,247,0.5)]"><CheckCircle2 size={20}/></div>
                    <div className="flex-1 text-left min-w-0 font-sans">
                      <h3 className="font-bold text-slate-400 line-through decoration-purple-900 decoration-2 text-lg truncate tracking-tight font-sans pr-8">{t.name}</h3>
                      <div className="flex gap-2 mt-2 flex-wrap font-sans">
                        <span className={`text-[10px] px-2 py-0.5 rounded border border-current uppercase font-bold tracking-wider ${getZoneInfo(t.zone).color} opacity-60 font-sans flex items-center gap-1`}>{getZoneInfo(t.zone).emoji} {getZoneInfo(t.zone).label}</span>
                        <span className="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700 font-bold font-sans flex items-center gap-1">{t.shells || t.paints} <ShellIcon size={8}/></span>
                      </div>
                    </div>
                    {/* 修正收藏區的刪除按鈕冒泡問題 */}
                    <button 
                      type="button" 
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation(); 
                        setTaskToDelete(t);
                      }} 
                      className="absolute right-4 top-5 p-2 text-slate-600 hover:text-red-400 opacity-50 hover:opacity-100 transition-all font-sans cursor-pointer z-20"
                    >
                      <Trash2 size={16}/>
                    </button>
                  </div>
                ))
              }
            </div>
          </div>
        </div>
      )}
 
      {/* 刪除確認視窗 - 移至最底層確保覆蓋在最上方 */}
      {taskToDelete && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/95 backdrop-blur-md p-8 font-sans">
          <div className="w-full max-w-sm bg-[#0f172a] border border-red-900/50 rounded-2xl p-10 text-center animate-in zoom-in-95 duration-300 shadow-[0_0_50px_rgba(220,38,38,0.2)] font-sans relative overflow-hidden">
             <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent"></div>
            <div className="w-16 h-16 bg-red-950/30 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20"><AlertTriangle className="text-red-500" size={32}/></div>
            
            <h3 className="text-xl font-black text-white mb-3 tracking-wider uppercase">
               Destroy Canvas?
            </h3>
            <p className="text-slate-400 text-sm mb-10 leading-relaxed font-bold font-sans">
               不喜歡這個草稿嗎？<br/>那我草莓蛋糕自己吃！
            </p>
            
            <div className="flex flex-col gap-3 font-sans">
               {/* 增加 isDeleting 狀態，防止重複提交 */}
               <button 
                 type="button" 
                 onClick={(e) => {
                   e.stopPropagation();
                   confirmDelete();
                 }} 
                 disabled={isDeleting}
                 className="w-full py-4 bg-red-900/30 border border-red-900/50 hover:bg-red-900/50 text-red-500 rounded-lg font-black active:scale-95 text-sm uppercase tracking-[0.2em] transition-all cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
               >
                 {isDeleting ? 'Deleting...' : '確認收回'}
               </button>
               <button 
                 type="button" 
                 onClick={() => setTaskToDelete(null)} 
                 disabled={isDeleting}
                 className="w-full py-4 bg-slate-800 text-slate-300 rounded-lg font-bold hover:bg-slate-700 transition-all text-sm cursor-pointer disabled:opacity-50"
               >
                 保留
               </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
