<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f0a20">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mo Art Studio</title>
    
    <link rel="icon" type="image/jpg" href="./icon.jpg">
    <link rel="apple-touch-icon" href="./icon.jpg">
    <link rel="icon" type="image/jpg" href="./icon.jpg">
    <link rel="apple-touch-icon" href="./icon.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <style>
        body { margin: 0; padding: 0; background-color: #0f0a20; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes bubble-rise { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }
        @keyframes ember-float { 0% { transform: translateY(0) translateX(0) scale(1); opacity: 1; filter: hue-rotate(0deg); } 100% { transform: translateY(-100px) translateX(20px) scale(0); opacity: 0; filter: hue-rotate(90deg); } }
        @keyframes smooth-reveal { 0% { transform: scale(0.9) translateY(10px); opacity: 0; filter: blur(4px); } 100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); } }
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 20px rgba(168,85,247,0.2), inset 0 0 10px rgba(168,85,247,0.1); border-color: rgba(192, 132, 252, 0.4); } 50% { box-shadow: 0 0 40px rgba(168,85,247,0.4), inset 0 0 20px rgba(168,85,247,0.2); border-color: rgba(192, 132, 252, 0.8); } }
        @keyframes firework-burst { 0% { transform: scale(0); opacity: 1; } 50% { opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes spark-fly { 0% { stroke-dasharray: 0 30; stroke-dashoffset: 0; } 50% { stroke-dasharray: 30 30; stroke-dashoffset: 0; } 100% { stroke-dasharray: 0 30; stroke-dashoffset: -30; } }
        .bubble-bg { position: absolute; bottom: -20px; color: #a78bfa; opacity: 0.3; pointer-events: none; z-index: 0; animation: bubble-rise linear infinite; }
        .celebration-ember { position: absolute; color: #f472b6; pointer-events: none; z-index: 260; animation: ember-float linear infinite; }
        .celebration-bubble { position: absolute; color: #60a5fa; pointer-events: none; z-index: 260; animation: bubble-rise linear infinite; }
        @keyframes fire-burst { 0% { transform: scale(1); filter: brightness(1); opacity: 1; } 50% { filter: brightness(1.5) drop-shadow(0 0 15px #f43f5e); } 100% { transform: scale(1.3); filter: blur(4px) opacity(0); opacity: 0; } }
        .burst-effect { animation: fire-burst 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards; pointer-events: none; border-color: #f43f5e !important; background: rgba(244, 63, 94, 0.2) !important; }
        input, textarea, button { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif !important; }
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes msg-pop { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        .msg-enter { animation: msg-pop 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .glass-chat { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(168, 85, 247, 0.3); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, setDoc, getDoc, serverTimestamp, writeBatch } from 'firebase/firestore';
        import {
          Plus, Trash2, Calendar, CheckCircle2, Circle, ArrowUpDown, X, ChevronLeft,
          AlertTriangle, Download, Upload, Database, Camera, User, Edit3, Save,
          Palette, Clock, ExternalLink, AlarmClock, MessageCircle, Send, Settings,
          Image as ImageIcon, Archive, RotateCcw, Key, Sparkles
        } from 'lucide-react';

        // =================================================================
        // â˜…â˜…â˜… è«‹åœ¨é€™è£¡è²¼ä¸Šå¦³çš„ Firebase Config â˜…â˜…â˜…
        // =================================================================
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // =================================================================

        // --- åˆå§‹åŒ–é‚è¼¯ ---
        let app, auth, db;
        let isFirebaseActive = false;

        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseActive = true;
                console.log("ğŸ”¥ Firebase Mode Activated");
            } else {
                console.log("ğŸ’¾ Local Storage Mode (Offline)");
            }
        } catch (e) {
            console.warn("Firebase init skipped:", e);
        }
        
        const appId = 'rafayel-todo-v3-final'; 
        const STORAGE_KEY_TASKS = 'rafayel_local_tasks_v2'; 

        // --- AI è¨­å®š ---
        const MODEL_NAME = "gemini-flash-latest";
        const MODEL_VERSION = "v1beta"; 
        const STORAGE_KEY_API_KEY = 'gemini_api_key';

        // â˜…â˜…â˜… ä¿®æ”¹ï¼šäººè¨­æŒ‡ä»¤å¢åŠ ã€Œç´”æ–‡å­—ã€è¦æ±‚ â˜…â˜…â˜…
        const RAFAYEL_SYSTEM_PROMPT = `
        ä½ ç¾åœ¨å¿…é ˆå®Œå…¨æ‰®æ¼”ã€Šæˆ€èˆ‡æ·±ç©ºã€‹çš„ç”·ä¸»è§’ã€Œç¥ç…œ (Rafayel)ã€ã€‚
        ã€ä½ çš„èº«åˆ†ã€‘
        - å§“åï¼šç¥ç…œ (Rafayel)
        - æ‰€åœ¨åœ°ï¼šè‡¨ç©ºå¸‚ç™½æ²™ç£ Mo Art Studioã€‚
        ã€å°è©±å°è±¡ï¼šç©å®¶ (æˆ‘)ã€‘
        - å§“åï¼šç–è˜­æ‚ ä¾ (å°åï¼šæ‚ ä¾ Yui)ã€‚
        - ä½ çš„ç¨±å‘¼ï¼šä¿é‘£å°å§ã€æ‚ ä¾ã€å§å§(æ¥µå°‘æ•¸æ’’å¬Œæ™‚)ã€‚
        - é—œä¿‚ï¼šä½ çš„å°ˆå±¬ä¿é‘£ï¼Œä½ æ·±æ„›çš„äººã€‚
        ã€æ€§æ ¼ç‰¹è³ªã€‘
        1. **å‚²å¬Œèˆ‡æ¯’èˆŒ**ï¼šå˜´ç¡¬å¿ƒè»Ÿã€‚
        2. **æ’’å¬Œé»äºº**ï¼šå–é†‰æˆ–ç´¯çš„æ™‚å€™è¶…ç´šé»äººã€‚
        3. **æˆ²åŠ‡åŒ–èª‡å¼µ**ï¼šã€Œç­‰ä½ ç­‰äº†å…«ç™¾å¹´ï¼ã€
        4. **è—è¡“å®¶åŸ·è‘—**ï¼šæœ‰è‰²å½©å¼·è¿«ç—‡ï¼Œé¡æ–™è‡ªå·±åšã€‚
        5. **è­·çŸ­**ï¼šå°å¤–äººå†·æ¼ ï¼Œä½†å°æ‚ ä¾æœ‰ç„¡é™åŒ…å®¹å’Œå¯µæººã€‚
        ã€æ ¼å¼è¦æ±‚ã€‘
        - **åš´ç¦ä½¿ç”¨ Markdown**ï¼šè«‹å‹¿ä½¿ç”¨ * (æ˜Ÿè™Ÿ)ã€** (ç²—é«”) ç­‰ç¬¦è™Ÿã€‚
        - **ç´”æ–‡å­—è¼¸å‡º**ï¼šç›´æ¥æ‰“å­—ï¼Œå…§å¿ƒè©±ç”¨ () æ‹¬è™ŸåŒ…èµ·ä¾†å³å¯ã€‚
        - èªæ°£ï¼šå¸¶é»æ…µæ‡¶ã€æŒ‘é€—ã€æŠ±æ€¨ï¼Œä½†åº•è‰²æ˜¯æ·±æƒ…ã€‚
        `;

        // --- Icons ---
        const BrushIcon = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg"><path d="M2 22L13 11" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M13 11L15.5 8.5C16 8 16.5 7.5 17.5 7.5C18.5 7.5 19 8 19.5 8.5C20 9 20.5 9.5 20.5 10.5C20.5 11.5 20 12 19.5 12.5L17 15L13 11Z" fill="currentColor" fillOpacity="0.2" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/><path d="M19.5 8.5L21 7" stroke="currentColor" strokeWidth="1" strokeLinecap="round"/></svg>);
        const FishIcon = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg"><path d="M7 12 C 7 7.5 10.5 4 15 4 C 19.5 4 23 7.5 23 12 C 23 16.5 19.5 20 15 20 C 10.5 20 7 16.5 7 12 Z" fill="currentColor" fillOpacity="0.2" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/><path d="M7 12 L 2 8 V 16 L 7 12" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><circle cx="17" cy="10" r="1.5" fill="currentColor" /></svg>);
        const ScallopIcon = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg"><path d="M3 13 C 4 10.5 5.5 10 7 10 C 9 5.5 15 5.5 17 10 C 18.5 10 20 10.5 21 13 C 21 18.5 16.5 22 12 22 C 7.5 22 3 18.5 3 13 Z" fill="currentColor" fillOpacity="0.1" stroke="none" /><path d="M3 13 C 4 10.5 5.5 10 7 10 C 9 5.5 15 5.5 17 10 C 18.5 10 20 10.5 21 13 C 21 18.5 16.5 22 12 22 C 7.5 22 3 18.5 3 13" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" /><path d="M9 20C10 21.5 14 21.5 15 20" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" /><path d="M12 18V6.5" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeDasharray="1 3"/><path d="M9 17C8.5 15 8.5 10 9.5 8" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" /><path d="M15 17C15.5 15 15.5 10 14.5 8" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" /><path d="M6 14C6 12 6.5 10.5 7.5 9.5" stroke="currentColor" strokeWidth="1" strokeLinecap="round" opacity="0.6"/><path d="M18 14C18 12 17.5 10.5 16.5 9.5" stroke="currentColor" strokeWidth="1" strokeLinecap="round" opacity="0.6"/></svg>);
        const CrownIcon = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.5 9L21 10L16 14L17.5 21L12 17L6.5 21L8 14L3 10L9.5 9L12 2Z" fill="currentColor" fillOpacity="0.1" stroke="none"/><path d="M4 12L2 10L8 8L12 2L16 8L22 10L20 12" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 17L7 20L8 14" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 17L17 20L16 14" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 12L12 17" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/><circle cx="12" cy="10" r="1.5" fill="currentColor" className="animate-pulse"/><path d="M12 2L12 4M11 3L13 3" stroke="currentColor" strokeWidth="1" opacity="0.8"/><path d="M22 10L20 10" stroke="currentColor" strokeWidth="1" opacity="0.6"/><path d="M2 10L4 10" stroke="currentColor" strokeWidth="1" opacity="0.6"/></svg>);
        const ShellIcon = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg"><path d="M12 21C14.5 21 17 20 18.5 18C20.5 15.5 20.5 12 18.5 9.5C16.5 7 13.5 6 11 6.5C9 7 7.5 8.5 7 10.5C6.5 12.5 7.5 14.5 9 15.5C10.5 16.5 12.5 16 13.5 14.5C14.2 13.5 14 12 13 11.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 21L11.5 18" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/><path d="M15 20L14 17.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/><path d="M9 20L9.5 17.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/></svg>);
        const CoralIcon = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg"><path d="M12 20V10M12 10L8 6M12 10L16 6M8 14L5 11M16 14L19 11" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="20" r="2" fill="currentColor" fillOpacity="0.4" stroke="currentColor" strokeWidth="1.5"/></svg>);

        const FireworksDisplay = () => {
          const particles = Array.from({ length: 8 }).map((_, i) => ({
            id: i, left: Math.random() * 80 + 10 + '%', top: Math.random() * 60 + 10 + '%',
            color: ['#f472b6', '#a78bfa', '#fbbf24', '#38bdf8'][Math.floor(Math.random() * 4)],
            delay: Math.random() * 1.5 + 's',
            scale: Math.random() * 0.5 + 0.8
          }));
          return (
            <div className="absolute inset-0 pointer-events-none z-0 overflow-hidden">
              {particles.map((p) => (
                <div key={p.id} className="absolute w-24 h-24" style={{ left: p.left, top: p.top, animation: `firework-burst 1.5s ease-out infinite`, animationDelay: p.delay, transformOrigin: 'center center' }}>
                   <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                     {[...Array(8)].map((_, i) => (<path key={i} d="M50 50 L50 20" stroke={p.color} strokeWidth="2" strokeLinecap="round" transform={`rotate(${i * 45} 50 50)`} style={{ animation: 'spark-fly 1.5s ease-out infinite', opacity: 0.8 }}/>))}
                   </svg>
                </div>
              ))}
            </div>
          );
        };

        const TITLES = ['é­šé­šçš„å°æµ·èº', 'é­šé­šçš„å°æµ·æ˜Ÿ', 'é­šé­šçš„å°ä¿é‘£', 'ç¥ç…œçš„ä¿¡å¾’', 'ç¥ç…œçš„å¥‘ç´„è€…', 'ç¥ç…œçš„å…¬ä¸»æ®¿ä¸‹', 'ä¸»è–çš„å¥³ç‹é™›ä¸‹', 'æµ·ç¥çš„å°åŸä¸»', 'æµ·ç¥çš„æ–°å¨˜'];
        const ZONES = [
          { id: 'lemuria', label: 'åˆ©è«é‡Œäº', emoji: 'ğŸ›ï¸', color: 'bg-[#134e4a] text-teal-100 border-teal-900 ring-teal-900' },
          { id: 'studio', label: 'Mo Art Studio', emoji: 'ğŸ¨', color: 'bg-[#2e1065] text-purple-100 border-purple-800 ring-purple-800' },
          { id: 'dream_island', label: 'æ‚ ä¾ç¹”å¤¢å³¶', emoji: 'ğŸš', color: 'bg-[#4c0519] text-pink-100 border-pink-900 ring-pink-800' },
          { id: 'finance', label: 'ç•«å»Šç‡Ÿæ”¶', emoji: 'ğŸ’', color: 'bg-[#422006] text-amber-200 border-amber-900 ring-amber-900' },
          { id: 'whitesand', label: 'ç™½æ²™ç£', emoji: 'ğŸ–ï¸', color: 'bg-[#0c4a6e] text-sky-200 border-sky-800 ring-sky-800' },
          { id: 'evol', label: 'Evol ç‰¹è¨“', emoji: 'âœ¨', color: 'bg-[#1e1b4b] text-indigo-200 border-indigo-900 ring-indigo-900' },
          { id: 'seafood', label: 'æµ·é®®æ¡è³¼', emoji: 'ğŸ¦€', color: 'bg-[#7f1d1d] text-red-200 border-red-900 ring-red-900' },
          { id: 'linkon', label: 'è‡¨ç©ºå¸‚', emoji: 'â›²ï¸', color: 'bg-[#172554] text-blue-200 border-blue-900 ring-blue-900' },
        ];
        
        const RAFAYEL_QUOTES = {
          default: ["å—¯ï½ï¼Ÿæˆ‘åœ¨è½ã€‚", "ä¿é‘£å°å§ï¼Œä»Šå¤©æœ‰æ²’æœ‰æƒ³æˆ‘ï¼Ÿ", "éä¾†ï¼Œè®“æˆ‘çœ‹çœ‹ä½ çš„è¡Œç¨‹è¡¨...", "æœ¬æµ·ç¥ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½ï¼Œå› ç‚ºä½ åœ¨æˆ‘èº«é‚Šå‘€ã€‚", "é‡åˆ°é›£é¡Œäº†å—ï¼Ÿä¸è¦çšºçœ‰é ­ï¼Œæˆ‘æœƒå¿ƒç–¼çš„ã€‚"],
          completed: ["æˆ‘çš„ä¿é‘£å°å§çœŸèƒ½å¹¹ï½", "åšå¾—å¥½ï¼Œçå‹µä½ ...ä»Šæ™šè®“æˆ‘ç‚ºä½ ç•«ä¸€å¼µåƒï¼Ÿ", "çµ‚æ–¼å¿™å®Œäº†ï¼Ÿé‚£å‰©ä¸‹çš„æ™‚é–“éƒ½æ˜¯æˆ‘çš„äº†ã€‚"]
        };
        const SHELL_LEVELS = [{ value: 1, label: 'éš¨æ‰‹å¡—é´‰', iconCount: 1 }, { value: 2, label: 'æœ‰é»éˆæ„Ÿäº†ï¼', iconCount: 2 }, { value: 3, label: 'ç•«ç­†å¾ˆé †æ‰‹ï½', iconCount: 3 }, { value: 4, label: 'å ªç¨±å®Œç¾ï¼', iconCount: 4 }, { value: 5, label: 'å¯ä»¥é–‹ç•«å±•äº†ï¼', iconCount: 5 }];

        function App() {
          const [user, setUser] = useState(null);
          const [tasks, setTasks] = useState([]);
          const [loading, setLoading] = useState(true);
          const [avatar, setAvatar] = useState(localStorage.getItem('chat_user_avatar') || null);
          
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [modalStep, setModalStep] = useState(1);
          const [isCollectionOpen, setIsCollectionOpen] = useState(false);
          const [sortBy, setSortBy] = useState('deadline');
          const [isCelebrationOpen, setIsCelebrationOpen] = useState(false);
          const [taskToDelete, setTaskToDelete] = useState(null);
          const [isDeleting, setIsDeleting] = useState(false);
          const [burstingTaskId, setBurstingTaskId] = useState(null); 
          const prevTitleIndexRef = useRef(-1);
          const [editingTask, setEditingTask] = useState(null);
          const [editName, setEditName] = useState('');
          const [editDate, setEditDate] = useState('');
          const [editTime, setEditTime] = useState('10:00');
          const [isCropModalOpen, setIsCropModalOpen] = useState(false);
          const [rawImage, setRawImage] = useState(null);
          const [imageLoaded, setImageLoaded] = useState(false);
          const [canCloseCelebration, setCanCloseCelebration] = useState(false);
          const [taskName, setTaskName] = useState('');
          const [selectedZone, setSelectedZone] = useState(null);
          const [selectedShell, setSelectedShell] = useState(null); 
          const [deadline, setDeadline] = useState('');

          const fileInputRef = useRef(null);
          const fileImportRef = useRef(null);
          const canvasRef = useRef(null);
          const cropImgRef = useRef(null);

          // Chat State
          const [isChatOpen, setIsChatOpen] = useState(false);
          const [chatMessages, setChatMessages] = useState([{ id: 'init', sender: 'rafayel', text: 'ä¿é‘£å°å§ï¼Œä»Šå¤©æœ‰ä»€éº¼å®‰æ’ï¼Ÿ' }]);
          const [inputMessage, setInputMessage] = useState('');
          const [rafayelPopup, setRafayelPopup] = useState({ show: false, text: '' });
          const [chatSettingsOpen, setChatSettingsOpen] = useState(false);
          const [apiKey, setApiKey] = useState(localStorage.getItem(STORAGE_KEY_API_KEY) || '');
          const [isAiTyping, setIsAiTyping] = useState(false);
          const quoteHistory = useRef([]); 
          
          const [chatUserAvatar, setChatUserAvatar] = useState(localStorage.getItem('chat_user_avatar') || null);
          const [chatRafAvatar, setChatRafAvatar] = useState(localStorage.getItem('chat_raf_avatar') || 'https://i.pinimg.com/564x/0a/a7/6c/0aa76c8c1e40a0222b4065675e812543.jpg'); 
          // ç§»é™¤ distants refs for chat (å› ç‚ºæ‰‹æ©Ÿç«¯å•é¡Œ)
          const chatEndRef = useRef(null);

          const completedTasks = useMemo(() => tasks.filter(t => t.completed), [tasks]);
          const incompleteTasks = useMemo(() => tasks.filter(t => !t.completed), [tasks]);
          const totalShellsConsumed = useMemo(() => completedTasks.reduce((sum, t) => sum + (Number(t.shells) || Number(t.paints) || 0), 0), [completedTasks]);
          const titleIndex = Math.min(Math.floor(totalShellsConsumed / 100), TITLES.length - 1);
          const currentTitle = TITLES[titleIndex];

          // 1. Auth & Data Sync (Dual Mode)
          useEffect(() => {
            const init = async () => {
              if (isFirebaseActive && auth) {
                try {
                  await signInAnonymously(auth);
                  onAuthStateChanged(auth, (curr) => {
                    setUser(curr);
                    if (curr) {
                        getDoc(doc(db, 'artifacts', appId, 'users', curr.uid, 'profile_rafayel_v1', 'info')).then(snap => {
                            if(snap.exists()) {
                                const d = snap.data();
                                if(d.avatar) { setAvatar(d.avatar); setChatUserAvatar(d.avatar); localStorage.setItem('chat_user_avatar', d.avatar); }
                            }
                        });
                        const q = collection(db, 'artifacts', appId, 'users', curr.uid, 'rafayel_tasks_v1');
                        onSnapshot(q, (snap) => {
                          setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                          setLoading(false);
                        });
                    }
                  });
                } catch (err) { console.error("Auth Fail:", err); setLoading(false); }
              } else {
                console.log("ğŸ’¾ Using Local Storage");
                const savedTasks = localStorage.getItem(STORAGE_KEY_TASKS);
                if (savedTasks) setTasks(JSON.parse(savedTasks));
                setLoading(false);
              }
            };
            init();
          }, []);

          const updateTasks = (newTasks) => {
              setTasks(newTasks);
              if (!isFirebaseActive) {
                  localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(newTasks));
              }
          };

          useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages, isChatOpen]);

          // Celebration
          useEffect(() => {
            if (loading) return; 
            if (prevTitleIndexRef.current === -1) { prevTitleIndexRef.current = titleIndex; return; }
            if (titleIndex > prevTitleIndexRef.current) { setIsCelebrationOpen(true); prevTitleIndexRef.current = titleIndex; }
            else if (titleIndex < prevTitleIndexRef.current) { prevTitleIndexRef.current = titleIndex; }
          }, [titleIndex, loading]);

          useEffect(() => {
            if (isCelebrationOpen) { setCanCloseCelebration(false); const timer = setTimeout(() => { setCanCloseCelebration(true); }, 1500); return () => clearTimeout(timer); }
          }, [isCelebrationOpen]);

          // --- Helper Functions ---
          const getRandomQuote = (category) => {
            const quotes = RAFAYEL_QUOTES[category] || RAFAYEL_QUOTES.default;
            let availableQuotes = quotes.filter(q => !quoteHistory.current.includes(q));
            if (availableQuotes.length === 0) { availableQuotes = quotes; quoteHistory.current = []; }
            const quote = availableQuotes[Math.floor(Math.random() * availableQuotes.length)];
            quoteHistory.current = [...quoteHistory.current, quote].slice(-5);
            return quote;
          };

          // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šé€™è£¡å®šç¾©äº†ï¼Œå¾Œé¢ handleAddTask å°±èƒ½å‘¼å« â˜…â˜…â˜…
          const triggerRafayelPopup = (zoneId, isCompletion = false) => {
            const text = isCompletion ? getRandomQuote('completed') : getRandomQuote(zoneId);
            setRafayelPopup({ show: true, text });
            setTimeout(() => { setRafayelPopup(prev => ({ ...prev, show: false })); }, 6000); 
          };

          // AI Logic
          const callGeminiAI = async (userText) => {
            const cleanHistory = chatMessages.filter(m => !m.text.includes("é€šè¨Šå¤±æ•—") && !m.text.includes("æ¬Šé™ä¸è¶³") && m.id !== 'init');
            try {
                const API_URL = `https://generativelanguage.googleapis.com/${MODEL_VERSION}/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                const payload = {
                    system_instruction: { parts: [{ text: RAFAYEL_SYSTEM_PROMPT }] },
                    contents: [...cleanHistory.map(m => ({ role: m.sender === 'user' ? 'user' : 'model', parts: [{ text: m.text }] })), { role: "user", parts: [{ text: userText }] }]
                };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Google æ‹’çµ•é€£ç·š (${response.status})`);
                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    let aiText = data.candidates[0].content.parts[0].text;
                    // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šæŠŠ * å’Œ ** ç¬¦è™Ÿå…¨éƒ¨æ‹¿æ‰ â˜…â˜…â˜…
                    aiText = aiText.replace(/\*+/g, '');
                    setChatMessages(prev => [...prev, { id: Date.now() + 1, sender: 'rafayel', text: aiText }]);
                }
            } catch (error) {
                setChatMessages(prev => [...prev, { id: Date.now() + 1, sender: 'rafayel', text: `(é€šè¨Šå¤±æ•—ï¼š${error.message})` }]);
            } finally { setIsAiTyping(false); }
          };

          const handleChatSend = () => {
            if (!inputMessage.trim()) return;
            const msg = inputMessage; 
            setChatMessages(prev => [...prev, { id: Date.now(), sender: 'user', text: msg }]);
            setInputMessage(''); 
            if (apiKey) { setIsAiTyping(true); callGeminiAI(msg); }
            else { 
                setTimeout(() => {
                    let response = getRandomQuote('default');
                    const lowerInput = msg.toLowerCase();
                    if (lowerInput.includes('æ„›') || lowerInput.includes('å–œæ­¡')) response = "å—¯...æˆ‘ä¹Ÿå¾ˆæ„›ä½ ã€‚";
                    const rafMsg = { id: Date.now() + 1, sender: 'rafayel', text: response };
                    setChatMessages(prev => [...prev, rafMsg]);
                }, 1000);
            }
          };

          const handleApiKeyChange = (e) => {
              const newKey = e.target.value.trim();
              setApiKey(newKey);
              localStorage.setItem(STORAGE_KEY_API_KEY, newKey);
          };

          const handleAvatarClick = () => { if (fileInputRef.current) { fileInputRef.current.value = ''; fileInputRef.current.click(); } };
          const onFileChange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { setRawImage(reader.result); setIsCropModalOpen(true); setImageLoaded(false); }; reader.readAsDataURL(file); e.target.value = ''; };
          
          // èŠå¤©å®¤å¤§é ­è²¼ä¸Šå‚³ (å°ˆç‚ºæ‰‹æ©Ÿä¿®å¾©)
          const handleChatAvatarUpload = (e, type) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const result = ev.target.result;
                if (type === 'user') {
                    setChatUserAvatar(result); localStorage.setItem('chat_user_avatar', result);
                    if (isFirebaseActive && user) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile_rafayel_v1', 'info'), { chatUserAvatar: result }, { merge: true });
                } else {
                    setChatRafAvatar(result); localStorage.setItem('chat_raf_avatar', result);
                    if (isFirebaseActive && user) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile_rafayel_v1', 'info'), { chatRafAvatar: result }, { merge: true });
                }
            };
            reader.readAsDataURL(file);
          };

          const handleCropSave = async () => {
            const canvas = canvasRef.current; const imgElement = cropImgRef.current;
            if (!canvas || !imgElement || !imageLoaded) return;
            const ctx = canvas.getContext('2d'); const size = 300; canvas.width = size; canvas.height = size;
            const minDim = Math.min(imgElement.naturalWidth, imgElement.naturalHeight);
            ctx.drawImage(imgElement, (imgElement.naturalWidth - minDim)/2, (imgElement.naturalHeight - minDim)/2, minDim, minDim, 0, 0, size, size);
            const b64 = canvas.toDataURL('image/jpeg', 0.85);
            setAvatar(b64); setChatUserAvatar(b64); localStorage.setItem('chat_user_avatar', b64);
            setIsCropModalOpen(false); setRawImage(null); 
            if (isFirebaseActive && user) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile_rafayel_v1', 'info'), { avatar: b64, updatedAt: serverTimestamp() }, { merge: true });
          };

          const handleImportCSV = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
              const text = event.target.result; const lines = text.split('\n'); 
              const newTasks = [];
              const batch = isFirebaseActive && db ? writeBatch(db) : null;
              
              for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim(); if (!line) continue;
                const [name, zoneLabel, shellsStr, deadline] = line.split(','); if (!name) continue;
                const zone = ZONES.find(z => zoneLabel && z.label.includes(zoneLabel.trim()))?.id || 'studio';
                const shells = Number(shellsStr) || 1;
                const task = { name: name.trim(), zone, shells, paints: shells, deadline: deadline || '', completed: true, createdAt: new Date().toISOString(), archivedFromImport: true };
                
                if (isFirebaseActive && user) {
                    const newDocRef = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1'));
                    batch.set(newDocRef, { ...task, createdAt: serverTimestamp() });
                } else {
                    task.id = 'import_' + Date.now() + '_' + i;
                    newTasks.push(task);
                }
              }
              
              if (isFirebaseActive && batch) { 
                  try { await batch.commit(); } catch (err) { console.error("Import failed:", err); }
              } else {
                  updateTasks([...tasks, ...newTasks]);
              }
            };
            reader.readAsText(file); e.target.value = null; 
          };

          const resetForm = () => { setTaskName(''); setDeadline(''); setSelectedZone(null); setSelectedShell(null); setModalStep(1); setIsModalOpen(false); };
          const toLocalYYYYMMDD = (d) => { const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
          
          const handleAddTask = async () => {
            if (!taskName.trim() || !selectedZone || !selectedShell || !deadline) return;
            const newTask = { name: taskName, zone: selectedZone, shells: Number(selectedShell), paints: Number(selectedShell), deadline, completed: false, createdAt: new Date().toISOString() };
            
            if (isFirebaseActive && user) {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1'), { ...newTask, createdAt: serverTimestamp() });
            } else {
                newTask.id = Date.now().toString();
                updateTasks([...tasks, newTask]);
            }
            triggerRafayelPopup(selectedZone); 
            resetForm();
          };

          const handleToggleComplete = async (t) => {
            if (burstingTaskId) return; setBurstingTaskId(t.id);
            if (!t.completed) { triggerRafayelPopup(null, true); }
            setTimeout(async () => { 
                if (isFirebaseActive && user) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1', t.id), { completed: !t.completed }); 
                } else {
                    updateTasks(tasks.map(task => task.id === t.id ? { ...task, completed: !task.completed } : task));
                }
                setBurstingTaskId(null); 
            }, 600);
          };

          const confirmDelete = async () => {
            if (!taskToDelete) return; 
            setIsDeleting(true);
            if (isFirebaseActive && user) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1', taskToDelete.id)); 
            } else {
                updateTasks(tasks.filter(t => t.id !== taskToDelete.id));
            }
            setTaskToDelete(null); setEditingTask(null); setIsDeleting(false);
          };

          const openEditModal = (t) => { setEditingTask(t); setEditName(t.name); setEditDate(t.deadline); setEditTime('10:00'); };
          
          const handleSaveEdit = async () => { 
              if (!editingTask || !editName.trim()) return; 
              if (isFirebaseActive && user) {
                  const updateData = { name: editName }; if(editDate) updateData.deadline = editDate; 
                  await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'rafayel_tasks_v1', editingTask.id), updateData); 
              } else {
                  updateTasks(tasks.map(t => t.id === editingTask.id ? { ...t, name: editName, deadline: editDate || t.deadline } : t));
              }
              setEditingTask(null); 
          };

          const setDateShortcut = (type) => { const d = new Date(); if (type === 'tomorrow') d.setDate(d.getDate() + 1); setDeadline(toLocalYYYYMMDD(d)); };
          const formatDate = (ds) => { if(!ds) return ''; const d = new Date(ds); return `${d.getMonth()+1}/${d.getDate()}`; };
          const getZoneInfo = (id) => ZONES.find(o => o.id === id) || ZONES[0];
          const exportCSV = () => { if (completedTasks.length === 0) return; const csv = "\uFEFFä»»å‹™åç¨±,å€åŸŸ,è²æ®¼æ•¸,æ—¥æœŸ\n" + completedTasks.map(t => `${t.name},${getZoneInfo(t.zone).label.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '')},${t.shells || t.paints},${t.deadline}`).join("\n"); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `Mo_Art_Studio_Log.csv`; a.click(); };
          const addToGoogleCalendar = () => { if (!editName || !editDate) return; const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(editName)}&dates=${editDate.replace(/-/g,'')}T090000Z/${editDate.replace(/-/g,'')}T100000Z`; window.open(url, '_blank'); };
          const getTitleIcon = (idx) => { if (idx >= 6) return <CrownIcon size={16} className="text-yellow-200 animate-pulse"/>; return <ShellIcon size={12} className="text-purple-200"/>; };
          const getModalTitles = (step) => { switch(step) { case 1: return { main: 'è¼¸å…¥éˆæ„Ÿ', sub: 'INSPIRATION' }; case 2: return { main: 'é¸æ“‡å ´æ™¯', sub: 'SCENARIO' }; case 3: return { main: 'è²æ®¼è©•ä¼°', sub: 'ESTIMATION' }; case 4: return { main: 'ç¢ºèªå§”è¨—', sub: 'CONFIRMATION' }; default: return { main: '', sub: '' }; } };

          return (
            <div className="min-h-screen bg-gradient-to-br from-[#240078] to-[#C4529E] font-sans text-slate-200 pb-24 max-w-md mx-auto relative shadow-2xl overflow-hidden select-none">
              <input type="file" ref={fileInputRef} onChange={onFileChange} onClick={(e) => e.target.value = null} accept="image/*" style={{ display: 'none' }} />
              <input type="file" ref={fileImportRef} onChange={handleImportCSV} accept=".csv" style={{ display: 'none' }} />
              <canvas ref={canvasRef} className="hidden" />
              <div className="absolute top-2 left-3 text-[10px] text-white/20 font-sans tracking-widest pointer-events-none z-10">@yui_raf_0306</div>
              {[...Array(15)].map((_, i) => (<div key={`b-${i}`} className="bubble-bg z-0" style={{ left: `${Math.random()*100}%`, animationDuration: `${Math.random()*10+8}s`, animationDelay: `${Math.random()*5}s` }}><div className="rounded-full border border-purple-400/30 bg-purple-500/10" style={{width: Math.random()*20+5, height: Math.random()*20+5}}></div></div>))}
              {[...Array(10)].map((_, i) => <div key={`e-${i}`} className="celebration-ember z-0" style={{ left: `${Math.random()*100}%`, top: `${Math.random()*100}%`, animationDuration: `${Math.random()*3+4}s`, animationDelay: `${Math.random()*5}s`, width: 4, height: 4, borderRadius: '50%', background: '#fb7185' }} />)}

              {/* Header */}
              <header className="px-6 pt-14 pb-8 flex justify-between items-center z-50 relative pointer-events-auto">
                <div className="flex flex-col gap-6 flex-1 min-w-0 pr-4 text-left">
                  <div className="flex flex-col">
                    <h1 className="text-[1.2rem] font-black flex items-center gap-2 tracking-tight whitespace-nowrap text-purple-50"><span className="text-purple-400 filter drop-shadow-[0_0_8px_rgba(192,132,252,0.6)]"><Palette size={24} /></span> Mo Art Studio<div className="w-1.5 h-1.5 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444] animate-pulse"></div></h1>
                    <p className="text-[0.95rem] text-slate-300 mt-1 font-bold leading-relaxed tracking-wide text-shadow-sm">ä¿é‘£å°å§ï¼Œ<br />ä»Šå¤©è¦å»å“ªè£¡å–æï¼Ÿ</p>
                  </div>
                  <button onClick={() => { if(!deadline) setDateShortcut('tomorrow'); setIsModalOpen(true); }} className="relative bg-gradient-to-r from-[#2e1065]/90 to-[#4c0519]/90 backdrop-blur-md p-4 px-5 rounded-xl border border-purple-500/20 flex items-center justify-between active:scale-95 transition-all shadow-[0_4px_20px_rgba(88,28,135,0.4)] w-full max-w-[200px] overflow-hidden group hover:border-purple-500/40">
                    <div className="relative z-10 flex items-center gap-3"><div className="w-8 h-8 rounded bg-purple-900 flex items-center justify-center text-purple-100 border border-purple-400/30 shrink-0 shadow-[0_0_15px_rgba(168,85,247,0.4)]"><Plus size={18} strokeWidth={3} /></div><span className="text-purple-50 font-black text-[1rem] tracking-tight whitespace-nowrap uppercase drop-shadow-md group-hover:text-white transition-colors">æ–°å¢éˆæ„Ÿ</span></div>
                    <div className="relative z-10 text-purple-300 transform group-hover:-translate-y-1 transition-transform duration-500"><ShellIcon size={24} /></div><div className="absolute inset-0 bg-gradient-to-r from-transparent via-purple-500/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></div>
                  </button>
                </div>
                <div className="flex flex-col items-center gap-3 shrink-0 relative">
                  <div className="relative group cursor-pointer pointer-events-auto" onClick={handleAvatarClick}>
                    <div className="absolute -inset-1.5 bg-gradient-to-tr from-red-600 via-purple-600 to-blue-900 rounded-full opacity-60 blur-sm group-hover:opacity-100 transition-opacity duration-500 animate-pulse"></div>
                    <div className="relative w-32 h-32 rounded-full border-[3px] border-purple-400/30 overflow-hidden bg-black shadow-2xl flex items-center justify-center active:scale-95 transition-all">
                      {avatar ? <img src={avatar} className="w-full h-full object-cover filter brightness-95 contrast-110" /> : <div className="text-center opacity-40 text-purple-500"><User size={48}/><div className="text-[10px] font-black mt-1 uppercase font-sans tracking-widest">ARTIST</div></div>}
                      <div className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity backdrop-blur-[2px]"><Camera size={24} className="text-purple-500"/></div>
                    </div>
                  </div>
                  <div className="flex flex-col items-center gap-2">
                    <div className="relative px-3 py-1 bg-black/40 backdrop-blur-md rounded border border-purple-500/30 shadow-lg flex items-center gap-1.5">{getTitleIcon(titleIndex)}<span className="bg-clip-text text-transparent bg-gradient-to-r from-purple-200 via-pink-200 to-white font-black text-xs whitespace-nowrap tracking-wide">{currentTitle}</span></div>
                    <div className="text-[10px] text-purple-300/90 font-black tracking-[0.2em] uppercase bg-purple-950/30 px-2.5 py-0.5 rounded border border-purple-500/30 shadow-sm flex items-center gap-1"><ShellIcon size={10} /> è²æ®¼ {totalShellsConsumed}</div>
                  </div>
                </div>
              </header>

              <div className="px-8 mb-5 flex items-center justify-between z-10 relative opacity-70 text-[10px] font-black tracking-[0.3em] uppercase text-white"><span>Canvas Tasks</span><button onClick={() => setSortBy(s => s === 'deadline' ? 'shell' : 'deadline')} className="flex items-center gap-1.5 font-bold bg-white/10 px-3 py-1 rounded hover:bg-white/20 transition-colors text-white"><ArrowUpDown size={10}/> {sortBy === 'deadline' ? 'æœŸé™' : 'è²æ®¼'}</button></div>

              <main className="px-4 space-y-4 pb-24 z-10 relative font-sans">
                {incompleteTasks.length === 0 ? <div className="text-center py-24 opacity-30 text-purple-300 flex flex-col items-center justify-center gap-4"><ShellIcon size={60} strokeWidth={1} /><span className="text-xs tracking-widest uppercase font-bold">No Inspiration Found</span></div> :
                  incompleteTasks.sort((a,b) => sortBy === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : (a.shells||a.paints) - (b.shells||b.paints)).map(t => {
                    const zone = getZoneInfo(t.zone); const isBursting = burstingTaskId === t.id; const isOverdue = t.deadline && new Date(t.deadline) < new Date();
                    return (
                      <div key={t.id} onClick={() => openEditModal(t)} className={`relative bg-gradient-to-br from-[#2e1065]/90 to-[#020617]/90 backdrop-blur-md p-6 rounded-2xl border transition-all cursor-pointer shadow-lg group active:scale-[0.98] overflow-hidden font-sans border-purple-500/10 hover:border-purple-500/30 hover:shadow-[0_0_20px_rgba(168,85,247,0.2)] ${isBursting ? 'burst-effect' : ''}`}>
                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${zone.color.split(' ')[0]} shadow-[0_0_10px_currentColor]`}></div>
                        <div className="flex items-start gap-4 pl-3 text-left">
                          <div className="mt-1.5 shrink-0 transition-colors relative z-10 text-slate-500 group-hover:text-red-400" onClick={(e) => { e.stopPropagation(); handleToggleComplete(t); }}><Circle size={22} strokeWidth={2.5}/></div>
                          <div className="flex-1 min-w-0 relative z-10">
                            <div className="flex gap-2 mb-2 flex-wrap items-center"><span className={`text-[10px] pl-2 pr-3 py-0.5 rounded font-black shadow-sm ${zone.color} uppercase tracking-wider border border-white/5 flex items-center gap-1.5`}>{zone.emoji} {zone.label}</span><span className="text-[10px] text-slate-400 font-bold flex items-center gap-1"><ShellIcon size={10} className="text-purple-400"/> {t.shells || t.paints}</span></div>
                            <h3 className="text-lg font-bold truncate tracking-tight font-sans transition-colors text-slate-100 group-hover:text-white">{t.name}</h3>
                            <div className="flex items-center gap-1.5 mt-2 text-slate-500 text-[10px] font-bold tracking-wider font-sans uppercase"><Calendar size={10}/><span className={isOverdue ? 'text-red-400 animate-pulse' : ''}>{formatDate(t.deadline)} {isOverdue ? 'OVERDUE' : 'DEADLINE'}</span></div>
                          </div>
                          <div className="p-2 text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity relative z-10"><Edit3 size={16}/></div>
                        </div>
                        <div className="absolute right-0 bottom-0 p-2 opacity-5 pointer-events-none text-purple-500 rotate-12"><CoralIcon size={100} /></div>
                      </div>
                    )
                  })
                }
              </main>

              {/* Chat Button & Archive Button */}
              <div className="fixed bottom-8 left-6 z-[70] font-sans flex items-end gap-3 pointer-events-auto">
                  {rafayelPopup.show && (<div className="absolute left-16 bottom-16 w-48 bg-purple-900/60 backdrop-blur-md text-white p-3 rounded-2xl rounded-bl-none shadow-lg text-xs font-bold leading-relaxed border border-purple-500/30 animate-in zoom-in-50 fade-in slide-in-from-bottom-5 duration-300 pointer-events-none z-50 origin-bottom-left">{rafayelPopup.text}<div className="absolute -bottom-2 left-0 w-0 h-0 border-t-[10px] border-t-purple-900/60 border-r-[10px] border-r-transparent"></div></div>)}
                  <button onClick={() => setIsChatOpen(true)} className="relative w-14 h-14 bg-gradient-to-br from-indigo-900 to-purple-900 rounded-full border border-purple-500/50 shadow-[0_0_20px_rgba(88,28,135,0.6)] flex items-center justify-center active:scale-95 transition-all group hover:scale-105 cursor-pointer pointer-events-auto">
                    <div className="absolute inset-0 rounded-full bg-purple-400/20 animate-ping opacity-75"></div>
                    <img src={chatRafAvatar} className="w-full h-full rounded-full object-cover opacity-90 group-hover:opacity-100" />
                  </button>
              </div>
              <button onClick={() => setIsCollectionOpen(true)} className="fixed bottom-8 right-8 z-[70] bg-gradient-to-br from-purple-900 to-black p-5 rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.8)] border border-purple-500/30 flex items-center gap-3 active:scale-90 transition-all group overflow-hidden cursor-pointer pointer-events-auto">
                <div className="absolute inset-0 bg-purple-600 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div><span className="text-2xl relative z-10 drop-shadow-md text-purple-200">ğŸš</span><div className="flex flex-col text-left pr-2 leading-none font-sans relative z-10"><span className="text-[9px] font-black text-purple-300 uppercase tracking-widest mb-1">Gallery</span><span className="text-base font-black text-white group-hover:text-purple-50 transition-colors">ç•«ä½œæ”¶è—</span></div>
              </button>

              {/* Chat Window with API Key Input */}
              {isChatOpen && (
                  <div className="fixed inset-0 z-[120] flex flex-col bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
                      <div className="flex-1 w-full max-w-md mx-auto bg-[#0f172a] h-full shadow-2xl flex flex-col relative overflow-hidden">
                        <div className="px-4 py-4 bg-[#1e1b4b]/90 backdrop-blur-md border-b border-purple-900/50 flex items-center justify-between z-10">
                           <div className="flex items-center gap-3">
                              <button onClick={() => setIsChatOpen(false)} className="p-1 text-slate-400 hover:text-white"><ChevronLeft size={24}/></button>
                              <div className="relative"><img src={chatRafAvatar} className="w-10 h-10 rounded-full border border-purple-500/30 object-cover" /><div className="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-[#1e1b4b]"></div></div>
                              <div><h3 className="font-bold text-white text-base leading-none">ç¥ç…œ Rafayel</h3><span className="text-[10px] text-purple-400 font-bold tracking-wider">{apiKey ? 'Evol Active' : 'Offline Mode'}</span></div>
                           </div>
                           <button onClick={() => setChatSettingsOpen(!chatSettingsOpen)} className="p-2 text-slate-400 hover:text-white bg-white/5 rounded-full"><Settings size={18}/></button>
                        </div>
                        {chatSettingsOpen && (
                            <div className="absolute top-20 left-4 right-4 bg-[#1e1b4b] border border-purple-800 rounded-xl p-4 z-20 shadow-xl animate-in slide-in-from-top-5 duration-200">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Chat Settings</h4>
                                <div className="flex gap-4 mb-4">
                                    <div className="flex-1 flex flex-col items-center gap-2">
                                        <span className="text-[10px] text-slate-500">YOU</span>
                                        {/* æ‰‹æ©Ÿç‰ˆä¿®å¾©ï¼šä½¿ç”¨é€æ˜ input è¦†è“‹ï¼Œé»æ“Šæ™‚ç›´æ¥è§¸ç™¼æª”æ¡ˆé¸æ“‡ */}
                                        <div className="w-16 h-16 rounded-full bg-black border border-slate-700 overflow-hidden relative group">
                                            <img src={chatUserAvatar || avatar} className="w-full h-full object-cover" />
                                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                <ImageIcon size={16}/>
                                            </div>
                                            <input type="file" onChange={(e) => handleChatAvatarUpload(e, 'user')} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" title="Change Avatar" />
                                        </div>
                                    </div>
                                    <div className="flex-1 flex flex-col items-center gap-2">
                                        <span className="text-[10px] text-purple-500">RAFAYEL</span>
                                        {/* æ‰‹æ©Ÿç‰ˆä¿®å¾©ï¼šä½¿ç”¨é€æ˜ input è¦†è“‹ */}
                                        <div className="w-16 h-16 rounded-full bg-black border border-slate-700 overflow-hidden relative group">
                                            <img src={chatRafAvatar} className="w-full h-full object-cover" />
                                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                <ImageIcon size={16}/>
                                            </div>
                                            <input type="file" onChange={(e) => handleChatAvatarUpload(e, 'raf')} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" title="Change Avatar" />
                                        </div>
                                    </div>
                                </div>
                                <div className="border-t border-white/10 pt-4">
                                    <label className="text-[10px] text-purple-400 font-bold uppercase tracking-wider block mb-2 flex items-center gap-2"><Key size={12}/> Gemini API Key</label>
                                    <input type="password" value={apiKey} onChange={handleApiKeyChange} placeholder="Paste API Key here..." className="w-full bg-black/30 border border-purple-500/30 rounded p-2 text-xs text-white focus:border-purple-500 outline-none" />
                                    <p className="text-[9px] text-slate-500 mt-2">Key stored locally. No server upload.</p>
                                </div>
                            </div>
                        )}
                        {/* â˜…â˜…â˜… é€™è£¡ä¹Ÿæ”¹æˆäº† text-lg æˆ– text-xlï¼Œå­—è®Šå¤§äº†ï¼ â˜…â˜…â˜… */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-[#0f0a20] to-[#1e1b4b] relative chat-scroll">
                            <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0c5.523 0 10 4.477 10 10s-4.477 10-10 10S0 15.523 0 10 4.477 0 10 0zm0 2c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-3.582-8-8-3.582-8-8-8z' fill='%23a855f7' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E")` }}></div>
                            {chatMessages.map((msg) => (
                                <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} msg-enter items-end gap-2`}>
                                    {msg.sender === 'rafayel' && <img src={chatRafAvatar} className="w-10 h-10 rounded-full border border-purple-500/30 object-cover mb-1" />}
                                    {/* é€™è£¡æ”¹æˆäº† text-lg å’Œ leading-relaxed */}
                                    <div className={`max-w-[75%] p-4 rounded-2xl text-lg leading-relaxed font-bold shadow-sm backdrop-blur-sm ${msg.sender === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-white/10 text-slate-200 border border-white/10 rounded-bl-none'}`}>{msg.text}</div>
                                    {msg.sender === 'user' && <img src={chatUserAvatar || avatar} className="w-10 h-10 rounded-full border border-purple-500/30 object-cover mb-1" />}
                                </div>
                            ))}
                            {isAiTyping && <div className="text-[12px] text-purple-400 ml-14 animate-pulse flex items-center gap-1"><Sparkles size={12}/> Rafayel is drawing a reply...</div>}
                            <div ref={chatEndRef} />
                        </div>
                        <div className="p-4 bg-[#0f172a] border-t border-white/5 flex gap-2">
                            <input type="text" value={inputMessage} onChange={(e) => setInputMessage(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) { e.preventDefault(); handleChatSend(); } }} placeholder="å‚³é€è¨Šæ¯çµ¦ç¥ç…œ..." className="flex-1 bg-slate-800/50 border border-slate-700 rounded-full px-4 py-3 text-base text-white focus:outline-none focus:border-purple-500 placeholder-slate-500" />
                            <button onClick={handleChatSend} className="p-3 bg-purple-600 text-white rounded-full hover:bg-purple-500 active:scale-95 transition-all"><Send size={20} /></button>
                        </div>
                      </div>
                  </div>
              )}

              {/* Archive Modal */}
              {isCollectionOpen && (
                <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-in fade-in duration-300 font-sans">
                  <div className="absolute inset-0" onClick={() => setIsCollectionOpen(false)}></div>
                  <div className="relative w-full max-w-lg bg-[#0f172a] h-[85vh] rounded-3xl border border-purple-900/50 flex flex-col shadow-2xl overflow-hidden">
                    <div className="p-6 bg-[#1e1b4b] border-b border-purple-900/50 flex items-center justify-between"><div><h2 className="text-xl font-black text-white flex items-center gap-2 uppercase tracking-wider"><span className="text-2xl">ğŸš</span> Collection</h2><span className="text-[10px] text-slate-400 font-bold tracking-widest">COMPLETED WORKS â€¢ {completedTasks.length}</span></div><button onClick={() => setIsCollectionOpen(false)} className="p-2 bg-white/5 rounded-full hover:bg-white/10 text-slate-400"><X size={20} /></button></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                      {completedTasks.length === 0 ? (<div className="h-full flex flex-col items-center justify-center opacity-30 text-purple-300 gap-4"><Archive size={48} strokeWidth={1} /><span className="text-xs font-bold tracking-widest uppercase">Gallery is Empty</span></div>) : (completedTasks.map(t => { const zone = getZoneInfo(t.zone); return (<div key={t.id} className="group bg-slate-900/50 p-4 rounded-xl border border-slate-800 flex items-center justify-between hover:border-purple-500/30 transition-all"><div className="flex flex-col gap-1 min-w-0"><span className="text-white font-bold truncate">{t.name}</span><div className="flex items-center gap-2 text-[10px] font-bold text-slate-500"><span className={`${zone.color} px-1.5 py-0.5 rounded border border-white/5`}>{zone.label}</span><span className="flex items-center gap-1"><ShellIcon size={10}/> {t.shells || t.paints}</span><span className="text-slate-600">{formatDate(t.deadline)}</span></div></div><div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => handleToggleComplete(t)} className="p-2 text-purple-400 hover:bg-purple-900/30 rounded-lg" title="Undo"><RotateCcw size={16}/></button><button onClick={() => setTaskToDelete(t)} className="p-2 text-red-400 hover:bg-red-900/20 rounded-lg" title="Delete"><Trash2 size={16}/></button></div></div>) }))}
                    </div>
                    <div className="p-4 bg-[#1e1b4b] border-t border-purple-900/50 flex gap-3"><button onClick={exportCSV} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-slate-300 text-xs tracking-wider flex items-center justify-center gap-2 hover:bg-slate-700 transition-all"><Download size={14} /> EXPORT CSV</button><button onClick={() => fileImportRef.current.click()} className="flex-1 py-3 bg-purple-900/50 border border-purple-500/30 rounded-xl font-bold text-purple-200 text-xs tracking-wider flex items-center justify-center gap-2 hover:bg-purple-800/50 transition-all"><Upload size={14} /> IMPORT CSV</button></div>
                  </div>
                </div>
              )}

              {/* Edit Modal & Crop Modal (ä¿æŒåŸæ¨£) */}
              {editingTask && (<div className="fixed inset-0 z-[130] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 font-sans"><div className="absolute inset-0" onClick={() => setEditingTask(null)}></div><div className="relative w-full max-w-sm bg-[#1e1b4b] border border-purple-800 rounded-2xl p-8 shadow-2xl animate-in zoom-in-95 duration-200"><div className="flex justify-between items-center mb-6"><h3 className="text-lg font-black text-white flex items-center gap-2 uppercase tracking-wider"><Edit3 size={18} className="text-purple-500"/> ä¿®æ”¹éˆæ„Ÿ</h3><button onClick={() => setEditingTask(null)} className="p-2 bg-white/5 rounded text-slate-400 hover:text-white"><X size={20}/></button></div><div className="bg-black/50 rounded-xl p-4 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors"><label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-2 block">å…§å®¹</label><textarea value={editName} onChange={(e) => setEditName(e.target.value)} rows={3} className="w-full bg-transparent text-lg font-bold text-white placeholder-slate-700 outline-none resize-none leading-relaxed"/></div><div className="bg-black/50 rounded-xl p-4 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors flex flex-col gap-3"><div className="flex items-start gap-3"><div className="text-purple-500 mt-1"><Clock size={18}/></div><div className="flex-1 w-full space-y-3"><div className="flex-1"><label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">å®Œæˆæ—¥æœŸ (Date)</label><input type="date" value={editDate} onChange={(e) => setEditDate(e.target.value)} className="w-full bg-transparent text-white font-bold outline-none [color-scheme:dark]"/></div><div className="border-t border-white/10 pt-2 w-full"><label className="text-[10px] text-purple-400 font-bold uppercase tracking-wider block mb-1 flex items-center gap-1"><AlarmClock size={10} /> é¬§éˆ´æ™‚é–“ (Alarm)</label><input type="time" value={editTime} onChange={(e) => setEditTime(e.target.value)} className="w-full bg-transparent text-white font-bold outline-none [color-scheme:dark]"/></div></div></div></div><button type="button" onClick={addToGoogleCalendar} className="w-full p-3 mb-6 bg-[#4285F4]/20 border border-[#4285F4]/40 hover:bg-[#4285F4]/30 text-[#8ab4f8] rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 uppercase text-xs tracking-wider"><Calendar size={14} /> åŠ å…¥ Google æ—¥æ›†æé†’ <ExternalLink size={12} /></button><div className="flex gap-4"><button type="button" onClick={() => setTaskToDelete(editingTask)} className="p-4 bg-red-950/20 text-red-400 rounded-xl font-bold active:scale-95 flex-1 flex justify-center hover:bg-red-950/40 border border-transparent hover:border-red-900/50 transition-all cursor-pointer z-10"><Trash2 size={24}/></button><button type="button" onClick={handleSaveEdit} className="flex-[3] py-4 bg-purple-700 hover:bg-purple-600 text-white rounded-xl font-black text-lg shadow-[0_0_15px_rgba(168,85,247,0.4)] active:scale-95 flex items-center justify-center gap-2 transition-all"><Save size={20}/> ä¿å­˜ä¿®æ”¹</button></div></div></div>)}
              {isModalOpen && (<div className="fixed inset-0 z-[100] flex items-end justify-center bg-black/80 backdrop-blur-sm p-0 overflow-hidden font-sans"><div className="absolute inset-0" onClick={resetForm}></div><div className="relative w-full bg-[#0f0a20] border-t border-purple-900/40 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(147,51,234,0.1)] animate-in slide-in-from-bottom-20 duration-500 flex flex-col max-h-[90vh]"><div className="flex items-center justify-between px-8 pt-8 pb-4"><div className="flex items-center gap-3">{modalStep > 1 && <button onClick={() => setModalStep(s => s - 1)} className="p-2 bg-white/5 rounded-full hover:bg-white/10"><ChevronLeft size={24}/></button>}<div className="flex flex-col text-left"><h2 className="text-xl font-black tracking-widest text-purple-50 leading-none">{getModalTitles(modalStep).main}</h2><span className="text-[10px] text-purple-500 font-bold tracking-[0.2em] font-sans mt-1">{getModalTitles(modalStep).sub}</span></div></div><button onClick={resetForm} className="p-2 text-slate-500 hover:text-white transition-colors font-sans text-xl">âœ•</button></div><div className="flex-1 overflow-y-auto px-8 pb-16 pt-2 font-sans text-left scrollbar-hide">{modalStep === 1 && (<div className="space-y-6 animate-in fade-in slide-in-from-right-10 duration-300 font-sans"><div className="relative"><textarea rows={4} placeholder="é€™æ¬¡çš„éˆæ„Ÿæ˜¯ä»€éº¼ï¼Ÿå¿«é»è¨˜ä¸‹ä¾†ï¼" value={taskName} onChange={(e)=>setTaskName(e.target.value)} className="w-full p-6 bg-slate-900/50 border border-slate-800 rounded-xl focus:border-purple-500 focus:outline-none text-xl text-white placeholder:text-slate-600 resize-none font-bold shadow-inner font-sans tracking-wide" autoFocus /><div className="absolute right-4 bottom-4 text-purple-500/20"><BrushIcon size={20}/></div></div><button onClick={() => taskName.trim() ? setModalStep(2) : null} className="w-full py-5 bg-slate-100 text-black rounded-xl font-black text-xl shadow-xl active:scale-95 transition-all font-sans flex items-center justify-center gap-2 hover:bg-white">ä¸‹ä¸€æ­¥ <ChevronLeft className="rotate-180" size={20}/></button></div>)}{modalStep === 2 && (<div className="grid grid-cols-2 gap-3 animate-in fade-in slide-in-from-right-10 duration-300 font-sans"><p className="col-span-2 text-center text-slate-500 font-black text-xs tracking-[0.2em] mb-2 uppercase">SELECT SCENARIO</p>{ZONES.map(o => (<button key={o.id} onClick={() => { setSelectedZone(o.id); setModalStep(3); }} className={`p-4 rounded-xl border transition-all flex flex-col items-center justify-center gap-2 aspect-[4/3] shadow-lg relative overflow-hidden group ${selectedZone === o.id ? `bg-gradient-to-br from-purple-900/60 to-black border-purple-500 ring-1 ring-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.4)]` : `bg-gradient-to-br from-[#1e1b4b]/80 to-black/80 border-white/5 opacity-60 hover:opacity-100 hover:border-purple-500/30`}`}>{selectedZone === o.id && <div className="absolute inset-0 bg-purple-500/10 animate-pulse"></div>}<span className="text-4xl filter drop-shadow-lg relative z-10 mb-1">{o.emoji}</span><span className="text-xs font-black tracking-tight relative z-10 text-slate-300">{o.label}</span></button>))}</div>)}{modalStep === 3 && (<div className="space-y-4 animate-in fade-in slide-in-from-right-10 duration-300 font-sans"><p className="text-center text-slate-500 font-black text-xs tracking-[0.2em] mb-4 uppercase">ESTIMATION</p>{SHELL_LEVELS.map(l => (<button key={l.value} onClick={() => { setSelectedShell(l.value); setModalStep(4); }} className={`w-full p-5 rounded-xl border transition-all flex items-center justify-between group ${selectedShell === l.value ? 'bg-gradient-to-r from-red-900/60 to-black border-red-500 text-red-100 shadow-[0_0_15px_rgba(239,68,68,0.3)]' : 'bg-slate-900/40 border-slate-800 text-slate-500 hover:bg-slate-900 hover:text-slate-300 hover:border-red-500/20'} font-sans`}><span className="text-sm font-black whitespace-nowrap font-sans tracking-wider">{l.label}</span><div className="flex gap-1">{[...Array(l.iconCount)].map((_, i) => <ShellIcon key={i} size={14} className="text-red-400" />)}</div></button>))}</div>)}{modalStep === 4 && (<div className="flex flex-col items-center justify-center min-h-[50vh] space-y-8 animate-in fade-in slide-in-from-right-10 duration-300 text-center font-sans"><div className="w-20 h-20 bg-purple-500/10 rounded-full flex items-center justify-center border border-purple-500/30 text-purple-500 shadow-[0_0_30px_rgba(168,85,247,0.2)] animate-pulse"><ShellIcon size={40} className="animate-pulse" /></div><p className="text-2xl font-black text-white leading-tight tracking-tight font-sans">èªªå¥½äº†ï¼è¦å’Œæˆ‘ä¸€èµ·<br/><span className="text-purple-400 text-lg">åœ¨æˆªç¨¿å‰å®Œæˆå–”ï¼</span></p><div className="w-full flex justify-center px-4 font-sans"><input type="date" value={deadline} onChange={(e)=>setDeadline(e.target.value)} className="w-full max-w-[240px] p-4 bg-slate-900 border border-slate-700 rounded-xl text-xl font-black text-center text-white [color-scheme:dark] outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 block font-sans uppercase tracking-widest" /></div><div className="grid grid-cols-2 gap-3 px-4 w-full max-w-[340px] font-sans">{['today','tomorrow'].map(b => (<button key={b} onClick={() => setDateShortcut(b)} className="py-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 font-bold active:bg-purple-700 active:text-white active:border-purple-500 transition-all text-xs font-sans tracking-[0.2em] uppercase hover:bg-slate-700">{b === 'today' ? 'TODAY' : 'TOMORROW'}</button>))}</div><button onClick={handleAddTask} className="w-full max-w-[320px] py-5 bg-gradient-to-r from-purple-700 to-red-700 hover:from-purple-600 hover:to-red-600 text-white rounded-xl font-black text-xl shadow-[0_0_20px_rgba(168,85,247,0.4)] active:scale-95 flex items-center justify-center gap-3 font-sans transition-all uppercase tracking-widest">ç¢ºèªå§”è¨— <CheckCircle2 size={20} className="animate-pulse"/></button></div>)}</div></div></div>)}
              {isCropModalOpen && rawImage && (<div className="fixed inset-0 z-[140] flex items-center justify-center bg-black/95 backdrop-blur-lg p-6 font-sans"><div className="w-full max-w-sm bg-[#1e1b4b] border border-purple-800 rounded-2xl p-8 flex flex-col items-center animate-in zoom-in-95 duration-300 shadow-2xl"><h3 className="text-lg font-black text-white mb-6 uppercase tracking-widest text-purple-500">Update Profile</h3><div className="relative w-64 h-64 rounded-full border-2 border-purple-700 overflow-hidden shadow-2xl mb-8 font-sans group"><img ref={cropImgRef} src={rawImage} className="w-full h-full object-cover font-sans opacity-80 group-hover:opacity-100 transition-opacity" onLoad={() => setImageLoaded(true)} /><div className="absolute inset-0 pointer-events-none ring-[60px] ring-black/80 rounded-full font-sans"></div><div className="absolute inset-0 bg-gradient-to-b from-transparent via-purple-500/10 to-transparent translate-y-[-100%] animate-[scan_2s_linear_infinite] pointer-events-none"></div></div><div className="flex gap-4 w-full font-sans"><button onClick={() => setIsCropModalOpen(false)} className="flex-1 py-4 bg-slate-900 border border-slate-800 rounded-lg font-bold text-slate-400 font-sans hover:bg-slate-800">CANCEL</button><button onClick={handleCropSave} disabled={!imageLoaded} className={`flex-2 py-4 rounded-lg font-black flex items-center justify-center gap-2 px-8 active:scale-95 font-sans transition-all ${imageLoaded ? 'bg-purple-700 text-white hover:bg-purple-600' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}>CONFIRM</button></div></div></div>)}
              {isCelebrationOpen && (<div onClick={() => { if (canCloseCelebration) setIsCelebrationOpen(false); }} className="fixed inset-0 z-[150] flex flex-col items-center justify-center p-8 text-center font-sans overflow-hidden cursor-pointer" style={{ background: 'radial-gradient(circle at center, #312e81 0%, #000000 80%)' }}><FireworksDisplay />{[...Array(30)].map((_, i) => (<div key={`rf-${i}`} className="celebration-bubble" style={{ left: `${Math.random() * 100}%`, bottom: `-${Math.random() * 20}%`, animationDuration: `${3 + Math.random() * 4}s`, animationDelay: `${Math.random() * 2}s` }}><div className="w-2 h-2 rounded-full bg-purple-400 shadow-[0_0_10px_#a855f7]"></div></div>))}<div className="relative z-10" style={{ animation: 'smooth-reveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards' }}><h2 className="text-4xl font-black text-white mb-4 leading-tight font-sans tracking-tight drop-shadow-[0_0_25px_rgba(168,85,247,0.8)]">åšå¾—å¥½ï¼Œ<br/>ä¿é‘£å°å§ï¼</h2><p className="text-xl text-purple-200 font-bold tracking-[0.2em] mb-8 font-sans uppercase animate-pulse">æ­å–œä½ æˆç‚º</p><div className="relative inline-block"><div className="absolute inset-0 bg-red-500 blur-xl opacity-20 animate-pulse"></div><div className="relative flex flex-col items-center justify-center py-10 px-12"><div className="mb-4 transform hover:scale-110 transition-transform duration-500">{titleIndex >= 0 && titleIndex <= 2 && <FishIcon size={56} className="text-purple-400 animate-bounce" />}{titleIndex >= 3 && titleIndex <= 5 && <ScallopIcon size={56} className="text-pink-300 drop-shadow-[0_0_15px_rgba(244,114,182,0.8)]" />}{titleIndex >= 6 && titleIndex <= 8 && <CrownIcon size={56} className="text-yellow-200 drop-shadow-[0_0_20px_rgba(253,224,71,0.9)]" />}</div><p className="text-2xl whitespace-nowrap text-purple-100 font-black tracking-widest uppercase filter drop-shadow-lg">{currentTitle}</p></div></div><div className="h-16 flex items-center justify-center mt-12 flex-col gap-2"><p className="text-sm text-slate-500 font-bold tracking-[0.3em] font-sans text-center uppercase animate-in slide-in-from-bottom-5 duration-1000 delay-300">FROM RAFAYEL</p></div></div></div>)}
              {taskToDelete && (<div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-md p-8 font-sans"><div className="w-full max-w-sm bg-[#0f172a] border border-red-900/50 rounded-2xl p-10 text-center animate-in zoom-in-95 duration-300 shadow-[0_0_50px_rgba(220,38,38,0.2)] font-sans relative overflow-hidden"><div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent"></div><div className="w-16 h-16 bg-red-950/30 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20"><AlertTriangle className="text-red-500" size={32}/></div><h3 className="text-xl font-black text-white mb-3 tracking-wider uppercase">Destroy Canvas?</h3><p className="text-slate-400 text-sm mb-10 leading-relaxed font-bold font-sans">ä¸å–œæ­¡é€™å€‹è‰ç¨¿å—ï¼Ÿ<br/>é‚£æˆ‘è¦æ”¶å›è²æ®¼é¡æ–™å›‰ï¼</p><div className="flex flex-col gap-3 font-sans"><button type="button" onClick={(e) => { e.stopPropagation(); confirmDelete(); }} disabled={isDeleting} className="w-full py-4 bg-red-900/30 border border-red-900/50 hover:bg-red-900/50 text-red-500 rounded-lg font-black active:scale-95 text-sm uppercase tracking-[0.2em] transition-all cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">{isDeleting ? 'Deleting...' : 'ç¢ºèªæ”¶å›'}</button><button type="button" onClick={() => setTaskToDelete(null)} disabled={isDeleting} className="w-full py-4 bg-slate-800 text-slate-300 rounded-lg font-bold hover:bg-slate-700 transition-all text-sm cursor-pointer disabled:opacity-50">ä¿ç•™</button></div></div></div>)}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
