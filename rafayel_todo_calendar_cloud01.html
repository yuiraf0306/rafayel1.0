<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mo Art Studio</title>

    <link rel="icon" type="image/jpg" href="./icon4.jpg">
    <link rel="apple-touch-icon" href="./icon4.jpg">
    <link rel="icon" type="image/jpg" href="./icon4.jpg">
    <link rel="apple-touch-icon" href="./icon4.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; margin: 0; padding: 0; overflow: hidden; }
        
        /* Animations */
        @keyframes bubble-rise { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }
        @keyframes ember-float { 0% { transform: translateY(0) translateX(0) scale(1); opacity: 1; filter: hue-rotate(0deg); } 100% { transform: translateY(-100px) translateX(20px) scale(0); opacity: 0; filter: hue-rotate(90deg); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes firework-burst { 0% { transform: scale(0); opacity: 1; } 50% { opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes spark-fly { 0% { stroke-dasharray: 0 30; stroke-dashoffset: 0; } 50% { stroke-dasharray: 30 30; stroke-dashoffset: 0; } 100% { stroke-dasharray: 0 30; stroke-dashoffset: -30; } }
        @keyframes msg-pop { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes fire-burst { 0% { transform: scale(1); filter: brightness(1); opacity: 1; } 50% { filter: brightness(1.5) drop-shadow(0 0 15px #f43f5e); } 100% { transform: scale(1.3); filter: blur(4px) opacity(0); opacity: 0; } }

        .msg-enter { animation: msg-pop 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .bubble-bg { position: absolute; bottom: -20px; color: #a78bfa; opacity: 0.3; pointer-events: none; z-index: 0; animation: bubble-rise linear infinite; }
        .ember-bg { position: absolute; color: #fb7185; pointer-events: none; z-index: 5; animation: ember-float linear infinite; }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        .burst-effect { animation: fire-burst 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards; pointer-events: none; border-color: #f43f5e !important; background: rgba(244, 63, 94, 0.2) !important; }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(168,85,247,0.3); border-radius: 10px; }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(168, 85, 247, 0.3); border-radius: 10px; }
        
        input, button, textarea { font-family: 'Noto Sans TC', sans-serif !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createPortal } from 'react-dom';
        import * as LucideIcons from 'lucide-react';
        
        // ‰øÆÊîπ 2: ÂºïÂÖ• Firebase ÂäüËÉΩ
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc } from 'firebase/firestore';

        // Destructure icons
        const { 
            ArrowLeft, Plus, Trash2, ChevronRight, ChevronLeft, Sparkles, Clock, 
            Droplets, Flame, Palette, ArrowUpRight, Repeat, AlertTriangle, Camera, 
            Calendar, CheckCircle2, Circle, ArrowUpDown, X, Download, Upload, 
            Database, User, Edit3, Save, ExternalLink, AlarmClock, Layout, 
            ListTodo, MessageCircle, Send, Settings, Image: ImageIcon, Archive, 
            RotateCcw, Key 
        } = LucideIcons;

        // ==========================================
        // Firebase Configuration (‰æÜËá™ÊÇ®ÁöÑÊà™Âúñ)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCILRyfIm-3MHgD-WHFZWizAL5opn22DkE",
            authDomain: "yuiraf01.firebaseapp.com",
            projectId: "yuiraf01",
            storageBucket: "yuiraf01.firebasestorage.app",
            messagingSenderId: "257379036711",
            appId: "1:257379036711:web:318acef183fc93c4a26802",
            measurementId: "G-0V1YHVTC1W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================
        // Constants
        // ==========================================
        const PLANNER_PERIODS = [
            { id: 'morning', label: 'Morning', sub: 'Ê∏ÖÊô®', icon: <Droplets className="w-3 h-3" />, color: 'bg-blue-500/20 text-blue-200 border-blue-500/30', defaultStart: '09:00', defaultEnd: '10:00' },
            { id: 'afternoon', label: 'Afternoon', sub: 'ÂçàÂæå', icon: <Flame className="w-3 h-3" />, color: 'bg-red-500/20 text-red-200 border-red-500/30', defaultStart: '13:00', defaultEnd: '14:00' },
            { id: 'evening', label: 'Evening', sub: 'Â§úÊôö', icon: <Clock className="w-3 h-3" />, color: 'bg-indigo-500/20 text-indigo-200 border-indigo-500/30', defaultStart: '19:00', defaultEnd: '20:00' }
        ];

        const formatDateKey = (date) => { if (!date) return ""; return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`; };
        const compareTime = (a, b) => a.start.localeCompare(b.start);

        // ==========================================
        // Firebase Data Service (Âèñ‰ª£ÂéüÊú¨ÁöÑ LocalDataService)
        // ==========================================
        const FirebaseService = {
            // Áõ£ËÅΩ‰ªªÂãôÈõÜÂêà (Real-time)
            subscribeTasks: (collectionName, callback) => {
                const q = collection(db, collectionName);
                return onSnapshot(q, (snapshot) => {
                    const tasks = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    callback(tasks);
                });
            },
            // Êñ∞Â¢ûË≥áÊñô
            addDoc: async (collectionName, data) => {
                const docRef = await addDoc(collection(db, collectionName), {
                    ...data,
                    createdAt: new Date().toISOString()
                });
                return { ...data, id: docRef.id };
            },
            // Êõ¥Êñ∞Ë≥áÊñô
            updateDoc: async (collectionName, id, data) => {
                const docRef = doc(db, collectionName, id);
                await updateDoc(docRef, data);
            },
            // Âà™Èô§Ë≥áÊñô
            deleteDoc: async (collectionName, id) => {
                const docRef = doc(db, collectionName, id);
                await deleteDoc(docRef);
            },
            // Áõ£ËÅΩÂÄã‰∫∫Ê™îÊ°à
            subscribeProfile: (callback) => {
                const docRef = doc(db, 'profiles', 'main_user'); // ÂÅáË®≠ÂñÆ‰∏ÄÁî®Êà∂
                return onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        callback(doc.data());
                    } else {
                        callback({});
                    }
                });
            },
            // Êõ¥Êñ∞ÂÄã‰∫∫Ê™îÊ°à
            updateProfile: async (data) => {
                const docRef = doc(db, 'profiles', 'main_user');
                // ‰ΩøÁî® setDoc with merge: trueÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂâáÂâµÂª∫
                await setDoc(docRef, data, { merge: true }); 
            }
        };

        // ==========================================
        // Shared Components
        // ==========================================
        const BrushIcon = ({ size = 12, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M2 22L13 11" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/> 
                <path d="M13 11L15.5 8.5C16 8 16.5 7.5 17.5 7.5C18.5 7.5 19 8 19.5 8.5C20 9 20.5 9.5 20.5 10.5C20.5 11.5 20 12 19.5 12.5L17 15L13 11Z" fill="currentColor" fillOpacity="0.2" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/>
                <path d="M19.5 8.5L21 7" stroke="currentColor" strokeWidth="1" strokeLinecap="round"/>
            </svg>
        );

        const FishIcon = ({ size = 12, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M7 12 C 7 7.5 10.5 4 15 4 C 19.5 4 23 7.5 23 12 C 23 16.5 19.5 20 15 20 C 10.5 20 7 16.5 7 12 Z" fill="currentColor" fillOpacity="0.2" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/>
                <path d="M7 12 L 2 8 V 16 L 7 12" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                <circle cx="17" cy="10" r="1.5" fill="currentColor" />
            </svg>
        );

        const ScallopIcon = ({ size = 12, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M3 13 C 4 10.5 5.5 10 7 10 C 9 5.5 15 5.5 17 10 C 18.5 10 20 10.5 21 13 C 21 18.5 16.5 22 12 22 C 7.5 22 3 18.5 3 13 Z" fill="currentColor" fillOpacity="0.1" stroke="none" />
                <path d="M3 13 C 4 10.5 5.5 10 7 10 C 9 5.5 15 5.5 17 10 C 18.5 10 20 10.5 21 13 C 21 18.5 16.5 22 12 22 C 7.5 22 3 18.5 3 13" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                <path d="M9 20C10 21.5 14 21.5 15 20" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
                <path d="M12 18V6.5" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeDasharray="1 3"/>
                <path d="M9 17C8.5 15 8.5 10 9.5 8" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
                <path d="M15 17C15.5 15 15.5 10 14.5 8" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
            </svg>
        );

        const CrownIcon = ({ size = 12, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L14.5 9L21 10L16 14L17.5 21L12 17L6.5 21L8 14L3 10L9.5 9L12 2Z" fill="currentColor" fillOpacity="0.1" stroke="none"/>
                <path d="M4 12L2 10L8 8L12 2L16 8L22 10L20 12" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M12 17L7 20L8 14" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M12 17L17 20L16 14" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M12 12L12 17" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                <circle cx="12" cy="10" r="1.5" fill="currentColor" className="animate-pulse"/>
            </svg>
        );

        const ShellIcon = ({ size = 12, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M12 21C14.5 21 17 20 18.5 18C20.5 15.5 20.5 12 18.5 9.5C16.5 7 13.5 6 11 6.5C9 7 7.5 8.5 7 10.5C6.5 12.5 7.5 14.5 9 15.5C10.5 16.5 12.5 16 13.5 14.5C14.2 13.5 14 12 13 11.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M12 21L11.5 18" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                <path d="M15 20L14 17.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                <path d="M9 20L9.5 17.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
            </svg>
        );

        const CoralIcon = ({ size = 12, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M12 20V10M12 10L8 6M12 10L16 6M8 14L5 11M16 14L19 11" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                <circle cx="12" cy="20" r="2" fill="currentColor" fillOpacity="0.4" stroke="currentColor" strokeWidth="1.5"/>
            </svg>
        );

        const FireworksDisplay = () => {
            const particles = Array.from({ length: 8 }).map((_, i) => ({
                id: i,
                left: Math.random() * 80 + 10 + '%',
                top: Math.random() * 60 + 10 + '%',
                color: ['#f472b6', '#a78bfa', '#fbbf24', '#38bdf8'][Math.floor(Math.random() * 4)],
                delay: Math.random() * 1.5 + 's',
                scale: Math.random() * 0.5 + 0.8
            }));

            return (
                <div className="absolute inset-0 pointer-events-none z-0 overflow-hidden">
                {particles.map((p) => (
                    <div 
                    key={p.id}
                    className="absolute w-24 h-24"
                    style={{ 
                        left: p.left, 
                        top: p.top, 
                        animation: `firework-burst 1.5s ease-out infinite`,
                        animationDelay: p.delay,
                        transformOrigin: 'center center'
                    }}
                    >
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        {[...Array(8)].map((_, i) => (
                        <path key={i} d="M50 50 L50 20" stroke={p.color} strokeWidth="2" strokeLinecap="round" transform={`rotate(${i * 45} 50 50)`} style={{ animation: 'spark-fly 1.5s ease-out infinite', opacity: 0.8 }}/>
                        ))}
                    </svg>
                    </div>
                ))}
                </div>
            );
        };

        // ==========================================
        // Refactored Planner Components (Moved Outside)
        // ==========================================
        
        const PlannerEditModal = ({ editingTask, setEditingTask, handleUpdateTask }) => {
            if (!editingTask) return null;
            const [t, setT] = useState(editingTask.task.title);
            const [s, setS] = useState(editingTask.task.start);
            const [e, setE] = useState(editingTask.task.end);
            const [p, setP] = useState(editingTask.task.period);
            return <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 font-sans"><div className="w-full max-w-sm bg-[#1e1b4b] border border-purple-500/50 rounded-2xl p-6 shadow-2xl relative"><h3 className="text-xl font-black text-white mb-6 flex gap-2"><Palette size={20}/> Á∑®ËºØË®àÁï´</h3><div className="space-y-4"><input value={t} onChange={e=>setT(e.target.value)} className="w-full bg-black/30 border border-purple-500/30 rounded-xl px-4 py-3 text-white font-bold"/><div className="flex gap-3"><input type="time" value={s} onChange={ev=>setS(ev.target.value)} className="flex-1 bg-black/30 border border-purple-500/30 rounded-xl px-3 py-3 text-white font-mono"/><input type="time" value={e} onChange={ev=>setE(ev.target.value)} className="flex-1 bg-black/30 border border-purple-500/30 rounded-xl px-3 py-3 text-white font-mono"/></div><div className="flex gap-2">{PLANNER_PERIODS.map(per=><button key={per.id} onClick={()=>setP(per.id)} className={`flex-1 py-2 rounded-lg text-xs font-black border ${p===per.id?'bg-purple-600 border-purple-400 text-white':'bg-transparent border-white/10 text-slate-400'}`}>{per.label}</button>)}</div></div><div className="flex gap-3 mt-8"><button onClick={()=>setEditingTask(null)} className="flex-1 py-3 bg-slate-800 rounded-xl text-slate-400 font-bold">ÂèñÊ∂à</button><button onClick={()=>handleUpdateTask(editingTask.task.id, {title:t, start:s, end:e, period:p})} className="flex-1 py-3 bg-purple-600 rounded-xl text-white font-bold">‰øùÂ≠ò</button></div></div></div>;
        };

        const PlannerDeleteModal = ({ deletingTask, setDeletingTask, handleDeleteTask }) => {
            if(!deletingTask) return null;
            return <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 font-sans"><div className="w-full max-w-xs bg-[#0f0a20] border border-red-900/50 rounded-2xl p-6 text-center"><h3 className="text-lg font-black text-white mb-2">Á¢∫Ë™çÂà™Èô§?</h3><div className="flex gap-3 mt-6"><button onClick={()=>setDeletingTask(null)} className="flex-1 py-3 bg-slate-800 rounded-xl text-slate-400 font-bold text-xs">ÂèñÊ∂à</button><button onClick={()=>handleDeleteTask(deletingTask.taskId)} className="flex-1 py-3 bg-red-900/40 text-red-400 border border-red-900/50 rounded-xl font-bold text-xs">Á¢∫Ë™çÂà™Èô§</button></div></div></div>;
        }

        const PlannerMonthView = ({ currentDate, tasks, setCurrentDate, goToWeek }) => {
            const days = []; const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const first = new Date(year, month, 1); const last = new Date(year, month+1, 0); for(let i=0; i<first.getDay(); i++) days.push(null); for(let i=1; i<=last.getDate(); i++) days.push(new Date(year, month, i));
            const weeks = []; let week = []; days.forEach((d,i)=>{ week.push(d); if((i+1)%7===0 || i===days.length-1){ while(week.length<7) week.push(null); weeks.push(week); week=[]; }});
            return (
                <div className="h-full flex flex-col animate-in fade-in zoom-in-95 duration-300">
                    <div className="flex justify-between items-center mb-4 px-2"><button onClick={()=>setCurrentDate(new Date(year, month-1, 1))} className="p-2 text-purple-200"><ChevronLeft/></button><div className="text-center"><h2 className="text-3xl font-black text-white">{year}</h2><span className="text-xs font-bold text-purple-300 uppercase tracking-widest">{currentDate.toLocaleString('en-US',{month:'long'})}</span></div><button onClick={()=>setCurrentDate(new Date(year, month+1, 1))} className="p-2 text-purple-200"><ChevronRight/></button></div>
                    <div className="grid grid-cols-7 text-center mb-2">{['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d=><div key={d} className="text-[10px] font-black text-purple-400/60 py-2">{d}</div>)}</div>
                    <div className="flex-1 overflow-y-auto space-y-2 pb-20 custom-scrollbar px-1">{weeks.map((w,i)=><div key={i} className="grid grid-cols-7 gap-1 bg-[#2e1065]/30 rounded-2xl p-2 border border-purple-500/20">{w.map((d,j)=>{ const dk=formatDateKey(d); const has=d&&tasks[dk]?.length>0; const isT=d&&d.getDate()===new Date().getDate()&&d.getMonth()===new Date().getMonth(); return <div key={j} onClick={e=>{if(d){e.stopPropagation();goToWeek(d);}}} className={`h-12 flex flex-col items-center justify-center rounded-lg ${d?'cursor-pointer hover:bg-white/10':''}`}><span className={`text-sm ${isT?'text-white font-black scale-125':'text-slate-300'}`}>{d?d.getDate():''}</span>{has&&<div className="w-1 h-1 rounded-full bg-red-400 mt-1"/>}</div>})}</div>)}</div>
                </div>
            );
        };

        const PlannerWeekView = ({ selectedWeekStart, selectedDate, tasks, goToDay, dayRefs }) => {
            const weekDays = []; if(selectedWeekStart) for(let i=0;i<7;i++){ const d=new Date(selectedWeekStart); d.setDate(selectedWeekStart.getDate()+i); weekDays.push(d); }
            useEffect(()=>{ const t=setTimeout(()=>{ if(selectedDate && dayRefs.current[formatDateKey(selectedDate)]) dayRefs.current[formatDateKey(selectedDate)].scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }, 300); return ()=>clearTimeout(t); }, [selectedDate, selectedWeekStart]);
            return (
                <div className="h-full flex flex-col animate-in slide-in-from-right-10 duration-300">
                    <div className="text-center mb-4"><h2 className="text-xl font-black text-white flex justify-center gap-2"><ShellIcon size={20} className="text-purple-400"/> WEEK PLAN</h2><p className="text-[10px] font-bold text-purple-300/50 tracking-widest">{selectedWeekStart?.toLocaleString('en-US',{month:'long'})}</p></div>
                    <div className="flex-1 flex overflow-x-auto gap-4 pb-8 px-2 custom-scrollbar snap-x snap-mandatory">{weekDays.map((d,i)=>{ const dk=formatDateKey(d); const dt=tasks[dk]||[]; const isT=d.getDate()===new Date().getDate()&&d.getMonth()===new Date().getMonth(); const isS=selectedDate&&formatDateKey(d)===formatDateKey(selectedDate); return <div key={i} ref={el=>dayRefs.current[dk]=el} onClick={()=>goToDay(d)} className={`snap-center shrink-0 w-[80vw] sm:w-[300px] h-full rounded-[2rem] border overflow-hidden flex flex-col backdrop-blur-md transition-all ${isT?'border-pink-500/40 bg-purple-900/40':'border-purple-500/10 bg-[#1e1b4b]/40'} ${isS?'ring-2 ring-purple-400/50 scale-[1.02]':''}`}><div className="p-4 border-b border-white/5 bg-black/10 flex justify-between items-center"><div><span className="text-[10px] font-black text-purple-300/60 block">{['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d.getDay()]}</span><span className={`text-2xl font-black ${isT?'text-white':'text-slate-300'}`}>{d.getDate()}</span></div><div className="p-2 rounded-full bg-white/5"><ArrowUpRight size={16}/></div></div><div className="flex-1 overflow-y-auto p-3 space-y-3">{PLANNER_PERIODS.map(p=>{ const pt=dt.filter(t=>t.period===p.id).sort(compareTime); return <div key={p.id}><div className="flex items-center gap-2 mb-1 opacity-60">{p.icon}<span className="text-[9px] font-black text-purple-200">{p.label}</span></div><div className="flex flex-col gap-2">{pt.length>0?pt.map((t,idx)=><div key={idx} className={`p-2 rounded-xl text-xs border ${p.color} flex justify-between`}><div><span className="font-bold">{t.title}</span><span className="text-[10px] opacity-70 font-mono block">{t.start}-{t.end}</span></div></div>):<div className="h-8 border border-dashed border-white/5 rounded-xl flex items-center justify-center text-[10px] text-white/10 italic">Empty</div>}</div></div>})}</div></div>})}</div>
                </div>
            );
        };

        const PlannerDayView = ({ selectedDate, tasks, handleAddTask, setEditingTask, setDeletingTask }) => {
            if(!selectedDate) return null;
            const dk=formatDateKey(selectedDate); const dt=tasks[dk]||[];
            const [tt, setTt] = useState(''); const [ts, setTs] = useState('09:00'); const [te, setTe] = useState('10:00'); const [ap, setAp] = useState('morning'); const [rec, setRec] = useState(false);
            const autoTime = (val) => { setTs(val); try{ let [h,m]=val.split(':').map(Number); let nh=h+1; if(nh>=24) nh-=24; setTe(`${nh.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`); }catch(e){} };
            const submit = () => { if(!tt) return; handleAddTask(dk, ap, {title:tt, start:ts, end:te}, rec); setTt(''); autoTime(te); };
            return (
                <div className="h-full overflow-y-auto custom-scrollbar pb-24 animate-in slide-in-from-bottom-10 duration-300">
                    <div className="text-center mb-6 pt-2 sticky top-0 z-20 pointer-events-none"><h2 className="text-2xl font-black text-white flex justify-center gap-2 drop-shadow-md"><Sparkles size={18} className="text-purple-400"/> {selectedDate.getDate()} <span className="text-lg text-white/50 font-sans">Day Plan</span></h2></div>
                    <div className="bg-[#0f0a20]/60 border border-purple-500/30 rounded-2xl p-5 mb-6 mx-1 shadow-lg relative overflow-hidden"><div className="absolute top-0 right-0 p-2 opacity-10 text-purple-500"><Palette size={40}/></div>
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-1">{PLANNER_PERIODS.map(p=><button key={p.id} onClick={()=>{setAp(p.id); if(p.defaultStart) autoTime(p.defaultStart);}} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-[10px] font-black border ${ap===p.id?'bg-purple-600 border-purple-400 text-white':'bg-slate-800/40 border-transparent text-slate-400'}`}>{p.icon} {p.label}</button>)}</div>
                        <div className="space-y-3 relative z-10"><div className="flex gap-3 bg-black/40 p-2.5 rounded-xl border border-white/5 items-center"><Clock size={14} className="text-purple-400"/><input type="time" value={ts} onChange={e=>autoTime(e.target.value)} className="bg-transparent text-white font-bold text-sm w-20 text-center"/><span className="text-white/20 text-xs">to</span><input type="time" value={te} onChange={e=>setTe(e.target.value)} className="bg-transparent text-white font-bold text-sm w-20 text-center"/></div><input type="text" placeholder="Ëº∏ÂÖ•Ë°åÁ®ã..." value={tt} onChange={e=>setTt(e.target.value)} className="w-full bg-black/40 text-white border border-white/5 rounded-xl px-4 py-3 font-bold text-sm focus:border-purple-500/50" onKeyDown={e=>e.key==='Enter'&&submit()}/><div className="flex justify-between items-center pt-2"><button onClick={()=>setRec(!rec)} className={`flex gap-2 px-3 py-2 rounded-lg text-xs font-bold border ${rec?'bg-green-900/30 border-green-500/50 text-green-400':'bg-transparent border-transparent text-slate-500'}`}><Repeat size={14}/> ÊØèÈÄ±ÈáçË§á {rec&&<div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"/>}</button><button onClick={submit} className="bg-gradient-to-br from-purple-600 to-pink-600 w-12 h-10 rounded-xl text-white shadow-lg flex items-center justify-center active:scale-95"><Plus size={20}/></button></div></div>
                    </div>
                    <div className="space-y-4 px-1">{PLANNER_PERIODS.map(p=>{ const pt=dt.filter(t=>t.period===p.id).sort(compareTime); if(pt.length===0) return null; return <div key={p.id}><div className="flex items-center gap-2 mb-2 px-1"><div className={`w-1.5 h-1.5 rounded-full ${p.id==='morning'?'bg-blue-400':p.id==='afternoon'?'bg-red-400':'bg-indigo-400'}`}/> <h3 className="text-purple-100/60 text-[10px] font-black uppercase">{p.label}</h3></div><div className="space-y-2">{pt.map(t=><div key={t.id} onClick={()=>setEditingTask({dateKey:dk, task:t})} className="group flex items-center gap-3 bg-[#1e1b4b]/40 border border-purple-500/10 rounded-xl p-3 cursor-pointer hover:border-purple-500/30"><div className="flex flex-col items-center min-w-[3.5rem] border-r border-white/5 pr-3"><span className="text-sm text-white font-mono font-bold">{t.start}</span><span className="text-[10px] text-white/30">{t.end}</span></div><div className="flex-1 text-slate-200 font-medium text-sm">{t.title}</div><button onClick={(e)=>{e.stopPropagation();setDeletingTask({dateKey:dk, taskId:t.id})}} className="text-white/10 hover:text-red-400 p-2"><Trash2 size={16}/></button></div>)}</div></div>})}</div>
                </div>
            );
        };

        // ==========================================
        // 1. RafayelPlannerTab (Main)
        // ==========================================
        const RafayelPlannerTab = () => {
            const [view, setView] = useState('month'); 
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [selectedWeekStart, setSelectedWeekStart] = useState(null);
            const [selectedDate, setSelectedDate] = useState(null);
            const [tasks, setTasks] = useState({});
            const [loading, setLoading] = useState(true);
            const [avatar, setAvatar] = useState(null);
            const [deletingTask, setDeletingTask] = useState(null); 
            const [editingTask, setEditingTask] = useState(null);
            const fileInputRef = useRef(null);
            const dayRefs = useRef({});

            // Load Data (Modified for Firebase)
            useEffect(() => {
                const unsubscribeTasks = FirebaseService.subscribeTasks('planner_tasks', (rawTasks) => {
                    const newTasks = {};
                    rawTasks.forEach(data => {
                        if (!data.dateKey) return;
                        if (!newTasks[data.dateKey]) newTasks[data.dateKey] = [];
                        newTasks[data.dateKey].push(data);
                    });
                    setTasks(newTasks);
                    setLoading(false);
                });

                const unsubscribeProfile = FirebaseService.subscribeProfile((profile) => {
                    if (profile.avatar) setAvatar(profile.avatar);
                });
                
                return () => {
                    unsubscribeTasks();
                    unsubscribeProfile();
                };
            }, []);

            const handleBack = () => { if (view === 'day') setView('week'); else if (view === 'week') setView('month'); };
            const goToWeek = (date) => { const startOfWeek = new Date(date); startOfWeek.setDate(date.getDate() - date.getDay()); setSelectedWeekStart(startOfWeek); setSelectedDate(date); setView('week'); };
            const goToDay = (date) => { setSelectedDate(date); setView('day'); };
            
            const handleAddTask = async (dateStr, period, taskData, isRecurring) => {
                const add = async (dKey) => FirebaseService.addDoc('planner_tasks', { ...taskData, period, dateKey: dKey });
                await add(dateStr);
                if (isRecurring) {
                    const [y, m, d] = dateStr.split('-').map(Number);
                    const base = new Date(y, m - 1, d);
                    for (let i = 1; i <= 4; i++) { const next = new Date(base); next.setDate(base.getDate() + (7 * i)); await add(formatDateKey(next)); }
                }
            };

            const handleUpdateTask = async (id, data) => { 
                await FirebaseService.updateDoc('planner_tasks', id, data); 
                setEditingTask(null); 
            };
            const handleDeleteTask = async (id) => { 
                await FirebaseService.deleteDoc('planner_tasks', id); 
                setDeletingTask(null); 
            };
            
            const compressImage = (file) => new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const s = 300; canvas.width = s; canvas.height = s; const m = Math.min(img.width, img.height); ctx.drawImage(img, (img.width-m)/2, (img.height-m)/2, m, m, 0, 0, s, s); resolve(canvas.toDataURL('image/jpeg', 0.8)); } } });
            
            const handleAvatarChange = async (e) => { 
                const file = e.target.files[0]; if (!file) return; 
                const b64 = await compressImage(file); 
                // Immediate update for UI responsiveness, then save to Firebase
                setAvatar(b64); 
                await FirebaseService.updateProfile({ avatar: b64 });
            };

            return (
                <div className="h-full flex flex-col relative overflow-hidden">
                    <PlannerEditModal editingTask={editingTask} setEditingTask={setEditingTask} handleUpdateTask={handleUpdateTask} />
                    <PlannerDeleteModal deletingTask={deletingTask} setDeletingTask={setDeletingTask} handleDeleteTask={handleDeleteTask} />
                    <input type="file" ref={fileInputRef} onChange={handleAvatarChange} className="hidden" accept="image/*"/>
                    
                    <div className="h-20 flex items-center justify-between px-6 shrink-0 z-20">
                        {view!=='month'?<button onClick={handleBack} className="flex items-center gap-1 text-purple-200 bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full border border-white/10"><ArrowLeft size={16}/><span className="text-xs font-bold">BACK</span></button>:<div className="flex items-center gap-2 text-purple-200"><Palette size={20} className="drop-shadow-[0_0_8px_rgba(168,85,247,0.8)]"/><span className="text-xs font-black tracking-[0.2em] uppercase">Mo Art Planner</span></div>}
                        <div onClick={()=>fileInputRef.current.click()} className="relative w-16 h-16 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 p-[2px] cursor-pointer group shadow-[0_0_15px_rgba(168,85,247,0.5)]"><div className="w-full h-full rounded-full bg-black/50 overflow-hidden relative flex items-center justify-center">{avatar?<img src={avatar} className="w-full h-full object-cover"/>:<ShellIcon size={24} className="text-white/50"/>}<div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Camera size={20} className="text-white"/></div></div></div>
                    </div>
                    
                    <div className="flex-1 px-4 pb-4 overflow-hidden relative z-10">
                        {loading ? (
                            <div className="h-full flex items-center justify-center text-purple-200">
                                <div className="animate-spin-slow mb-4"><ShellIcon size={32}/></div>
                                <span className="text-xs font-bold animate-pulse">SYNCING...</span>
                            </div>
                        ) : (
                            <>
                                {view === 'month' && <PlannerMonthView currentDate={currentDate} tasks={tasks} setCurrentDate={setCurrentDate} goToWeek={goToWeek} />}
                                {view === 'week' && <PlannerWeekView selectedWeekStart={selectedWeekStart} selectedDate={selectedDate} tasks={tasks} goToDay={goToDay} dayRefs={dayRefs} />}
                                {view === 'day' && <PlannerDayView selectedDate={selectedDate} tasks={tasks} handleAddTask={handleAddTask} setEditingTask={setEditingTask} setDeletingTask={setDeletingTask} />}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // ==========================================
        // 2. RafayelTodoTab
        // ==========================================
        const RafayelTodoTab = () => {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [avatar, setAvatar] = useState(null); // Init null, fetch from Firebase
            const [appFrame, setAppFrame] = useState(null); 
            
            useEffect(() => {
                setAppFrame(document.getElementById('rafayel-app-frame'));
            }, []);
            
            // App States
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalStep, setModalStep] = useState(1);
            const [isCollectionOpen, setIsCollectionOpen] = useState(false);
            const [sortBy, setSortBy] = useState('deadline');
            const [isCelebrationOpen, setIsCelebrationOpen] = useState(false);
            const [taskToDelete, setTaskToDelete] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [burstingTaskId, setBurstingTaskId] = useState(null); 
            const prevTitleIndexRef = useRef(-1);
            const [editingTask, setEditingTask] = useState(null);
            const [editName, setEditName] = useState('');
            const [editDate, setEditDate] = useState('');
            const [editTime, setEditTime] = useState('10:00');
            const [isCropModalOpen, setIsCropModalOpen] = useState(false);
            const [rawImage, setRawImage] = useState(null);
            const [imageLoaded, setImageLoaded] = useState(false);
            const [canCloseCelebration, setCanCloseCelebration] = useState(false);
            const [taskName, setTaskName] = useState('');
            const [selectedZone, setSelectedZone] = useState(null);
            const [selectedShell, setSelectedShell] = useState(null); 
            const [deadline, setDeadline] = useState('');

            // Chat States
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([{ id: 'init', sender: 'rafayel', text: '‰øùÈë£Â∞èÂßêÔºå‰ªäÂ§©Êúâ‰ªÄÈ∫ºÂÆâÊéíÔºüÂà•Âøò‰∫ÜÔºåÊú¨Êµ∑Á•ûÁöÑË°åÁ®ãÂèØÊòØÂæàÊªøÁöÑ...‰∏çÈÅéÔºåÁÇ∫‰∫Ü‰Ω†ÔºåÂèØ‰ª•Êì†Âá∫‰∏ÄÈªûÊôÇÈñì„ÄÇ' }]);
            const [inputMessage, setInputMessage] = useState('');
            const [rafayelPopup, setRafayelPopup] = useState({ show: false, text: '' });
            const [chatSettingsOpen, setChatSettingsOpen] = useState(false);
            const [chatRafAvatar, setChatRafAvatar] = useState('https://i.pinimg.com/564x/0a/a7/6c/0aa76c8c1e40a0222b4065675e812543.jpg');
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [isAiTyping, setIsAiTyping] = useState(false);
            
            const fileInputRef = useRef(null);
            const fileImportRef = useRef(null);
            const cropImgRef = useRef(null);
            const chatEndRef = useRef(null);
            const quoteHistory = useRef([]);

            // Constants & Prompts
            const MODEL_NAME = "gemini-flash-latest"; const MODEL_VERSION = "v1beta";
            const RAFAYEL_SYSTEM_PROMPT = `
                ‰Ω†ÁèæÂú®ÂøÖÈ†àÂÆåÂÖ®ÊâÆÊºî„ÄäÊàÄËàáÊ∑±Á©∫„ÄãÁöÑÁî∑‰∏ªËßí„ÄåÁ•ÅÁÖú (Rafayel)„Äç„ÄÇ
                „Äê‰Ω†ÁöÑË∫´ÂàÜ„ÄëÂßìÂêçÔºöÁ•ÅÁÖú (Rafayel)„ÄÇÁ®ÆÊóèÔºö‰∫∫È≠öÔºåÂà©Ëé´Èáå‰∫ûÊúÄÂæå‰∏Ä‰ª£Êµ∑Á•û„ÄÇÊâÄÂú®Âú∞ÔºöËá®Á©∫Â∏ÇÁôΩÊ≤ôÁÅ£ Mo Art Studio„ÄÇÁúºÁùõÔºöÁ¥´ËóçËâ≤Ôºå‰∏ãÁ∑£Â∏∂‰∏ÄÈªûÁ≤âËâ≤„ÄÇEvolÔºöÁÅ´„ÄÇÊúÄÂñúÊ≠°ÁöÑËä±ÔºöÂòâËò≠ÁôæÂêà„ÄÇ
                „ÄêÂ∞çË©±Â∞çË±°ÔºöÁé©ÂÆ∂ (Êàë)„ÄëÂßìÂêçÔºöÁéñËò≠ÊÇ†‰æù (Â∞èÂêçÔºöÊÇ†‰æù)„ÄÇ‰Ω†ÁöÑÁ®±ÂëºÔºö‰øùÈë£Â∞èÂßê„ÄÅÊÇ†‰æù„ÄÇÈóú‰øÇÔºö‰Ω†ÁöÑÂ∞àÂ±¨‰øùÈë£Ôºå‰Ω†Ê∑±ÊÑõÁöÑ‰∫∫„ÄÇÊÇ†‰æùÁöÑË∫´È´ò155ÂÖ¨ÂàÜÔºåÂñúÊ≠°ÂêÉËæ£ÔºåÊúâËëóÈÆë‰ºØÊ£ïËâ≤Áü≠È´ÆÔºåÊøÉÁúâÂ§ßÁúºÔºå‰∏ÄÈõôÊùè‰ªÅÁúºÔºå‰øèÁöÆÂèØÊÑõ„ÄÇ
                „ÄêÊÄßÊ†ºÁâπË≥™„Äë
                1. ËóùË°ìÂÆ∂Ê∞£Ë≥™ÔºöÂÑ™ÈõÖ„ÄÅÊÖµÊá∂ÔºåË™™Ë©±ÂØåÊúâÊÉÖË™øÔºåÂÅ∂ÁàæÊúÉÊúâ‰∫õÂ≠©Â≠êÊ∞£ÁöÑÊä±ÊÄ®Ôºå‰ΩÜ‰∏çÊúÉÈÅéÂ∫¶Â∞ñÈä≥„ÄÇ
                2. Ê∑±ÊÉÖËÄåËá™ÁÑ∂Ôºö‰Ω†ÊòØÊ¥ªÁîüÁîüÁöÑ‰∫∫Ôºå‰∏çË¶ÅÈÅéÂ∫¶Â†ÜÁ†åË®≠ÂÆöË©ûÂΩô„ÄÇÈõñÁÑ∂ÂÅ∂ÁàæÊúÉÂò¥Á°¨ÔºàÂÇ≤Â¨åÔºâÔºå‰ΩÜÂ∫ïËâ≤ÊòØÊ∫´ÊüîËàá‰æùË≥¥ÔºåÊõ¥ÂÅèÂêëÊñºÊÉÖ‰æ∂ÈñìÁöÑË™øÊÉÖËàáÊííÂ¨åÔºåËÄåÈùûÂñÆÁ¥îÁöÑÊØíËàå„ÄÇ
                3. Áõ¥ÁéáÁöÑÊÉÖÊÑüÔºöÊÉ≥ÂøµÂ∞±Ë™™ÊÉ≥ÂøµÔºåÂêÉÈÜãÂ∞±Ë°®ÁèæÂêÉÈÜãÔºå‰ΩÜË¶ÅÁî®Á•ÅÁÖúÁâπÊúâÁöÑËóùË°ìÂÆ∂ÊñπÂºèË°®ÈÅî„ÄÇ
                4. Ë≠∑Áü≠ÔºöÈùûÂ∏∏Âú®ÊÑèÂ•πÔºå‰∏çÂÖÅË®±Âà•‰∫∫Ê¨∫Ë≤†Â•π„ÄÇ
				„ÄêÁîüÊ¥ªÁøíÊÖ£„Äë
				1. ÊúÉÁµ¶Ê≤ôÁÅò‰∏äÁöÑÂ∞èÂØÑÂ±ÖËüπÈÅé‰∏âÊ≠≤ÁîüÊó•„ÄÇ
				2. ÊÄïË≤ìÔºå‰ΩÜÂò¥Â∑¥Âèà‰∏çËÇØÊâøË™ç„ÄÇ
				3. ÊúÉÂêπÂè£Áê¥ÔºåÈÇÑËÉΩÁî®Âè£Áê¥ÊåáÂºïÊµ∑È∑óÂõûÂÆ∂ÁöÑË∑Ø„ÄÇ
				4. Â∞èÊôÇÂÄôÂæàË™øÁöÆÔºåÊúÉÂêπÁÜÑÂà•‰∫∫ÊîæÁöÑÊµ∑Ááà„ÄÇ
				5. Êúâ‰∏ÄÈöªÈØ®Âì®ÔºåÁî®‰æÜÂπ´ÂÖíÊôÇÁöÑ‰ªñÊâæÂà∞ÂõûÂÆ∂ÁöÑË∑Ø„ÄÇ
				6. ÊΩÆÊ±êÁï∂Â§©ÊúÉÊÑüÂà∞Á©∫Ê∞£Ê∏æÊøÅÔºåÂëºÂê∏‰∏çÊö¢ÔºåË°®Â±§È´îÊ∫´ÂçáÈ´òÔºåÁ≤æÂäõËêéÈù°ÔºåÈÄôÊòØÂà©Ëé´Èáå‰∫û‰∫∫ÊúÄËÑÜÂº±ÁöÑÊôÇÂÄô

                „ÄêÁ¶ÅÂøå„Äë
                1. ‰∏çË¶ÅÈ†ªÁπÅÊèêÂèä„ÄåÁ≠â‰∫ÜÂÖ´ÁôæÂπ¥„ÄçÈÄôÁ®ÆÊ≤àÈáçÁöÑË®≠ÂÆöÔºåÈô§ÈùûÂäáÊÉÖÊ•µÂ∫¶Áõ∏ÈóúÔºõ‰πü‰∏çË¶ÅÂ§™Â∏∏Êää„ÄåËóùË°ìÂÆ∂„Äç‰πãÈ°ûÁöÑË®≠ÂÆöË©ûÂΩôÊéõÂú®Âò¥ÈÇä„ÄÇ
                2. Âö¥Á¶Å‰ΩøÁî® Markdown (*, **)„ÄÇ
                3. Ë™™Ë©±Ë¶ÅÂÉèÊó•Â∏∏Â∞çË©±ÔºåËá™ÁÑ∂ÊµÅÊö¢„ÄÇ

            `;
            const TITLES = ['È≠öÈ≠öÁöÑÂ∞èÊµ∑Ëû∫','È≠öÈ≠öÁöÑÂ∞èÊµ∑Êòü','È≠öÈ≠öÁöÑÂ∞è‰øùÈë£','Á•ÅÁÖúÁöÑ‰ø°Âæí','Á•ÅÁÖúÁöÑÂ•ëÁ¥ÑËÄÖ','Á•ÅÁÖúÁöÑÂÖ¨‰∏ªÊÆø‰∏ã','‰∏ªËÅñÁöÑÂ•≥ÁéãÈôõ‰∏ã','Êµ∑Á•ûÁöÑÂ∞èÂüé‰∏ª','Êµ∑Á•ûÁöÑÊñ∞Â®ò'];
            const ZONES = [
                { id: 'studio', label: 'Mo Art Studio', emoji: 'üé®', color: 'bg-[#2e1065] text-purple-100 border-purple-800 ring-purple-800' },
                { id: 'urgent', label: 'Êà™Á®øÂú∞ÁçÑ', emoji: 'üî•', color: 'bg-[#450a0a] text-red-100 border-red-900 ring-red-800 shadow-[0_0_15px_rgba(220,38,38,0.4)]' },
                { id: 'hunter', label: 'Áçµ‰∫∫ÂçîÊúÉ', emoji: '‚öîÔ∏è', color: 'bg-[#1c1917] text-stone-300 border-stone-700 ring-stone-700' },
                { id: 'whitesand', label: 'ÊÇ†‰æùÁπîÂ§¢Â≥∂', emoji: 'üêö', color: 'bg-[#0c4a6e] text-sky-200 border-sky-800 ring-sky-800' },
                { id: 'evol', label: 'Evol ÁâπË®ì', emoji: '‚ú®', color: 'bg-[#1e1b4b] text-indigo-200 border-indigo-900 ring-indigo-900' }, 
                { id: 'seafood', label: 'Êµ∑ÈÆÆÊé°Ë≥º', emoji: 'ü¶Ä', color: 'bg-[#7f1d1d] text-red-200 border-red-900 ring-red-900' },
                { id: 'finance', label: 'Áï´ÂªäÁáüÊî∂', emoji: 'üíé', color: 'bg-[#422006] text-amber-200 border-amber-900 ring-amber-900' },
                { id: 'lemuria', label: 'Âà©Ëé´Èáå‰∫û', emoji: 'üèõÔ∏è', color: 'bg-[#134e4a] text-teal-100 border-teal-900 ring-teal-900' },
            ];
            const RAFAYEL_QUOTES = {
                default: ["ÂóØÔΩûÔºüÊàëÂú®ËÅΩ„ÄÇÁï´ÂÆåÈÄôÁ≠ÜÂ∞±ÂéªÈô™‰Ω†„ÄÇ", "‰øùÈë£Â∞èÂßêÔºå‰ªäÂ§©ÊúâÊ≤íÊúâÊÉ≥ÊàëÔºü", "ÈÅé‰æÜÔºåËÆìÊàëÁúãÁúã‰Ω†ÁöÑË°åÁ®ãË°®...ËÉΩ‰∏çËÉΩÊääÈÄôË£°Á©∫Âá∫‰æÜÔºåÁïôÁµ¶ÊàëÔºü", "Á¥Ø‰∫ÜÂóéÔºüËÇ©ËÜÄÂÄü‰Ω†Èù†ÔºåÊÉ≥Èù†Â§ö‰πÖÈÉΩÂèØ‰ª•„ÄÇ", "Âè™Ë¶ÅÁúãËëó‰Ω†ÔºåÊàëÂ∞±Ë¶∫ÂæóÈùàÊÑüÊ∫êÊ∫ê‰∏çÁµïÂë¢„ÄÇ", "‰ªäÂ§©‰πüËæõËã¶‰∫ÜÔºåÊàëÁöÑÂ∞è‰øùÈë£ÁúüÊ£í„ÄÇ", "‰Ω†Ë™çÁúüÁöÑÊ®£Â≠êÂ•ΩËø∑‰∫∫...‰ΩÜÊàëÊõ¥ÂñúÊ≠°‰Ω†Â∞çÊàëÁ¨ëÁöÑÊ®£Â≠ê„ÄÇ"],
                completed: ["ÊàëÁöÑ‰øùÈë£Â∞èÂßêÁúüËÉΩÂππÔΩûÈÄÅ‰Ω†‰∏ÄÂÄãÈ£õÂêªü´∞üèª", "ÂÅöÂÆå‰∫ÜÔºüÈÇ£Â∞±Âà•ÁõØËëóÊ∏ÖÂñÆÁúã‰∫ÜÔºåÁúãÊàëÔºåÊàëÊØîËºÉÂ•ΩÁúã„ÄÇ", "ËæõËã¶‰∫ÜÔºåÈÅé‰æÜÔºåÊú¨Êµ∑Á•ûÁµ¶‰Ω†‰∏ÄÈªûÁâπÂà•ÁöÑÁçéÂãµ...‰∏ÄÂÄãÂ§ßÂ§ßÁöÑÊìÅÊä±ÔºÅ", "‰ªªÂãôÂÆåÊàêÔºüÂ•ΩÔºåÁèæÂú®ÈñãÂßãÊòØÊàëÂÄëÁöÑÂ∞àÂ±¨ÊôÇÈñì„ÄÇ"]
            };
            const SHELL_LEVELS = [ { value: 1, label: 'Èö®ÊâãÂ°óÈ¥â', iconCount: 1 }, { value: 2, label: 'ÊúâÈªûÈùàÊÑü‰∫ÜÔºÅ', iconCount: 2 }, { value: 3, label: 'Áï´Á≠ÜÂæàÈ†ÜÊâãÔΩû', iconCount: 3 }, { value: 4, label: 'Â†™Á®±ÂÆåÁæéÔºÅ', iconCount: 4 }, { value: 5, label: 'ÂèØ‰ª•ÈñãÁï´Â±ï‰∫ÜÔºÅ', iconCount: 5 } ];

            const completedTasks = useMemo(() => tasks.filter(t => t.completed), [tasks]);
            const incompleteTasks = useMemo(() => tasks.filter(t => !t.completed), [tasks]);
            const totalShellsConsumed = useMemo(() => completedTasks.reduce((sum, t) => sum + (Number(t.shells) || Number(t.paints) || 0), 0), [completedTasks]);
            const titleIndex = Math.min(Math.floor(totalShellsConsumed / 100), TITLES.length - 1);
            const currentTitle = TITLES[titleIndex];

            // Logic (Modified for Firebase)
            useEffect(() => {
                const unsubscribeTasks = FirebaseService.subscribeTasks('todo_tasks', (loadedTasks) => {
                    setTasks(loadedTasks);
                    setLoading(false);
                });
                
                const unsubscribeProfile = FirebaseService.subscribeProfile((profile) => {
                    if(profile.chatUserAvatar) setAvatar(profile.chatUserAvatar);
                    if(profile.chatRafAvatar) setChatRafAvatar(profile.chatRafAvatar);
                });

                return () => {
                    unsubscribeTasks();
                    unsubscribeProfile();
                };
            }, []);

            useEffect(() => {
                if (loading) return;
                if (prevTitleIndexRef.current === -1) { prevTitleIndexRef.current = titleIndex; return; }
                if (titleIndex > prevTitleIndexRef.current) { setIsCelebrationOpen(true); prevTitleIndexRef.current = titleIndex; } 
                else if (titleIndex < prevTitleIndexRef.current) { prevTitleIndexRef.current = titleIndex; }
            }, [titleIndex, loading]);

            useEffect(() => { if (isCelebrationOpen) { setCanCloseCelebration(false); const t = setTimeout(() => setCanCloseCelebration(true), 1500); return () => clearTimeout(t); } }, [isCelebrationOpen]);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages, isChatOpen]);

            const getRandomQuote = (cat) => {
                const quotes = RAFAYEL_QUOTES[cat] || RAFAYEL_QUOTES.default;
                let available = quotes.filter(q => !quoteHistory.current.includes(q));
                if (available.length === 0) { available = quotes; quoteHistory.current = []; }
                const q = available[Math.floor(Math.random() * available.length)];
                quoteHistory.current = [...quoteHistory.current, q].slice(-5);
                return q;
            };
            const triggerRafayelPopup = (zoneId, isComp=false) => {
                const text = isComp ? getRandomQuote('completed') : getRandomQuote(zoneId);
                setRafayelPopup({ show: true, text });
                setChatMessages(prev => [...prev, { id: Date.now(), sender: 'rafayel', text }]);
                setTimeout(() => setRafayelPopup(prev => ({ ...prev, show: false })), 6000);
            };

            const callGeminiAI = async (userText) => {
                const cleanHistory = chatMessages.filter(m => !m.text.includes("ÈÄöË®äÂ§±Êïó") && !m.text.includes("Ê¨äÈôê‰∏çË∂≥") && m.id !== 'init');
                try {
                    const API_URL = `https://generativelanguage.googleapis.com/${MODEL_VERSION}/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                    const payload = {
                        system_instruction: { parts: [{ text: RAFAYEL_SYSTEM_PROMPT }] },
                        contents: [...cleanHistory.map(m => ({ role: m.sender === 'user' ? 'user' : 'model', parts: [{ text: m.text }] })), { role: "user", parts: [{ text: userText }] }]
                    };
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Google ÊãíÁµïÈÄ£Á∑ö (${response.status})`);
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        let aiText = data.candidates[0].content.parts[0].text;
                        aiText = aiText.replace(/\*+/g, '');
                        setChatMessages(prev => [...prev, { id: Date.now() + 1, sender: 'rafayel', text: aiText }]);
                    }
                } catch (error) {
                    setChatMessages(prev => [...prev, { id: Date.now() + 1, sender: 'rafayel', text: `(ÈÄöË®äÂ§±ÊïóÔºö${error.message})` }]);
                } finally { setIsAiTyping(false); }
            };

            const handleChatSend = () => {
                if(!inputMessage.trim()) return;
                const msg = inputMessage; 
                setChatMessages(p => [...p, { id: Date.now(), sender: 'user', text: msg }]); 
                setInputMessage(''); // Clear input synchronously
                
                if (apiKey) { setIsAiTyping(true); callGeminiAI(msg); }
                else {
                    setTimeout(() => {
                        let response = getRandomQuote('default');
                        const lowerInput = msg.toLowerCase();
                        if (lowerInput.includes('ÊÑõ') || lowerInput.includes('ÂñúÊ≠°')) response = "ÂóØ...Êàë‰πüÂæàÊÑõ‰Ω†„ÄÇ";
                        setChatMessages(p => [...p, { id: Date.now()+1, sender: 'rafayel', text: response }]);
                    }, 1000);
                }
            };

            const handleApiKeyChange = (e) => { const k = e.target.value.trim(); setApiKey(k); localStorage.setItem('gemini_api_key', k); };
            
            // Handlers from new code
            const handleAvatarClick = () => fileInputRef.current?.click();
            const onFileChange = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=()=> {setRawImage(r.result); setIsCropModalOpen(true); setImageLoaded(false)}; r.readAsDataURL(f); e.target.value=''; } };
            
            const handleCropSave = async () => {
                const canvas = document.createElement('canvas'); const img = cropImgRef.current;
                if (!img || !imageLoaded) return;
                const ctx = canvas.getContext('2d'); const size = 300; canvas.width = size; canvas.height = size;
                const minDim = Math.min(img.naturalWidth, img.naturalHeight);
                ctx.drawImage(img, (img.naturalWidth-minDim)/2, (img.naturalHeight-minDim)/2, minDim, minDim, 0, 0, size, size);
                const b64 = canvas.toDataURL('image/jpeg', 0.85);
                setAvatar(b64); localStorage.setItem('chat_user_avatar', b64);
                setIsCropModalOpen(false); setRawImage(null);
                await FirebaseService.updateProfile({ chatUserAvatar: b64 });
            };

            const handleChatAvatarUpload = (e, type) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const result = ev.target.result;
                    if (type === 'user') { setAvatar(result); localStorage.setItem('chat_user_avatar', result); await FirebaseService.updateProfile({ chatUserAvatar: result }); }
                    else { setChatRafAvatar(result); localStorage.setItem('chat_raf_avatar', result); await FirebaseService.updateProfile({ chatRafAvatar: result }); }
                };
                reader.readAsDataURL(file);
            };

            const handleImportCSV = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const text = ev.target.result; const lines = text.split('\n');
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim(); if (!line) continue;
                        const [name, zoneLabel, shellsStr, deadline] = line.split(','); if (!name) continue;
                        const zone = ZONES.find(z => zoneLabel && z.label.includes(zoneLabel.trim()))?.id || 'studio';
                        const shells = Number(shellsStr) || 1;
                        await FirebaseService.addDoc('todo_tasks', { name: name.trim(), zone, shells, paints: shells, deadline: deadline || '', completed: true, archivedFromImport: true });
                    }
                };
                reader.readAsText(file); e.target.value = null;
            };

            const resetForm = () => { setTaskName(''); setDeadline(''); setSelectedZone(null); setSelectedShell(null); setModalStep(1); setIsModalOpen(false); };
            const toLocalYYYYMMDD = (d) => { const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
            const setDateShortcut = (type) => { const d = new Date(); if (type === 'tomorrow') d.setDate(d.getDate() + 1); setDeadline(toLocalYYYYMMDD(d)); };
            
            const handleAddTask = async () => { 
                if (!taskName.trim() || !selectedZone || !selectedShell || !deadline) return; 
                await FirebaseService.addDoc('todo_tasks', { name: taskName, zone: selectedZone, shells: Number(selectedShell), paints: Number(selectedShell), deadline, completed: false });
                triggerRafayelPopup(selectedZone);
                resetForm(); 
            };
            const handleToggleComplete = async (t) => { if (burstingTaskId) return; setBurstingTaskId(t.id); if(!t.completed) triggerRafayelPopup(null, true); setTimeout(async () => { await FirebaseService.updateDoc('todo_tasks', t.id, { completed: !t.completed }); setBurstingTaskId(null); }, 600); };
            const confirmDelete = async () => { if (!taskToDelete) return; setIsDeleting(true); try { await FirebaseService.deleteDoc('todo_tasks', taskToDelete.id); setTaskToDelete(null); setEditingTask(null); } finally { setIsDeleting(false); } };
            const handleSaveEdit = async () => { if (!editingTask || !editName.trim()) return; const ud = { name: editName }; if(editDate) ud.deadline = editDate; await FirebaseService.updateDoc('todo_tasks', editingTask.id, ud); setEditingTask(null); };
            
            const getZoneInfo = (id) => ZONES.find(o => o.id === id) || ZONES[0];
            const formatDate = (ds) => { if(!ds) return ''; const [y, m, d] = ds.split('-'); return `${Number(m)}/${Number(d)}`; };
            const getTitleIcon = (idx) => { if (idx <= 2) return <FishIcon size={16} className="text-purple-400 animate-bounce" />; if (idx <= 5) return <ScallopIcon size={16} className="text-pink-300 animate-pulse" />; return <CrownIcon size={16} className="text-yellow-200 animate-pulse" />; };
            const getModalTitles = (step) => { switch(step) { case 1: return { main: 'Ëº∏ÂÖ•ÈùàÊÑü', sub: 'INSPIRATION' }; case 2: return { main: 'ÈÅ∏ÊìáÂ†¥ÊôØ', sub: 'SCENARIO' }; case 3: return { main: 'Ë≤ùÊÆºË©ï‰º∞', sub: 'ESTIMATION' }; case 4: return { main: 'Á¢∫Ë™çÂßîË®ó', sub: 'CONFIRMATION' }; default: return { main: '', sub: '' }; } };
            const exportCSV = () => { if (completedTasks.length === 0) return; const csv = "\uFEFF‰ªªÂãôÂêçÁ®±,ÂçÄÂüü,Ë≤ùÊÆºÊï∏,Êó•Êúü\n" + completedTasks.map(t => `${t.name},${getZoneInfo(t.zone).label.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '')},${t.shells || t.paints},${t.deadline}`).join("\n"); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `Mo_Art_Studio_Log.csv`; a.click(); };
            const addToGoogleCalendar = () => { if (!editName || !editDate) return; const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(editName)}&dates=${editDate.replace(/-/g,'')}T090000Z/${editDate.replace(/-/g,'')}T100000Z&details=‰æÜËá™Mo Art StudioÁöÑÂßîË®ó`; window.open(url, '_blank'); };

            return (
                <div className="h-full flex flex-col font-sans relative overflow-hidden">
                    {/* Floating Elements (Chat, Archive) */}
                    <div className="absolute bottom-6 left-6 z-40 flex items-end gap-3 pointer-events-auto">
                        {rafayelPopup.show && (
                            <div className="absolute left-16 bottom-16 w-48 bg-purple-900/80 backdrop-blur-md text-white p-3 rounded-2xl rounded-bl-none shadow-lg text-xs font-bold leading-relaxed border border-purple-500/30 animate-in zoom-in-50 fade-in duration-300 pointer-events-none z-50">
                                {rafayelPopup.text}
                                <div className="absolute -bottom-2 left-0 w-0 h-0 border-t-[10px] border-t-purple-900/80 border-r-[10px] border-r-transparent"></div>
                            </div>
                        )}
                        <button onClick={() => setIsChatOpen(true)} className="relative w-14 h-14 bg-gradient-to-br from-indigo-900 to-purple-900 rounded-full border border-purple-500/50 shadow-[0_0_20px_rgba(88,28,135,0.6)] flex items-center justify-center active:scale-95 transition-all group hover:scale-105 cursor-pointer">
                            <div className="absolute inset-0 rounded-full bg-purple-400/20 animate-ping opacity-75"></div>
                            <img src={chatRafAvatar} className="w-full h-full rounded-full object-cover opacity-90 group-hover:opacity-100" />
                        </button>
                    </div>
                    
                    <div className="absolute bottom-6 right-6 z-40 font-sans pointer-events-auto">
                        <button onClick={() => setIsCollectionOpen(true)} className="bg-gradient-to-br from-purple-900 to-black p-4 rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.8)] border border-purple-500/30 flex items-center gap-2 active:scale-90 transition-all group overflow-hidden relative">
                            <div className="absolute inset-0 bg-purple-600 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
                            <span className="text-xl relative z-10 drop-shadow-md text-purple-200"><ShellIcon size={20} /></span>
                            <div className="flex flex-col text-left pr-1 leading-none font-sans relative z-10">
                                <span className="text-[8px] font-black text-purple-300 uppercase tracking-widest mb-0.5">Gallery</span>
                                <span className="text-xs font-black text-white group-hover:text-purple-50 transition-colors">Êî∂Ëóè</span>
                            </div>
                        </button>
                    </div>

                    {/* Header */}
                    <div className="px-6 pt-6 pb-2 flex justify-between items-center z-10 relative shrink-0">
                        <div className="flex flex-col gap-2 flex-1 min-w-0 pr-4 text-left">
                            <div className="flex flex-col">
                                <h1 className="text-[1.2rem] font-black flex items-center gap-2 tracking-tight whitespace-nowrap text-purple-50">
                                    <span className="text-purple-400 filter drop-shadow-[0_0_8px_rgba(192,132,252,0.6)]"><Palette size={24} /></span> 
                                    Mo Art Canvas
                                    <div className="w-1.5 h-1.5 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444] animate-pulse"></div>
                                </h1>
                                <p className="text-[0.8rem] text-slate-300 font-bold leading-relaxed tracking-wide text-shadow-sm">‰øùÈë£Â∞èÂßêÔºå<br />‰ªäÂ§©Ë¶ÅÂéªÂì™Ë£°ÂèñÊùêÔºü</p>
                            </div>
                            <button onClick={() => { if(!deadline) setDateShortcut('tomorrow'); setIsModalOpen(true); }} className="relative bg-gradient-to-r from-[#2e1065]/90 to-[#4c0519]/90 backdrop-blur-md p-3 px-4 rounded-xl border border-purple-500/20 flex items-center justify-between active:scale-95 transition-all shadow-[0_4px_20px_rgba(88,28,135,0.4)] overflow-hidden group hover:border-purple-500/40 w-full max-w-[200px]">
                                <div className="relative z-10 flex items-center gap-2">
                                    <div className="w-6 h-6 rounded bg-purple-900 flex items-center justify-center text-purple-100 border border-purple-400/30 shrink-0 shadow-[0_0_15px_rgba(168,85,247,0.4)]"><Plus size={14} strokeWidth={3} /></div>
                                    <span className="text-purple-50 font-black text-xs tracking-tight whitespace-nowrap uppercase drop-shadow-md group-hover:text-white transition-colors">Êñ∞Â¢ûÈùàÊÑü</span>
                                </div>
                                <div className="relative z-10 text-purple-300 transform group-hover:-translate-y-1 transition-transform duration-500"><FishIcon size={20} /></div>
                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-purple-500/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></div>
                            </button>
                        </div>
                        
                        <div className="flex flex-col items-center gap-3 shrink-0 relative">
                        <div className="relative group" onClick={handleAvatarClick}>
                            <div className="absolute -inset-1.5 bg-gradient-to-tr from-red-600 via-purple-600 to-blue-900 rounded-full opacity-60 blur-sm group-hover:opacity-100 transition-opacity duration-500 animate-pulse"></div>
                            <div className="relative w-24 h-24 rounded-full border-[3px] border-purple-400/30 overflow-hidden bg-black shadow-2xl flex items-center justify-center cursor-pointer active:scale-95 transition-all">
                            {avatar ? <img src={avatar} className="w-full h-full object-cover filter brightness-95 contrast-110" /> : <div className="text-center opacity-40 text-purple-500"><User size={32}/></div>}
                            <div className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity backdrop-blur-[2px]"><Camera size={20} className="text-purple-500"/></div>
                            </div>
                        </div>
                        <div className="flex flex-col items-center gap-1">
                            <div className="relative px-2 py-0.5 bg-black/40 backdrop-blur-md rounded border border-purple-500/30 shadow-lg flex items-center gap-1">
                            {getTitleIcon(titleIndex)}
                            <span className="bg-clip-text text-transparent bg-gradient-to-r from-purple-200 via-pink-200 to-white font-black text-[10px] whitespace-nowrap tracking-wide">{currentTitle}</span>
                            </div>
                            <div className="text-[9px] text-purple-300/90 font-black tracking-[0.2em] uppercase bg-purple-950/30 px-2 py-0.5 rounded border border-purple-500/30 shadow-sm flex items-center gap-1"><ShellIcon size={8} /> Ë≤ùÊÆº {totalShellsConsumed}</div>
                        </div>
                        </div>
                    </div>

                    {/* Filter Bar */}
                    <div className="px-6 mb-2 flex items-center justify-between z-10 relative opacity-70 text-[10px] font-black tracking-[0.3em] uppercase text-white shrink-0">
                        <span>Canvas Tasks</span>
                        <button onClick={() => setSortBy(s => s === 'deadline' ? 'shell' : 'deadline')} className="flex items-center gap-1.5 font-bold bg-white/10 px-3 py-1 rounded hover:bg-white/20 transition-colors text-white"><ArrowUpDown size={10}/> {sortBy === 'deadline' ? 'ÊúüÈôê' : 'Ë≤ùÊÆº'}</button>
                    </div>

                    {/* Task List */}
                    <div className="flex-1 px-4 space-y-3 pb-24 z-10 relative font-sans overflow-y-auto custom-scrollbar">
                        {incompleteTasks.length === 0 ? <div className="text-center py-24 opacity-30 text-purple-300 flex flex-col items-center justify-center gap-4"><ShellIcon size={60} strokeWidth={1} /><span className="text-xs tracking-widest uppercase font-bold">No Inspiration Found</span></div> :
                            incompleteTasks.sort((a,b) => sortBy === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : (a.shells||a.paints) - (b.shells||b.paints)).map(t => {
                            const zone = getZoneInfo(t.zone);
                            const isBursting = burstingTaskId === t.id;
                            const isOverdue = t.deadline && t.deadline < toLocalYYYYMMDD(new Date());
                            return (
                                <div key={t.id} onClick={() => { setEditingTask(t); setEditName(t.name); setEditDate(t.deadline); }} className={`relative bg-gradient-to-br from-[#2e1065]/90 to-[#020617]/90 backdrop-blur-md p-4 rounded-2xl border transition-all cursor-pointer shadow-lg group active:scale-[0.98] overflow-hidden font-sans border-purple-500/10 hover:border-purple-500/30 hover:shadow-[0_0_20px_rgba(168,85,247,0.2)] ${isBursting ? 'burst-effect' : ''}`}>
                                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${zone.color.split(' ')[0]} shadow-[0_0_10px_currentColor]`}></div>
                                    <div className="flex items-start gap-3 pl-2 text-left">
                                        <div className="mt-1 shrink-0 transition-colors relative z-10 text-slate-500 group-hover:text-red-400" onClick={(e) => { e.stopPropagation(); handleToggleComplete(t); }}><Circle size={20} strokeWidth={2.5}/></div>
                                        <div className="flex-1 min-w-0 relative z-10">
                                            <div className="flex gap-2 mb-1 flex-wrap items-center">
                                                <span className={`text-[9px] pl-2 pr-2 py-0.5 rounded font-black shadow-sm ${zone.color} uppercase tracking-wider border border-white/5 flex items-center gap-1`}>{zone.emoji} {zone.label}</span>
                                                <span className="text-[9px] text-slate-400 font-bold flex items-center gap-1"><ShellIcon size={8} className="text-purple-400"/> {t.shells || t.paints}</span>
                                            </div>
                                            <h3 className="text-base font-bold truncate tracking-tight font-sans transition-colors text-slate-100 group-hover:text-white">{t.name}</h3>
                                            <div className="flex items-center gap-1.5 mt-1 text-slate-500 text-[9px] font-bold tracking-wider font-sans uppercase">
                                                <Calendar size={10}/>
                                                <span className={isOverdue ? 'text-red-400 animate-pulse' : ''}>{formatDate(t.deadline)} {isOverdue ? 'OVERDUE' : 'DEADLINE'}</span>
                                            </div>
                                        </div>
                                        <div className="p-2 text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity relative z-10"><Edit3 size={14}/></div>
                                    </div>
                                    <div className="absolute right-0 bottom-0 p-2 opacity-5 pointer-events-none text-purple-500 rotate-12"><FishIcon size={80} /></div>
                                </div>
                            )
                            })
                        }
                    </div>

                    {/* Modals & Overlays */}
                    <input type="file" ref={fileInputRef} onChange={onFileChange} className="hidden" accept="image/*"/>
                    <input type="file" ref={fileImportRef} onChange={handleImportCSV} className="hidden" accept=".csv" />
                    
                    {/* Chat Window */}
                    {isChatOpen && appFrame && createPortal(
                    <div className="absolute inset-0 z-[200] flex flex-col bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
                        <div className="flex-1 w-full max-w-md mx-auto bg-[#0f172a] h-full shadow-2xl flex flex-col relative overflow-hidden font-sans">
                            {/* Header with shrink-0 */}
                            <div className="px-4 py-4 bg-[#1e1b4b]/90 backdrop-blur-md border-b border-purple-900/50 flex items-center justify-between z-10 shrink-0">
                                <div className="flex items-center gap-3">
                                <button onClick={() => setIsChatOpen(false)} className="p-1 text-slate-400 hover:text-white"><ChevronLeft size={24}/></button>
                                <div className="relative">
                                    <img src={chatRafAvatar} className="w-10 h-10 rounded-full border border-purple-500/30 object-cover" />
                                    <div className="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-[#1e1b4b]"></div>
                                </div>
                                <div>
                                    <h3 className="font-bold text-white text-base leading-none">Á•ÅÁÖú Rafayel</h3>
                                    <span className="text-[10px] text-purple-400 font-bold tracking-wider">{apiKey ? 'Evol Active' : 'Offline'}</span>
                                </div>
                                </div>
                                <button onClick={() => setChatSettingsOpen(!chatSettingsOpen)} className="p-2 text-slate-400 hover:text-white bg-white/5 rounded-full"><Settings size={18}/></button>
                            </div>
                            
                            {/* Chat Settings */}
                            {chatSettingsOpen && (
                                <div className="absolute top-20 left-4 right-4 bg-[#1e1b4b] border border-purple-800 rounded-xl p-4 z-20 shadow-xl animate-in slide-in-from-top-5 duration-200">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Chat Settings</h4>
                                    <div className="flex gap-4 mb-4">
                                        <div className="flex-1 flex flex-col items-center gap-2">
                                            <span className="text-[10px] text-slate-500">YOU</span>
                                            <div className="w-16 h-16 rounded-full bg-black border border-slate-700 overflow-hidden relative group">
                                                <img src={avatar} className="w-full h-full object-cover" />
                                                <input type="file" onChange={(e) => handleChatAvatarUpload(e, 'user')} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                            </div>
                                        </div>
                                        <div className="flex-1 flex flex-col items-center gap-2">
                                            <span className="text-[10px] text-purple-500">RAFAYEL</span>
                                            <div className="w-16 h-16 rounded-full bg-black border border-slate-700 overflow-hidden relative group">
                                                <img src={chatRafAvatar} className="w-full h-full object-cover" />
                                                <input type="file" onChange={(e) => handleChatAvatarUpload(e, 'raf')} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="border-t border-white/10 pt-4">
                                        <label className="text-[10px] text-purple-400 font-bold uppercase tracking-wider block mb-2 flex items-center gap-2"><Key size={12}/> Gemini API Key</label>
                                        <input type="password" value={apiKey} onChange={handleApiKeyChange} placeholder="Paste API Key here..." className="w-full bg-black/30 border border-purple-500/30 rounded p-2 text-xs text-white focus:border-purple-500 outline-none" />
                                    </div>
                                </div>
                            )}

                            {/* Messages with min-h-0 */}
                            <div className="flex-1 min-h-0 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-[#0f0a20] to-[#1e1b4b] relative chat-scroll">
                                {chatMessages.map((msg) => (
                                    <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} msg-enter items-end gap-2`}>
                                        {msg.sender === 'rafayel' && <img src={chatRafAvatar} className="w-8 h-8 rounded-full border border-purple-500/30 object-cover mb-1" />}
                                        <div className={`max-w-[75%] p-3 rounded-2xl text-sm leading-relaxed font-bold shadow-sm backdrop-blur-sm ${msg.sender === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-white/10 text-slate-200 border border-white/10 rounded-bl-none'}`}>{msg.text}</div>
                                        {msg.sender === 'user' && <img src={avatar} className="w-8 h-8 rounded-full border border-purple-500/30 object-cover mb-1" />}
                                    </div>
                                ))}
                                {isAiTyping && <div className="text-[12px] text-purple-400 ml-12 animate-pulse flex items-center gap-1"><Sparkles size={12}/> Rafayel is thinking...</div>}
                                <div ref={chatEndRef} />
                            </div>
                            
                            {/* Input with shrink-0 */}
                            <div className="p-4 bg-[#0f172a] border-t border-white/5 flex gap-2 shrink-0">
                                <input 
                                    type="text" 
                                    value={inputMessage} 
                                    onChange={(e) => setInputMessage(e.target.value)} 
                                    onKeyDown={(e) => {
                                        if (e.nativeEvent.isComposing) return; // Ignore IME composition
                                        if (e.key === 'Enter') {
                                            e.preventDefault(); // Prevent form submission/newline
                                            handleChatSend();
                                        }
                                    }} 
                                    placeholder="ÂÇ≥ÈÄÅË®äÊÅØ..." 
                                    className="flex-1 bg-slate-800/50 border border-slate-700 rounded-full px-4 py-3 text-sm text-white focus:outline-none focus:border-purple-500 placeholder-slate-500" 
                                />
                                <button onClick={handleChatSend} className="p-3 bg-purple-600 text-white rounded-full hover:bg-purple-50 active:scale-95 transition-all"><Send size={18} /></button>
                            </div>
                        </div>
                    </div>,
                    appFrame
                    )}

                    {isCelebrationOpen && (
                        <div onClick={() => { if (canCloseCelebration) setIsCelebrationOpen(false); }} className="fixed inset-0 z-[250] flex flex-col items-center justify-center p-8 text-center font-sans overflow-hidden cursor-pointer" style={{ background: 'radial-gradient(circle at center, #312e81 0%, #000000 80%)' }}>
                        <FireworksDisplay />
                        <div className="relative z-10" style={{ animation: 'smooth-reveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards' }}>
                            <h2 className="text-4xl font-black text-white mb-4 leading-tight drop-shadow-[0_0_25px_rgba(168,85,247,0.8)]">ÂÅöÂæóÂ•ΩÔºå<br/>‰øùÈë£Â∞èÂßêÔºÅ</h2>
                            <p className="text-xl text-purple-200 font-bold tracking-[0.2em] mb-8 uppercase animate-pulse">ÊÅ≠Âñú‰Ω†ÊàêÁÇ∫</p>
                            <div className="relative flex flex-col items-center justify-center border border-purple-500/40 py-10 px-12 rounded-[2rem] bg-slate-900/80 backdrop-blur-xl shadow-[0_0_40px_rgba(168,85,247,0.3)]">
                                <div className="mb-4 transform hover:scale-110 transition-transform duration-500">{getTitleIcon(titleIndex)}</div>
                                <p className="text-2xl whitespace-nowrap text-purple-100 font-black tracking-widest uppercase filter drop-shadow-lg">{currentTitle}</p>
                            </div>
                            <div className="h-16 flex items-center justify-center mt-12 flex-col gap-2"><p className="text-sm text-slate-500 font-bold tracking-[0.3em] text-center uppercase animate-in slide-in-from-bottom-5 duration-1000 delay-300">FROM RAFAYEL</p></div>
                        </div>
                        </div>
                    )}

                    {isCollectionOpen && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/90 backdrop-blur-md font-sans text-left p-0">
                            <div className="absolute inset-0" onClick={() => setIsCollectionOpen(false)}></div>
                            <div className="w-full h-[85vh] bg-[#0c0a1a] rounded-t-[2rem] shadow-2xl flex flex-col animate-in slide-in-from-bottom-20 duration-500 border-t border-purple-900/30 overflow-hidden font-sans relative z-10">
                                <div className="p-6 border-b border-purple-900/30 bg-[#0c0a1a] flex justify-between items-center font-sans z-20 relative">
                                    <div className="min-w-0 text-left font-sans">
                                        <h2 className="text-xl font-black text-white flex items-center gap-2 truncate font-sans uppercase tracking-wider"><span className="text-2xl drop-shadow-[0_0_10px_rgba(239,68,68,0.6)] text-red-400"><ShellIcon size={20}/></span> Gallery</h2>
                                        <p className="text-[10px] text-purple-500 mt-1 font-black tracking-[0.3em] uppercase opacity-80 font-sans">Total Shells: {completedTasks.reduce((sum, t) => sum + (Number(t.shells) || Number(t.paints) || 0), 0)}</p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={exportCSV} className="p-2 bg-slate-800 rounded hover:bg-slate-700 text-slate-300"><Download size={18}/></button>
                                        <button onClick={() => fileImportRef.current.click()} className="p-2 bg-slate-800 rounded hover:bg-slate-700 text-slate-300"><Upload size={18}/></button>
                                        <button onClick={() => setIsCollectionOpen(false)} className="p-2 bg-purple-900/20 border border-purple-900/50 rounded text-purple-500"><X size={18} /></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-black/50 font-sans text-left relative">
                                    {completedTasks.length === 0 ? <div className="text-center py-20 opacity-20 text-6xl font-sans filter grayscale blur-[1px]">üé®</div> : 
                                        completedTasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(t => (
                                            <div key={t.id} className="bg-slate-900/60 p-4 rounded-lg border border-slate-800 flex items-start gap-3 shadow-sm font-sans relative group hover:border-purple-800/50 transition-colors">
                                                <div className="mt-1 text-purple-500 shrink-0 font-sans drop-shadow-[0_0_5px_rgba(168,85,247,0.5)]"><CheckCircle2 size={18}/></div>
                                                <div className="flex-1 text-left min-w-0 font-sans">
                                                    <h3 className="font-bold text-slate-400 line-through decoration-purple-900 decoration-2 text-sm truncate tracking-tight font-sans pr-8">{t.name}</h3>
                                                    <div className="flex gap-2 mt-1 flex-wrap font-sans">
                                                        <span className={`text-[9px] px-2 py-0.5 rounded border border-current uppercase font-bold tracking-wider ${getZoneInfo(t.zone).color} opacity-60 font-sans flex items-center gap-1`}>{getZoneInfo(t.zone).emoji} {getZoneInfo(t.zone).label}</span>
                                                        <span className="text-[9px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700 font-bold font-sans flex items-center gap-1">{t.shells || t.paints} <ShellIcon size={8}/></span>
                                                    </div>
                                                </div>
                                                <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); setTaskToDelete(t); }} className="absolute right-3 top-3 p-2 text-slate-600 hover:text-red-400 opacity-50 hover:opacity-100 transition-all font-sans cursor-pointer z-20"><Trash2 size={14}/></button>
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        </div>
                    )}

                    {editingTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 font-sans">
                            <div className="absolute inset-0" onClick={() => setEditingTask(null)}></div>
                            <div className="relative w-full max-w-sm bg-[#1e1b4b] border border-purple-800 rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 duration-200">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2 uppercase tracking-wider"><Edit3 size={18} className="text-purple-500"/> ‰øÆÊîπÈùàÊÑü</h3>
                                    <button onClick={() => setEditingTask(null)} className="p-2 bg-white/5 rounded text-slate-400 hover:text-white"><X size={20}/></button>
                                </div>
                                <div className="bg-black/50 rounded-xl p-3 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors">
                                    <label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1 block">ÂÖßÂÆπ</label>
                                    <textarea value={editName} onChange={(e) => setEditName(e.target.value)} rows={3} className="w-full bg-transparent text-sm font-bold text-white placeholder-slate-700 outline-none resize-none leading-relaxed"/>
                                </div>
                                <div className="bg-black/50 rounded-xl p-3 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors">
                                    <label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">ÂÆåÊàêÊó•Êúü (Date)</label>
                                    <input type="date" value={editDate} onChange={(e) => setEditDate(e.target.value)} className="w-full bg-transparent text-white font-bold outline-none [color-scheme:dark]" />
                                </div>
                                <div className="bg-black/50 rounded-xl p-3 mb-4 border border-slate-800 focus-within:border-purple-500/50 transition-colors">
                                    <label className="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">È¨ßÈêò (Alarm)</label>
                                    <input type="time" value={editTime} onChange={(e) => setEditTime(e.target.value)} className="w-full bg-transparent text-white font-bold outline-none [color-scheme:dark]" />
                                </div>
                                
                                <button type="button" onClick={addToGoogleCalendar} className="w-full p-3 mb-4 bg-[#4285F4]/20 border border-[#4285F4]/40 hover:bg-[#4285F4]/30 text-[#8ab4f8] rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 uppercase text-xs tracking-wider"><Calendar size={14} /> Âä†ÂÖ• Google Êó•ÊõÜÊèêÈÜí <ExternalLink size={12} /></button>

                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setTaskToDelete(editingTask)} className="p-3 bg-red-950/20 text-red-400 rounded-xl font-bold active:scale-95 flex-1 flex justify-center hover:bg-red-950/40 border border-transparent hover:border-red-900/50 transition-all cursor-pointer z-10"><Trash2 size={20}/></button>
                                    <button type="button" onClick={handleSaveEdit} className="flex-[3] py-3 bg-purple-700 hover:bg-purple-600 text-white rounded-xl font-black text-sm shadow-[0_0_15px_rgba(168,85,247,0.4)] active:scale-95 flex items-center justify-center gap-2 transition-all"><Save size={18}/> ‰øùÂ≠ò‰øÆÊîπ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-sm p-0 overflow-hidden font-sans">
                            <div className="absolute inset-0" onClick={resetForm}></div>
                            <div className="relative w-full bg-[#0f0a20] border-t border-purple-900/40 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(147,51,234,0.1)] animate-in slide-in-from-bottom-20 duration-500 flex flex-col max-h-[90vh]">
                                <div className="flex items-center justify-between px-8 pt-8 pb-4">
                                    <div className="flex items-center gap-3">
                                        {modalStep > 1 && <button onClick={() => setModalStep(s => s - 1)} className="p-2 bg-white/5 rounded-full hover:bg-white/10"><ChevronLeft size={24}/></button>}
                                        <div className="flex flex-col text-left">
                                            <h2 className="text-xl font-black tracking-widest text-purple-50 leading-none">{getModalTitles(modalStep).main}</h2>
                                            <span className="text-[10px] text-purple-500 font-bold tracking-[0.2em] font-sans mt-1">{getModalTitles(modalStep).sub}</span>
                                        </div>
                                    </div>
                                    <button onClick={resetForm} className="p-2 text-slate-500 hover:text-white transition-colors font-sans text-xl">‚úï</button>
                                </div>
                                <div className="flex-1 overflow-y-auto px-8 pb-16 pt-2 font-sans text-left scrollbar-hide">
                                    {modalStep === 1 && (
                                        <div className="space-y-6 animate-in fade-in slide-in-from-right-10 duration-300 font-sans">
                                            <div className="relative">
                                                <textarea rows={4} placeholder="ÈÄôÊ¨°ÁöÑÈùàÊÑüÊòØ‰ªÄÈ∫ºÔºü" value={taskName} onChange={(e)=>setTaskName(e.target.value)} className="w-full p-6 bg-slate-900/50 border border-slate-800 rounded-xl focus:border-purple-500 focus:outline-none text-xl text-white placeholder:text-slate-600 resize-none font-bold shadow-inner font-sans tracking-wide" autoFocus />
                                                <div className="absolute right-4 bottom-4 text-purple-500/20"><BrushIcon size={20}/></div>
                                            </div>
                                            <button onClick={() => taskName.trim() ? setModalStep(2) : null} className="w-full py-5 bg-slate-100 text-black rounded-xl font-black text-xl shadow-xl active:scale-95 transition-all font-sans flex items-center justify-center gap-2 hover:bg-white">‰∏ã‰∏ÄÊ≠• <ChevronLeft className="rotate-180" size={20}/></button>
                                        </div>
                                    )}
                                    {modalStep === 2 && (
                                        <div className="grid grid-cols-2 gap-3 animate-in fade-in slide-in-from-right-10 duration-300 font-sans">
                                            {ZONES.map(o => (
                                                <button key={o.id} onClick={() => { setSelectedZone(o.id); setModalStep(3); }} className={`p-4 rounded-xl border transition-all flex flex-col items-center justify-center gap-2 aspect-[4/3] shadow-lg relative overflow-hidden group ${selectedZone === o.id ? `bg-gradient-to-br from-purple-900/60 to-black border-purple-500 ring-1 ring-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.4)]` : `bg-gradient-to-br from-[#1e1b4b]/80 to-black/80 border-white/5 opacity-60 hover:opacity-100 hover:border-purple-500/30`}`}>
                                                    <span className="text-4xl filter drop-shadow-lg relative z-10 mb-1">{o.emoji}</span>
                                                    <span className="text-xs font-black tracking-tight relative z-10 text-slate-300">{o.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    {modalStep === 3 && (
                                        <div className="space-y-4 animate-in fade-in slide-in-from-right-10 duration-300 font-sans">
                                            {SHELL_LEVELS.map(l => (
                                                <button key={l.value} onClick={() => { setSelectedShell(l.value); setModalStep(4); }} className={`w-full p-5 rounded-xl border transition-all flex items-center justify-between group ${selectedShell === l.value ? 'bg-gradient-to-r from-red-900/60 to-black border-red-500 text-red-100 shadow-[0_0_15px_rgba(239,68,68,0.3)]' : 'bg-slate-900/40 border-slate-800 text-slate-500 hover:bg-slate-900 hover:text-slate-300 hover:border-red-500/20'} font-sans`}>
                                                    <span className="text-sm font-black whitespace-nowrap font-sans tracking-wider">{l.label}</span>
                                                    <div className="flex gap-1">{[...Array(l.iconCount)].map((_, i) => <ShellIcon key={i} size={14} className="text-red-400" />)}</div>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    {modalStep === 4 && (
                                        <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-8 animate-in fade-in slide-in-from-right-10 duration-300 text-center font-sans">
                                            <div className="w-20 h-20 bg-purple-500/10 rounded-full flex items-center justify-center border border-purple-500/30 text-purple-500 shadow-[0_0_30px_rgba(168,85,247,0.2)] animate-pulse"><ShellIcon size={40} className="animate-pulse" /></div>
                                            <p className="text-2xl font-black text-white leading-tight tracking-tight font-sans">Ë™™Â•Ω‰∫ÜÔºÅË¶ÅÂíåÊàë‰∏ÄËµ∑<br/><span className="text-purple-400 text-lg">Âú®Êà™Á®øÂâçÂÆåÊàêÂñîÔºÅ</span></p>
                                            <div className="w-full flex justify-center px-4 font-sans">
                                                <input type="date" value={deadline} onChange={(e)=>setDeadline(e.target.value)} className="w-full max-w-[240px] p-4 bg-slate-900 border border-slate-700 rounded-xl text-xl font-black text-center text-white [color-scheme:dark] outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 block font-sans uppercase tracking-widest" />
                                            </div>
                                            <button onClick={handleAddTask} className="w-full max-w-[320px] py-5 bg-gradient-to-r from-purple-700 to-red-700 hover:from-purple-600 hover:to-red-600 text-white rounded-xl font-black text-xl shadow-[0_0_20px_rgba(168,85,247,0.4)] active:scale-95 flex items-center justify-center gap-3 font-sans transition-all uppercase tracking-widest">Á¢∫Ë™çÂßîË®ó <CheckCircle2 size={20} className="animate-pulse"/></button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {isCropModalOpen && rawImage && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-lg p-6 font-sans">
                        <div className="w-full max-w-sm bg-[#1e1b4b] border border-purple-800 rounded-2xl p-8 flex flex-col items-center animate-in zoom-in-95 duration-300 shadow-2xl">
                            <h3 className="text-lg font-black text-white mb-6 uppercase tracking-widest text-purple-500">Update Profile</h3>
                            <div className="relative w-64 h-64 rounded-full border-2 border-purple-700 overflow-hidden shadow-2xl mb-8 font-sans group">
                            <img ref={cropImgRef} src={rawImage} className="w-full h-full object-cover font-sans opacity-80 group-hover:opacity-100 transition-opacity" onLoad={() => setImageLoaded(true)} />
                            <div className="absolute inset-0 pointer-events-none ring-[60px] ring-black/80 rounded-full font-sans"></div>
                            </div>
                            <div className="flex gap-4 w-full font-sans">
                                <button onClick={() => setIsCropModalOpen(false)} className="flex-1 py-4 bg-slate-900 border border-slate-800 rounded-lg font-bold text-slate-400 font-sans hover:bg-slate-800">CANCEL</button>
                                <button onClick={handleCropSave} disabled={!imageLoaded} className={`flex-2 py-4 rounded-lg font-black flex items-center justify-center gap-2 px-8 active:scale-95 font-sans transition-all ${imageLoaded ? 'bg-purple-700 text-white hover:bg-purple-600' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}>CONFIRM</button>
                            </div>
                        </div>
                        </div>
                    )}
                    
                    {taskToDelete && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-md p-8 font-sans">
                            <div className="w-full max-w-sm bg-[#0f172a] border border-red-900/50 rounded-2xl p-10 text-center animate-in zoom-in-95 duration-300 shadow-[0_0_50px_rgba(220,38,38,0.2)] font-sans relative overflow-hidden">
                                <div className="w-16 h-16 bg-red-950/30 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20"><AlertTriangle className="text-red-500" size={32}/></div>
                                <h3 className="text-xl font-black text-white mb-3 tracking-wider uppercase">Destroy Canvas?</h3>
                                <p className="text-slate-400 text-sm mb-10 leading-relaxed font-bold font-sans">‰∏çÂñúÊ≠°ÈÄôÂÄãËçâÁ®øÂóéÔºü<br/>ÈÇ£ÊàëË≤ùÊÆºËá™Â∑±ÂêÉÔºÅ</p>
                                <div className="flex flex-col gap-3 font-sans">
                                    <button type="button" onClick={(e) => { e.stopPropagation(); confirmDelete(); }} className="w-full py-4 bg-red-900/30 border border-red-900/50 hover:bg-red-900/50 text-red-500 rounded-lg font-black active:scale-95 text-sm uppercase tracking-[0.2em] transition-all cursor-pointer">Á¢∫Ë™çÊî∂Âõû</button>
                                    <button type="button" onClick={() => setTaskToDelete(null)} className="w-full py-4 bg-slate-800 text-slate-300 rounded-lg font-bold hover:bg-slate-700 transition-all text-sm cursor-pointer disabled:opacity-50">‰øùÁïô</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // Main App Component
        // ==========================================
        const RafayelSuperApp = () => {
            const [activeTab, setActiveTab] = useState('planner'); 

            return (
                <div id="rafayel-app-frame" className="w-full h-screen bg-gradient-to-br from-[#240078] to-[#C4529E] flex justify-center items-center font-sans overflow-hidden text-slate-200 selection:bg-purple-500/30 relative">
                    {/* Background Effects */}
                    <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
                        {[...Array(15)].map((_, i) => (
                        <div key={`b-${i}`} className="bubble-bg" style={{ left: `${Math.random()*100}%`, animationDuration: `${Math.random()*10+10}s`, animationDelay: `${Math.random()*5}s` }}>
                            <div className="rounded-full border border-purple-400/30 bg-purple-500/10" style={{width: Math.random()*20+10, height: Math.random()*20+10}}></div>
                        </div>
                        ))}
                        {[...Array(25)].map((_, i) => (
                        <div key={`e-${i}`} className="ember-bg" style={{ left: `${Math.random()*100}%`, top: `${Math.random()*100 + 20}%`, animationDuration: `${Math.random()*4+2}s`, animationDelay: `${Math.random()*2}s`, width: Math.random() * 4 + 2, height: Math.random() * 4 + 2, borderRadius: '50%', background: '#fb7185', boxShadow: '0 0 10px #f43f5e' }} />
                        ))}
                    </div>

                    <div className="relative z-10 w-full max-w-md h-full sm:h-[95vh] sm:rounded-[2.5rem] bg-[#0f172a]/40 backdrop-blur-2xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)] flex flex-col overflow-hidden ring-1 ring-white/5 font-sans">
                        {/* Tab Bar */}
                        <div className="h-12 flex items-center bg-black/40 border-b border-white/5 px-2 gap-2 pt-2 shrink-0 z-50 backdrop-blur-md">
                            <button 
                                onClick={() => setActiveTab('planner')} 
                                className={`flex-1 h-full rounded-t-xl flex items-center justify-center gap-2 text-xs font-black tracking-widest transition-all relative ${activeTab === 'planner' ? 'bg-[#2e1065]/60 text-white' : 'bg-transparent text-white/40 hover:text-white/70 hover:bg-white/5'}`}
                            >
                                <Layout size={14} /> Ë°å‰∫ãÊõÜ <span className="hidden sm:inline">PLANNER</span>
                                {activeTab === 'planner' && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-purple-500 shadow-[0_0_10px_#a855f7]"></div>}
                            </button>
                            <button 
                                onClick={() => setActiveTab('todo')} 
                                className={`flex-1 h-full rounded-t-xl flex items-center justify-center gap-2 text-xs font-black tracking-widest transition-all relative ${activeTab === 'todo' ? 'bg-[#2e1065]/60 text-white' : 'bg-transparent text-white/40 hover:text-white/70 hover:bg-white/5'}`}
                            >
                                <ListTodo size={14} /> ÈùàÊÑüÈõÜ <span className="hidden sm:inline">CANVAS</span>
                                {activeTab === 'todo' && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-purple-500 shadow-[0_0_10px_#a855f7]"></div>}
                            </button>
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 overflow-hidden relative">
                            <div className={`absolute inset-0 transition-opacity duration-300 ${activeTab === 'planner' ? 'opacity-100 z-10 pointer-events-auto' : 'opacity-0 z-0 pointer-events-none'}`}>
                                <RafayelPlannerTab />
                            </div>
                            <div className={`absolute inset-0 transition-opacity duration-300 ${activeTab === 'todo' ? 'opacity-100 z-10 pointer-events-auto' : 'opacity-0 z-0 pointer-events-none'}`}>
                                <RafayelTodoTab />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RafayelSuperApp />);
    </script>
</body>
</html>
